"use strict";(self.webpackChunksubstack=self.webpackChunksubstack||[]).push([["255"],{64473:function(e,t,n){n.d(t,{Z:()=>i});let i={iframe:"iframe-_GPXZ7",codeInput:"codeInput-elXe0s"}},8108:function(e,t,n){n.d(t,{Z:()=>i});let i={dropdownMenu:"dropdownMenu-ASlbF5",textInput:"textInput-kYr7wC"}},68139:function(e,t,n){n.d(t,{Z:()=>i});let i={wrapper:"wrapper-vT80lr"}},85131:function(e,t,n){n.d(t,{Z:()=>i});let i={gifPreview:"gifPreview-aspqQH",visible:"visible-LWauZo",image:"image-Aqe6vn",videoPlayerWrapper:"videoPlayerWrapper-cIRA2m",videoPlayerClassName:"videoPlayerClassName-wHpwKj",videoClassName:"videoClassName-F40TTj"}},68857:function(e,t,n){n.d(t,{Z:()=>i});let i={scrollBox:"scrollBox-zHkQVP",arrowButtonContainer:"arrowButtonContainer-O4uSiH",visible:"visible-JMTC0j",right:"right-i3oWGi",left:"left-Tg8vqp",arrowButtonOffsetContainer:"arrowButtonOffsetContainer-VMYLE4",arrowButtonOverlaidContainer:"arrowButtonOverlaidContainer-t10AyH",overlay:"overlay-zrMCxn",primary:"primary-lv_sOW",secondary:"secondary-pOosZC",arrowButtonOverlaid:"arrowButtonOverlaid-xLyA_z"}},61649:function(e,t,n){n.d(t,{AO:()=>k,AT:()=>g,BY:()=>I,MZ:()=>S,Sr:()=>T,Zl:()=>b,ar:()=>C,eD:()=>_,l7:()=>N,ss:()=>w});var i=n(7409),r=n(16584),l=n(6400),o=n(30396),a=n(74691),s=n.n(a),c=n(7654),d=n.n(c),u=n(14293),h=n.n(u),p=n(5463),v=n(32224),m=n(36671),f=n(68833),Z=n(15771),y=n(19081);let g=5,C=300,_=600,b=60,w=30,k=e=>{let t=s()(e,1,16),n=_-b;return s()(_-(t-1)/15*n,b,_)},S=e=>{for(let t=16;t>=1;t--)if(k(t)>=2*e)return s()(t,1,16);return 1},x=(0,l.createContext)({clipTimes:null,isClipping:!1,setClipEnd:()=>void 0,setClipStart:()=>void 0,setClipTitle:()=>void 0,virtualizedListRef:{current:null},onCancelClipping:()=>void 0,onStartClipping:()=>void 0,clipTitle:null,zoom:0,setZoom:()=>void 0}),I=e=>{let{children:t,postId:n,videoPlayerRef:l,virtualizedListRef:a}=e,[c,u]=(0,o.eJ)(!1),[p,v]=(0,o.eJ)(),[m,Z]=(0,o.eJ)(),[y,_]=(0,o.eJ)(null),[b,k]=(0,o.eJ)(1),I=(0,o.sO)(!1),T=(0,o.Ye)(()=>h()(p)||h()(m)?null:{start:p,end:m},[m,p]);(0,o.d4)(()=>{I.current||void 0==p||void 0==m||(k(S(m-p)),I.current=!0)},[p,m]);let N=(0,o.I4)(e=>{var t,r,o,a,c,p,m,y,b;let{start:k,end:S,source:x,title:I}=e,T=null!==(m=null==l?void 0:null===(r=l.current)||void 0===r?void 0:null===(t=r.player)||void 0===t?void 0:t.duration)&&void 0!==m?m:300;d()(T)&&(T=300);let N=h()(k)||h()(S)?null:{start:k,end:Math.min(S,k+C)},O=null!=N?N:{start:Math.max(0,null!==(y=null==l?void 0:null===(a=l.current)||void 0===a?void 0:null===(o=a.player)||void 0===o?void 0:o.currentTime)&&void 0!==y?y:0),end:Math.min(null!=T?T:g,(null!==(b=null==l?void 0:null===(p=l.current)||void 0===p?void 0:null===(c=p.player)||void 0===c?void 0:c.currentTime)&&void 0!==b?b:0)+w)};if(N?O.end=Math.max(O.start+g,O.end):(O.start=s()(O.start,0,T-g),O.end=s()(O.end,O.start+g,Math.min(O.start+C,T))),v(O.start),Z(O.end),u(!0),I&&_(I),(0,f.j)(f.FP.VIDEO_CLIP_INITIATED,(0,i._)({post_id:n,source:x},N)),!N&&!(null==l?void 0:l.current)){let e=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;setTimeout(()=>{var n,i;(null==l?void 0:null===(i=l.current)||void 0===i?void 0:null===(n=i.player)||void 0===n?void 0:n.readyState)!==4?t<10&&e(t+1):(v(0),Z(Math.min(l.current.player.duration,w)))},100)};e()}},[n,l]),O=(0,o.I4)(e=>{var t,n,i;let r=null!==(i=null==l?void 0:null===(n=l.current)||void 0===n?void 0:null===(t=n.player)||void 0===t?void 0:t.duration)&&void 0!==i?i:0,o=s()(e,g,r);Z(o),v(e=>s()(null!=e?e:0,Math.max(o-C,0),o-g))},[l]),B=(0,o.I4)(e=>{var t,n,i;let r=null!==(i=null==l?void 0:null===(n=l.current)||void 0===n?void 0:null===(t=n.player)||void 0===t?void 0:t.duration)&&void 0!==i?i:0,o=s()(e,0,r-g);v(o),Z(e=>s()(null!=e?e:0,o+g,Math.min(o+C,r)))},[l]),E=(0,o.I4)(()=>{u(!1)},[]);return(0,r.tZ)(x.Provider,{value:{clipTimes:T,isClipping:c,setClipEnd:O,setClipStart:B,setClipTitle:_,virtualizedListRef:a,onCancelClipping:E,onStartClipping:N,clipTitle:y,zoom:b,setZoom:k},children:t})},T=()=>(0,o.qp)(x),N=()=>{let{zoom:e,setZoom:t}=T();return(0,r.BX)(y.gq,{gap:12,justifyContent:"center",alignItems:"center",children:[(0,r.tZ)(Z.hU,{priority:"secondary-outline",size:"sm",onClick:()=>t(Math.max(1,e-1)),children:(0,r.tZ)(p.Z,{size:20})}),(0,r.tZ)(m.Z,{min:1,max:16,step:1,value:e,onChange:t}),(0,r.tZ)(Z.hU,{priority:"secondary-outline",size:"sm",onClick:()=>t(Math.min(16,e+1)),children:(0,r.tZ)(v.Z,{size:20})})]})}},77228:function(e,t,n){n.d(t,{V:()=>w,A:()=>S});var i=n(7409),r=n(99282),l=n(98848),o=n(16584),a=n(75697),s=n(71094),c=n(95441),d=n(77906),u=n(72572),h=n(98170),p=n(60225),v=n(30396),m=n(68833),f=n(59176),Z=n(98914),y=n(47929);let g=e=>{var{isOpen:t,onClose:n,shareUrl:r,post:o,pub:s,profile:c,comments:d,commentId:u,medium:h,utm_campaign:p}=e,g=(0,l._)(e,["isOpen","onClose","shareUrl","post","pub","profile","comments","commentId","medium","utm_campaign"]);let[C,_]=(0,v.eJ)(null);return(0,v.d4)(()=>{t&&(async()=>{let e={title:(0,a.B8)({post:o,pub:s,profile:c}),url:r||(0,a.O1)("direct",(0,i._)({medium:h,post:o,pub:s,profile:c,comments:d,commentId:u,utm_campaign:p},g))};if((0,Z.K1)()&&navigator.share&&navigator.canShare&&navigator.canShare(e))try{return await navigator.share(e),(0,m.j)(m.FP.NATIVE_SHARE_SUCCESS,{medium:h||"web",post_id:o?o.id:null,utm_campaign:C||p||"default"}),(0,f.ex)("".concat(null==s?void 0:s.subdomain," shared"),!0),n(),!0}catch(e){if("AbortError"===e.name)return n(),!0;(0,m.j)(m.FP.NATIVE_SHARE_FAILED,{errorName:e.name,errorMessage:e.message})}return!1})().then(e=>{e||(0,m.j)(m.FP.SHARE_DIALOG_OPENED,{medium:h||"web",post_id:o?o.id:null,utm_campaign:C||p||y.VX.default})})},[t]),{handleClose:()=>{_(null),n()},internalUtmCampaign:C,setInternalUtmCampaign:_}};var C=n(19081),_=n(6490),b=n(63474);let w=e=>{var{isOpen:t,onClose:n,shareUrl:c,post:d,pub:u,profile:h,comments:p,commentId:v,medium:m="web",utm_campaign:f}=e,Z=(0,l._)(e,["isOpen","onClose","shareUrl","post","pub","profile","comments","commentId","medium","utm_campaign"]);let{handleClose:y,internalUtmCampaign:b}=g((0,i._)({isOpen:t,onClose:n,shareUrl:c,post:d,pub:u,profile:h,comments:p,commentId:v,medium:m,utm_campaign:f},Z)),w=p&&v&&p.find(e=>e.id===v),x=w?"comment":u&&!d?"publication":d?"post":h?"profile":void 0;return(0,o.BX)(_.u_,{isOpen:t,onClose:y,children:[(0,o.tZ)(k,{type:x,onClose:y}),(0,o.tZ)(_.fe,{children:(0,o.BX)(C.sg,{gap:20,children:[(0,o.tZ)(S,{type:x,pub:u,post:d,profile:h,comment:w,shareUrl:c}),(0,o.tZ)(s.k,(0,r._)((0,i._)({utm_campaign:null!=b?b:f,medium:m,post:d,pub:u},Z),{shareName:(0,a.B8)({post:d,pub:u,profile:h}),shareUrl:null!=c?c:(0,a.O1)(null,{medium:m,post:d,pub:u,profile:h,comments:p,commentId:v,utm_campaign:f})}))]})})]})};function k(e){let{type:t,onClose:n}=e,{iString:i}=(0,c.M1)();return(0,o.tZ)(_.xB,{title:i(t?"Share this ".concat(t):"Share"),onClose:n,showClose:!0})}let S=e=>{let{type:t,pub:n,post:i,profile:r,comment:l,shareUrl:a}=e;return(0,o.BX)(x,{shareUrl:a,children:["comment"==t&&l&&(0,o.tZ)(d.UK,{comment:l,readOnly:!0}),"post"==t&&i&&n&&(0,o.tZ)(h.tg,{post:i,publication:n,readOnly:!0}),"publication"==t&&n&&(0,o.tZ)(p.U,{publication:n,readOnly:!0}),"profile"==t&&r&&(0,o.tZ)(u.N,{url:a,readOnly:!0,title:r.name,host:"substack.com",image:r.photo_url}),void 0==t&&(0,o.tZ)(u.N,{url:a,readOnly:!0})]})},x=e=>{let{shareUrl:t,children:n}=e,{handleCopyLink:i}=(0,a.Uo)();return(0,o.tZ)(b.A0,{onClick:()=>i({shareUrl:null!=t?t:"#"}),href:null!=t?t:"#",children:n})}},71094:function(e,t,n){n.d(t,{k:()=>x});var i=n(7409),r=n(16584),l=n(25380),o=n(85200),a=n(59154),s=n(79138),c=n(90443),d=n(37632),u=n(18573),h=n(82653),p=n(77559),v=n(82695),m=n(4473),f=n(39535),Z=n(75697),y=n(95441),g=n(68833),C=n(19081),_=n(36500),b=n(31065),w=n(47929);let k={size:20,stroke:"var(--color-fg-primary)"},S={size:64};function x(e){let{iString:t}=(0,y.M1)(),{handleCopyLink:n,justCopied:x}=(0,Z.Uo)();return(0,r.BX)(C.gq,{justifyContent:"space-between",children:[(0,r.tZ)(b.X,(0,i._)({onClick:()=>n((0,i._)({},e)),icon:x?(0,r.tZ)(l.Z,(0,i._)({},k)):(0,r.tZ)(u.Z,(0,i._)({},k)),label:t(x?"Copied":"Copy link")},S)),(0,r.tZ)(b.X,(0,i._)({onClick:()=>(0,Z.Po)((0,i._)({},e)),icon:(0,r.tZ)(s.Z,(0,i._)({},k)),label:t("Facebook")},S)),(0,r.tZ)(b.X,(0,i._)({onClick:()=>(0,Z.WZ)((0,i._)({},e)),icon:(0,r.tZ)(h.Z,(0,i._)({},k)),label:t("Email")},S)),(0,r.tZ)(b.X,(0,i._)({onClick:()=>(0,Z.BZ)((0,i._)({},e)),icon:(0,r.tZ)(m.Z,(0,i._)({},k)),label:t("Notes")},S)),(0,r.BX)(_.v2,{trigger:(0,r.tZ)(b.X,(0,i._)({label:t("More"),icon:(0,r.tZ)(o.Z,(0,i._)({},k))},S)),onOpen:()=>{(0,g.j)(g.FP.SHARE_DIALOG_MORE_OPTION_CLICKED,{medium:e.medium||"web",post_id:e.post?e.post.id:null,utm_campaign:e.utm_campaign||w.VX.default})},children:[(0,r.tZ)(_.sN,{onClick:()=>(0,Z.bI)((0,i._)({},e)),leading:(0,r.tZ)(a.Z,{}),children:t("Bluesky")}),(0,r.tZ)(_.sN,{onClick:()=>(0,Z.Wn)((0,i._)({},e)),leading:(0,r.tZ)(f.Z,{}),children:t("X (Twitter)")}),(0,r.tZ)(_.sN,{onClick:()=>(0,Z.lc)((0,i._)({},e)),leading:(0,r.tZ)(d.Z,{}),children:t("LinkedIn")}),(0,r.tZ)(_.sN,{onClick:()=>(0,Z.sn)((0,i._)({},e)),leading:(0,r.tZ)(v.Z,{}),children:t("Reddit")}),(0,r.tZ)(_.sN,{onClick:()=>(0,Z.Vn)((0,i._)({},e)),leading:(0,r.tZ)(p.Z,{}),children:t("Pinterest")}),(0,r.tZ)(_.sN,{onClick:()=>(0,Z.b6)((0,i._)({},e)),leading:(0,r.tZ)(c.Z,{}),children:t("Hacker News")})]})]})}},26522:function(e,t,n){n.d(t,{Y:()=>f,c:()=>m});var i=n(16584),r=n(94184),l=n.n(r),o=n(19691),a=n(13723),s=n(57336),c=n(20888),d=n(90099),u=n(71068),h=n(19081),p=n(58175),v=n(71075);let m=e=>{var t,n,r;let{disableLinks:d,isEditingCaption:m,post:f,caption:Z,onEditCaption:y,onSaveCaption:g,onCancelCaption:C}=e,{publishedBylines:_,title:b,canonical_url:w,post_date:k,section_name:S,cover_image:x,cover_image_alt:I}=f;return(0,i.BX)(h.tu,{children:[S&&(0,i.tZ)("a",{className:l()({[null!==(t=v.Z.disableLink)&&void 0!==t?t:""]:d}),href:w,rel:"noopener",target:"_blank",children:(0,i.tZ)(p.xv.Meta,{color:"pub-primary-text",paddingBottom:8,children:S})}),(0,i.tZ)("a",{className:l()({[null!==(n=v.Z.disableLink)&&void 0!==n?n:""]:d}),href:w,rel:"noopener",target:"_blank",children:(0,i.tZ)(p.xv.H2,{color:"pub-primary-text",children:b})}),(0,i.tZ)(s.h,{bylines:_,date:k,disableLinks:d}),x&&(0,i.tZ)(u.xu,{paddingTop:24,children:(0,i.tZ)("a",{className:l()({[null!==(r=v.Z.disableLink)&&void 0!==r?r:""]:d}),href:w,rel:"noopener",target:"_blank",children:(0,i.tZ)(c.e,{alt:null!=I?I:b,className:v.Z.fullWidth,imageProps:{height:Math.round(650),smartCrop:!0},maxWidth:1300,src:x})})}),(0,i.tZ)(h.hs,{flex:"grow",paddingTop:16,children:m&&g&&C?(0,i.tZ)(o.Z,{initialCaption:Z,onCancel:C,onSave:g}):(0,i.tZ)("p",{className:v.Z.caption,dangerouslySetInnerHTML:{__html:Z},onClick:y||void 0})}),(0,i.tZ)(a.$,{disableLinks:d,href:w,includeUfi:!1,post:f})]})},f=e=>{let{post:t,children:n}=e,{publishedBylines:r,title:l,canonical_url:o,post_date:h,section_name:m,cover_image:f,cover_image_alt:Z}=t;return(0,i.BX)(d.i$,{children:[m&&(0,i.tZ)("a",{href:o,children:(0,i.tZ)(p.xv.Meta,{color:"pub-primary-text",paddingBottom:8,children:m})}),(0,i.tZ)("a",{href:o,children:(0,i.tZ)(p.xv.H2,{color:"pub-primary-text",children:l})}),(0,i.tZ)(s.I,{bylines:r,date:h}),f&&(0,i.tZ)(u.xu,{paddingTop:24,children:(0,i.tZ)("a",{href:o,children:(0,i.tZ)(c.e,{alt:null!=Z?Z:l,className:v.Z.fullWidth,imageProps:{height:Math.round(650),smartCrop:!0},maxWidth:1300,src:f})})}),(0,i.tZ)("a",{href:o,children:(0,i.tZ)(u.xu,{as:"p",children:n})}),(0,i.tZ)(a.c,{href:o})]})}},24189:function(e,t,n){n.d(t,{Z:()=>s});var i=n(7409),r=n(99282),l=n(98848),o=n(16584),a=n(64515);let s=e=>{var{fill:t}=e,n=(0,l._)(e,["fill"]);return(0,o.tZ)(a.l,(0,r._)((0,i._)({},n),{name:"CheckboxCheckmarkIcon",svgParams:{viewBox:"0 0 16 13",height:16,width:13,fill:t||"white"},children:(0,o.tZ)("path",{d:"M5.71444 12.6276L0 6.9132L1.61147 5.30173L5.71444 9.39327L14.389 0.71875L16.0004 2.34165L5.71444 12.6276Z",stroke:t||"white"})}))}},91379:function(e,t,n){n.d(t,{c:()=>_});var i=n(16584),r=n(30396),l=n(71375),o=n(80569),a=n.n(o),s=n(80878),c=n(15771),d=n(19081),u=n(4615),h=n(58175),p=n(70379),v=n(60308),m=n(84864),f=n(47929),Z=n(33803),y=n(4291),g=n(68139);let C=(e,t,n,r,l)=>{if(!t)return null;switch(e){case"post-login":if(!t.profile_set_up_at)return null;return{title:"Your profile is set up!",body:"Now you can like posts, leave comments, and follow other people on Substack.",ctaText:"View your profile",ctaLink:(0,v.NNq)(t,{utm_source:f.b3.profileToast,noBase:n})};case"post-subscribe-success":if(!r||!t.profile_set_up_at)return null;return{title:"Welcome to ".concat(r?r.name:""),body:(0,i.BX)(h.xv,{children:["You'll now receive new posts in your inbox. Next, check out the"," ",(0,i.tZ)(h.hh,{decoration:"underline",target:"_blank",href:r?(0,v.sai)(r):void 0,children:"archive"})," ","or visit your profile."]}),ctaText:"View your profile",ctaLink:(0,v.NNq)(t,{utm_source:f.b3.profileToast,noBase:n})};case"start-writing":return{title:"Want to start writing on Substack?",body:"Congrats on subscribing to your ".concat((0,m.numberToOrdinal)(l)," Substack! Start your own just 5 minutes"),ctaText:"Start writing",ctaLink:(0,v._HV)({utm_source:f.b3.profileToast})};default:return null}};function _(e){let{user:t,pub:n=null,noBase:o=!1}=e,v=(0,p.pm)();return(0,r.d4)(()=>{async function e(){await a().put("/api/v1/user-setting").send({type:"has_seen_reader_to_writer_upsell",value_bool:!0})}let r=new URL(location.toString()),p=r.searchParams.get("profile-setup-message");if(!p)return;let m="start-writing"===p?Number(r.searchParams.get("nthPub")):void 0;r.searchParams.delete("nthPub"),r.searchParams.delete("profile-setup-message"),history.replaceState({},"",r);let f=C(p,t,o,n,m);f&&("start-writing"===p&&e(),v.popToast(e=>{let{onClose:t}=e;return(0,i.tZ)(u.f6,{theme:n?y.Z.pubTheme:Z.Z.elevatedTheme,children:(0,i.BX)(d.tu,{gap:20,bg:"primary",radius:"md",shadow:"lg",border:"detail",sizing:"border-box",position:"relative",padding:20,className:g.Z.wrapper,children:[(0,i.BX)(d.gq,{flex:"grow",justifyContent:"space-between",alignItems:"start",children:[(0,i.BX)(d.tu,{gap:8,children:[(0,i.tZ)(h.xv.H3,{weight:"heavy",flex:"grow",color:"primary",children:f.title}),(0,i.tZ)(h.xv.B3,{color:"secondary",children:f.body})]}),(0,i.tZ)(c.hU,{priority:"tertiary",onClick:t,children:(0,i.tZ)(l.Z,{size:20})})]}),(0,i.tZ)(c.zx,{priority:"primary",onClick:e=>{(0,s.Q)(e,f.ctaLink,{native:!0}),t()},children:f.ctaText})]})})},{ttl:null}))},[]),null}},93029:function(e,t,n){n.d(t,{Z:()=>d});var i=n(16584),r=n(30396),l=n(94184),o=n.n(l),a=n(74571),s=n(60308),c=n(85131);let d=e=>{let{post:t,containerRef:n,aspectRatio:l,size:d="small",alwaysShow:u=!1,className:h}=e,[p]=(0,a.i5)(n),[v,m]=(0,r.eJ)(!1),f=(0,s.W$Z)({post:t,height:"large"===d?480:320});return f&&(p||u)?(0,i.tZ)("div",{className:o()(c.Z.gifPreview,{[c.Z.visible]:v},h),children:(0,i.tZ)("img",{className:c.Z.image,src:f,style:"aspect-ratio: ".concat(l),onLoad:()=>m(!0)})}):null}},20730:function(e,t,n){n.d(t,{A:()=>d});var i=n(16584),r=n(94184),l=n.n(r),o=n(98661),a=n(80026),s=n(63474);let c={chip:"chip-lJKwY5",textOnly:"textOnly-SPwDNp",leading:"leading-TvXpau",trailing:"trailing-lhDVKn",clickable:"clickable-IxUlBk",fillIcon:"fillIcon-jYnt2U"},d=(0,o.forwardRef)((e,t)=>{let{children:n,trailing:r,leading:o,href:d,onClick:u,fillIcon:h,newTab:p,className:v}=e,m=d||u,f=!o&&!r;return(0,i.BX)(a.kG,{resetCss:!0,ref:t,className:l()(c.chip,h&&c.fillIcon,m&&c.clickable,f&&c.textOnly,v),href:d,onClick:u,pressable:m?"sm":void 0,newTab:p,children:[o&&(0,i.tZ)(s.M5,{className:c.leading,children:o}),(0,i.tZ)(a.xv.B4,{color:"primary",userSelect:"none",ellipsis:!0,children:n}),r&&(0,i.tZ)(s.M5,{className:c.trailing,children:r})]})})},92039:function(e,t,n){n.d(t,{m:()=>m,rG:()=>v,rw:()=>p});var i=n(27412),r=n(7409),l=n(99282),o=n(16584),a=n(98661),s=n(30396),c=n(48980),d=n(12120);class u{async connect(){try{if(!this.host)throw Error("Attempted to connect without a token");this.ws=new WebSocket(this.host),this.ws.addEventListener("open",()=>{for(let[e,t]of this.channels)t.size>0&&this.send({action:"subscribe",channel:e})}),this.ws.addEventListener("error",e=>{console.error(e),"closed"!==this.connectivityState&&(this.error=Error("Generic error"),this.handleError())}),this.ws.addEventListener("close",e=>{"closed"!==this.connectivityState&&(this.error={code:e.code,reason:e.reason,wasClean:e.wasClean},this.handleError())}),this.ws.addEventListener("message",e=>{"open"!==this.connectivityState&&(this.connectivityState="open",clearTimeout(this.timeoutId),this.reconnectInterval=900,this.notifyConnectivityChange());let t=JSON.parse(e.data),n=(0,l._)((0,r._)({},t),{data:t.data?(0,l._)((0,r._)({},t.data),{message:"string"==typeof t.data.message?JSON.parse(t.data.message):null}):null});if(n.data){var i;for(let e of null!==(i=this.channels.get(n.data.channel))&&void 0!==i?i:[])e(n)}}),clearTimeout(this.timeoutId);let e=this.ws;this.timeoutId=setTimeout(()=>{"connecting"===this.connectivityState&&(this.error=Error("Timeout"),e.close(),this.handleError())},3e4)}catch(e){this.error=e instanceof Error?e:Error(String(e)),this.handleError()}}async refreshToken(){let e;this.channels.size>0&&(e=Array.from(this.channels.keys()).join(","));let t=await (0,c.rd)("/api/v1/realtime/token",{query:{channels:e}});return this.token=t.token,this.expiry=t.expiry,this.host=t.endpoint,this.ws||this.connect(),t}send(e){let{ws:t}=this;if(!t)throw Error("Cannot send without a connection.");t.send(JSON.stringify((0,r._)({token:this.token},e)))}publish(e,t){this.send({action:"publish",channel:e,message:JSON.stringify(t)})}listen(e){let t=[],n=new Set(this.channels.keys());return this.subscriptionQueue=this.subscriptionQueue.then(async()=>{for(let[n,i]of Object.entries(e)){let e=this.channels.get(n);e||(e=new Set,this.channels.set(n,e)),e.add(i),t.push(()=>{var e;let t=this.channels.get(n);null==t||t.delete(i),(null==t?void 0:t.size)===0&&(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN&&(this.send({action:"unsubscribe",channel:n}),this.channels.delete(n))})}let i=(0,d.e5)(new Set(this.channels.keys()),n);if(i.size>0){var r;if(await this.refreshToken(),(null===(r=this.ws)||void 0===r?void 0:r.readyState)===WebSocket.OPEN)for(let e of i)this.send({action:"subscribe",channel:e})}}),()=>{let e=new Set(this.channels.keys());for(let e of t)e();(0,d.e5)(e,new Set(this.channels.keys())).size>0&&this.refreshToken()}}onConnectivityChange(e){return this.connectivityHandlers.add(e),()=>{this.connectivityHandlers.delete(e)}}destroy(){var e;this.channels.clear(),this.connectivityHandlers.clear(),this.connectivityState="closed",null===(e=this.ws)||void 0===e||e.close(),clearTimeout(this.reconnectTimeoutId),clearTimeout(this.timeoutId)}notifyConnectivityChange(){for(let e of this.connectivityHandlers)e(this.connectivityState)}handleError(){console.info("ZyncSocket: Connection closed"),clearTimeout(this.timeoutId),"closed"!==this.connectivityState&&(this.connectivityState="closed",this.notifyConnectivityChange()),0===this.reconnectTimeoutId&&(console.info("ZyncSocket: Attempting to reconnect..."),this.reconnectTimeoutId=setTimeout(()=>{this.reconnectTimeoutId=0,this.reconnectInterval=Math.min(2*this.reconnectInterval,6e4),this.connect()},this.reconnectInterval+.2*this.reconnectInterval))}constructor(){(0,i._)(this,"token",void 0),(0,i._)(this,"expiry",void 0),(0,i._)(this,"host",void 0),(0,i._)(this,"ws",void 0),(0,i._)(this,"connectivityState","closed"),(0,i._)(this,"error",void 0),(0,i._)(this,"reconnectInterval",900),(0,i._)(this,"reconnectTimeoutId",0),(0,i._)(this,"channels",new Map),(0,i._)(this,"connectivityHandlers",new Set),(0,i._)(this,"timeoutId",0),(0,i._)(this,"subscriptionQueue",Promise.resolve())}}let h=(0,a.createContext)(null);function p(e){let{children:t}=e,[n,i]=(0,s.eJ)(null);return(0,s.d4)(()=>{null==n||n.destroy();let e=new u;return i(e),()=>{e.destroy()}},[]),(0,o.tZ)(h.Provider,{value:n,children:t})}function v(){return(0,s.qp)(h)}function m(){var e;let t=v(),[n,i]=(0,s.eJ)(null!==(e=null==t?void 0:t.connectivityState)&&void 0!==e?e:"closed");return(0,s.d4)(()=>null==t?void 0:t.onConnectivityChange(i),[t]),n}},97434:function(e,t,n){n.d(t,{B:()=>p,c:()=>h});var i=n(7409),r=n(99282),l=n(98848),o=n(16584),a=n(6400),s=n(30396),c=n(6490),d=n(74312);let u=(0,a.createContext)({open:()=>void 0});function h(e){var t;let{children:n}=e,[l,a]=(0,s.eJ)(null),c=(0,s.Ye)(()=>({open:e=>a(e)}),[]);return(0,o.BX)(u.Provider,{value:c,children:[n,(0,o.tZ)(v,(0,r._)((0,i._)({},l),{source:null!==(t=null==l?void 0:l.source)&&void 0!==t?t:"substack",isOpen:!!l,onClose:()=>a(null)}))]})}function p(){return(0,s.qp)(u)}function v(e){var{isOpen:t,onClose:a}=e,s=(0,l._)(e,["isOpen","onClose"]);return(0,o.tZ)(c.u_,{isOpen:t,onClose:a,children:(0,o.tZ)(d.cr,(0,r._)((0,i._)({},s),{module:"@/frontend/reader2/chat/DmShareModal",onRequest:()=>n.e("2667").then(n.bind(n,84422)),resolve:e=>e.DmComposerModal,onClose:a}))})}},78446:function(e,t,n){n.d(t,{N4:()=>a,sm:()=>s});var i=n(16584),r=n(30396),l=n(15771),o=n(15562);function a(){let[e,t]=(0,r.eJ)(null);return{confirm:()=>new Promise((n,i)=>{e&&i(Error("Already confirming.")),t({resolve:n,reject:i})}),isConfirming:!!e,handleConfirm:n=>{t(null),null==e||e.resolve(n)},handleCancel:n=>{t(null),null==e||e.resolve(n)}}}function s(e){let{title:t,body:n,cancelLabel:r="Cancel",confirmLabel:a="Confirm",modal:s}=e;return(0,i.tZ)(o.W,{isOpen:s.isConfirming,onClose:()=>s.handleCancel(!1),title:t,description:n,primaryButton:(0,i.tZ)(l.zx,{priority:"destructive",onClick:()=>s.handleConfirm(!0),children:a}),secondaryButton:(0,i.tZ)(l.zx,{priority:"secondary",onClick:()=>s.handleCancel(!1),children:r})})}},84923:function(e,t,n){n.d(t,{d:()=>r});var i=n(30396);function r(){let[e,t]=(0,i.eJ)(!1);return{isOpen:e,onOpen:()=>t(!0),onClose:()=>t(!1)}}},12120:function(e,t,n){function i(e,t){let n=new Set(e);return n.add(t),n}function r(e,t){let n=new Set(e);return n.delete(t),n}function l(e,t){return new Set([...e].filter(e=>!t.has(e)))}n.d(t,{e5:()=>l,oR:()=>i,zu:()=>r})}}]);