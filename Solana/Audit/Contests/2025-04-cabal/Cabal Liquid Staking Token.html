<!DOCTYPE html>
<!-- saved from url=(0064)https://code4rena.com/reports/2025-04-cabal-liquid-staking-token -->
<html lang="en" class="__variable_145019 __variable_7d3254 __variable_38ceec dark" style="background: var(--color__bg-l0); --wcm-color-fg-1: rgb(228,231,231); --wcm-color-fg-2: rgb(148,158,158); --wcm-color-fg-3: rgb(110,119,119); --wcm-color-bg-1: rgb(20,20,20); --wcm-color-bg-2: rgb(39,42,42); --wcm-color-bg-3: rgb(59,64,64); --wcm-color-overlay: rgba(255,255,255,0.1); --wcm-accent-color: #3396FF; --wcm-accent-fill-color: #FFFFFF; --wcm-z-index: 89; --wcm-background-color: #3396FF; --wcm-background-border-radius: 8px; --wcm-container-border-radius: 30px; --wcm-wallet-icon-border-radius: 15px; --wcm-wallet-icon-large-border-radius: 30px; --wcm-wallet-icon-small-border-radius: 7px; --wcm-input-border-radius: 28px; --wcm-button-border-radius: 10px; --wcm-notification-border-radius: 36px; --wcm-secondary-button-border-radius: 28px; --wcm-icon-button-border-radius: 50%; --wcm-button-hover-highlight-border-radius: 10px; --wcm-text-big-bold-size: 20px; --wcm-text-big-bold-weight: 600; --wcm-text-big-bold-line-height: 24px; --wcm-text-big-bold-letter-spacing: -0.03em; --wcm-text-big-bold-text-transform: none; --wcm-text-xsmall-bold-size: 10px; --wcm-text-xsmall-bold-weight: 700; --wcm-text-xsmall-bold-line-height: 12px; --wcm-text-xsmall-bold-letter-spacing: 0.02em; --wcm-text-xsmall-bold-text-transform: uppercase; --wcm-text-xsmall-regular-size: 12px; --wcm-text-xsmall-regular-weight: 600; --wcm-text-xsmall-regular-line-height: 14px; --wcm-text-xsmall-regular-letter-spacing: -0.03em; --wcm-text-xsmall-regular-text-transform: none; --wcm-text-small-thin-size: 14px; --wcm-text-small-thin-weight: 500; --wcm-text-small-thin-line-height: 16px; --wcm-text-small-thin-letter-spacing: -0.03em; --wcm-text-small-thin-text-transform: none; --wcm-text-small-regular-size: 14px; --wcm-text-small-regular-weight: 600; --wcm-text-small-regular-line-height: 16px; --wcm-text-small-regular-letter-spacing: -0.03em; --wcm-text-small-regular-text-transform: none; --wcm-text-medium-regular-size: 16px; --wcm-text-medium-regular-weight: 600; --wcm-text-medium-regular-line-height: 20px; --wcm-text-medium-regular-letter-spacing: -0.03em; --wcm-text-medium-regular-text-transform: none; --wcm-font-family: -apple-system, system-ui, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, Ubuntu, &#39;Helvetica Neue&#39;, sans-serif; --wcm-font-feature-settings: &#39;tnum&#39; on, &#39;lnum&#39; on, &#39;case&#39; on; --wcm-success-color: rgb(38,181,98); --wcm-error-color: rgb(242, 90, 103); --wcm-overlay-background-color: rgba(0, 0, 0, 0.3); --wcm-overlay-backdrop-filter: none;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="./Cabal Liquid Staking Token_files/aa1e03632b0a9f00.css" data-precedence="next"><link rel="stylesheet" href="./Cabal Liquid Staking Token_files/2c612863d5a616cb.css" data-precedence="next"><link rel="preload" as="script" fetchpriority="low" href="./Cabal Liquid Staking Token_files/webpack-ee83ff9cf0b0c89c.js.download"><script src="./Cabal Liquid Staking Token_files/fd9d1056-eb8d5211d3c9c065.js.download" async=""></script><script src="./Cabal Liquid Staking Token_files/2117-a3b19a97c1cb31ce.js.download" async=""></script><script src="./Cabal Liquid Staking Token_files/main-app-3138c406eafafcb7.js.download" async=""></script><script src="./Cabal Liquid Staking Token_files/2972-f84899d403fe0acb.js.download" async=""></script><title>Cabal Liquid Staking Token</title><title>Code4rena | Keeping high severity bugs out of production</title><meta name="description" content="Top auditors compete to keep high severity bugs out of production. Start a public or private audit within 48 hours."><meta name="application-name" content="Code4rena | Keeping high severity bugs out of production"><meta property="og:title" content="Code4rena"><meta property="og:description" content="Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method."><meta property="og:site_name" content="Code4rena"><meta property="og:image" content="https://code4rena.com/images/c4/c4-og-v2.png"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Code4rena"><meta name="twitter:description" content="Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method."><meta name="twitter:image" content="https://code4rena.com/images/c4/c4-og-v2.png"><link rel="icon" href="https://code4rena.com/favicon.ico" type="image/x-icon" sizes="256x256"><link rel="icon" href="https://code4rena.com/logos/c4/c4-favicon-32.png"><link rel="apple-touch-icon" href="https://code4rena.com/logos/c4/apple-touch-icon.png"><meta name="next-size-adjust"><title>Cabal Liquid Staking Token</title><meta property="og:title" content="Cabal Liquid Staking Token"><meta name="twitter:title" content="Cabal Liquid Staking Token"><script src="./Cabal Liquid Staking Token_files/polyfills-42372ed130431b0a.js.download" nomodule=""></script><link rel="preload" href="https://code4rena.com/_next/static/media/9b7eb431f23ca42e-s.p.woff2" as="font" crossorigin="" type="font/woff2"><link rel="preload" href="https://code4rena.com/_next/static/media/b603571150b520e0-s.p.ttf" as="font" crossorigin="" type="font/ttf"><link rel="preload" href="https://code4rena.com/_next/static/media/d9396795aa5ec363-s.p.woff2" as="font" crossorigin="" type="font/woff2"><style id="mttstyle">
    #mttContainer {
      left: 0 !important;
      top: 0 !important;
      width: 1000px !important;
      margin: 0px !important;
      margin-left: -500px !important;
      position: fixed !important;
      z-index: 2147483647 !important; /* Maximum z-index to overcome overlays */
      background: none !important;
      pointer-events: none !important;
      display: inline-block !important;
      visibility: visible  !important;
      white-space: pre-line;
    }
    .tippy-box[data-theme~="custom"], .tippy-box[data-theme~="ocr"], .tippy-content *{
      font-size: 18px  !important;
      text-align: center !important;
      overflow-wrap: break-word !important;
      color: #ffffffff !important;
      font-family: 
        -apple-system, BlinkMacSystemFont,
        "Segoe UI", "Roboto", "Oxygen",
        "Ubuntu", "Cantarell", "Fira Sans",
        "Droid Sans", "Helvetica Neue", sans-serif  !important;
      white-space: pre-line;
    }
    .tippy-box[data-theme~="custom"]{
      max-width: 200px  !important;
      backdrop-filter: blur(6px) !important;
      background-color: #00000080 !important;
      border: 1px solid #ffffff00; 
      box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px, rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
      opacity: 1.0; /* Adjusted opacity for transparency */
    }
    .tippy-box[data-theme~="ocr"]{
      max-width: $1000px  !important;
      backdrop-filter: blur(6px) !important;
      background-color: #00000080 !important;
      border: 1px solid #ffffff00; 
      box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px, rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
      opacity: 1.0; /* Adjusted opacity for transparency */
    }
    .tippy-box[data-theme~="transparent"] {
      max-width: $1000px  !important;
      backdrop-filter: blur(6px) !important;
      background-color: #00000080 !important;
      border: 1px solid #ffffff00; 
      box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px, rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
      opacity: 0.0; /* Adjusted opacity for transparency */
      transition: opacity 0.3s ease-in-out; /* Added transition for opacity */
    }
    [data-tippy-root] {
      display: inline-block !important;
      visibility: visible  !important;
      position: absolute !important;
    }
    .tippy-box[data-theme~='custom'][data-placement^='top'] > .tippy-arrow::before, .tippy-box[data-theme~='ocr'][data-placement^='top'] > .tippy-arrow::before { 
      border-top-color: #00000080 !important;
    }
    .tippy-box[data-theme~='custom'][data-placement^='bottom'] > .tippy-arrow::before, .tippy-box[data-theme~='ocr'][data-placement^='bottom'] > .tippy-arrow::before {
      border-bottom-color: #00000080 !important;
    }
    .tippy-box[data-theme~='custom'][data-placement^='left'] > .tippy-arrow::before, .tippy-box[data-theme~='ocr'][data-placement^='left'] > .tippy-arrow::before {
      border-left-color: #00000080 !important;
    }
    .tippy-box[data-theme~='custom'][data-placement^='right'] > .tippy-arrow::before, .tippy-box[data-theme~='ocr'][data-placement^='right'] > .tippy-arrow::before {
      border-right-color: #00000080 !important;
    }

    .mtt-highlight{
      background-color: #21dc6d40  !important;
      position: absolute !important;   
      z-index: 2147483646 !important; /* Slightly lower than tooltip */
      pointer-events: none !important;
      display: inline !important;
      border-radius: 3px !important;
    }
    .mtt-image{
      width: 180px  !important;
      border-radius: 3px !important;
    }
    .ocr_text_div{
      position: absolute;
      opacity: 0.4;
      color: transparent !important;
      border: 2px solid CornflowerBlue;
      background: none !important;
      border-radius: 3px !important;
    }</style><style id="mttstyleSubtitle">
    #ytp-caption-window-container .ytp-caption-segment {
      cursor: text !important;
      user-select: text !important;
      font-family: 
      -apple-system, BlinkMacSystemFont,
      "Segoe UI", "Roboto", "Oxygen",
      "Ubuntu", "Cantarell", "Fira Sans",
      "Droid Sans", "Helvetica Neue", sans-serif  !important;
    }
    .caption-visual-line{
      display: flex  !important;
      align-items: stretch  !important;
      direction: ltr
    }
    .captions-text .caption-visual-line:first-of-type:after {
      content: '⣿⣿';
      border-radius: 3px !important;
      color: white !important;
      background: transparent !important;
      box-shadow: rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset, rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;
      display: inline-block;
      vertical-align: top;
      opacity:0;
      transition: opacity 0.7s ease-in-out;
    }
    .ytp-caption-segment{
      color: white !important;
      text-shadow: 1px 1px 2px black !important;
      backdrop-filter: blur(3px) !important;
      background: rgba(8, 8, 8, 0.1)  !important;
    }
    .captions-text:hover .caption-visual-line:first-of-type:after {
      opacity:1;
    }
    .ytp-pause-overlay {
      display: none !important;
    }
    .ytp-expand-pause-overlay .caption-window {
      display: block !important;
    }
  </style></head><body><div class="wrapper__grid"><div class="Toastify"></div><div class="core-app"><div class="core-app--header-options--wrapper no-print"><button type="button" aria-controls="core_app_nav" aria-expanded="false" aria-label="Expand sidebar" class="core-app--hamburger"><svg class="core-app--hamburger--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="menu"><g id="Vector"><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 10.7333C2.99988 10.2362 3.40282 9.83325 3.89988 9.83325H18.5665C19.0636 9.83325 19.4665 10.2362 19.4665 10.7333C19.4665 11.2303 19.0636 11.6333 18.5665 11.6333H3.89988C3.40282 11.6333 2.99988 11.2303 2.99988 10.7333Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 5.23325C2.99988 4.7362 3.40282 4.33325 3.89988 4.33325H18.5665C19.0636 4.33325 19.4665 4.7362 19.4665 5.23325C19.4665 5.73031 19.0636 6.13325 18.5665 6.13325H3.89988C3.40282 6.13325 2.99988 5.73031 2.99988 5.23325Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M2.99988 16.2333C2.99988 15.7362 3.40282 15.3333 3.89988 15.3333H18.5665C19.0636 15.3333 19.4665 15.7362 19.4665 16.2333C19.4665 16.7303 19.0636 17.1333 18.5665 17.1333H3.89988C3.40282 17.1333 2.99988 16.7303 2.99988 16.2333Z"></path></g></g></svg></button></div><div class="core-app--nav--wrapper no-print"><nav id="core_app_nav" class="core-app--nav collapsed-mobile"><header class="core-app--nav--header"><a class="logo-link-notification-trigger mobile-collapsed no-unread" aria-label="Navigate to home" href="https://code4rena.com/"><img alt="C4 Logo" loading="lazy" width="28" height="28" decoding="async" data-nimg="1" class="app--logo" style="color:transparent" src="./Cabal Liquid Staking Token_files/c4-logo-icon.svg"></a><button class="logo-button-notification-trigger no-unread" type="button" aria-controls="core_app_notifications_popup" aria-expanded="false" aria-label="Open notifications"><img alt="C4 Logo" loading="lazy" width="28" height="28" decoding="async" data-nimg="1" class="app--logo" style="color:transparent" src="./Cabal Liquid Staking Token_files/c4-logo-icon.svg"></button><button type="button" class="bell-notification--trigger" aria-controls="core_app_notifications_popup" aria-expanded="false" aria-label="Open notifications"><svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><path stroke="var(--color__text-primary)" d="M15.1333 8.33333C15.1333 7.18406 14.6768 6.08186 13.8641 5.2692C13.0515 4.45655 11.9493 4 10.8 4C9.65072 4 8.54852 4.45655 7.73586 5.2692C6.9232 6.08186 6.46665 7.18406 6.46665 8.33333C6.46665 13.3889 4.29999 14.8333 4.29999 14.8333H17.3C17.3 14.8333 15.1333 13.3889 15.1333 8.33333Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path stroke="var(--color__text-primary)" d="M12.0495 17.7223C11.9225 17.9412 11.7402 18.1229 11.521 18.2492C11.3017 18.3755 11.0531 18.442 10.8 18.442C10.547 18.442 10.2983 18.3755 10.0791 18.2492C9.85979 18.1229 9.67754 17.9412 9.55057 17.7223" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><button type="button" class="core-app--nav--mobile-collapsible" aria-controls="core_app_nav" aria-expanded="false" aria-label="Collapse sidebar"><svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-primary)" fill-rule="evenodd" clip-rule="evenodd" d="M5.26351 5.2636C5.61498 4.91213 6.18483 4.91213 6.5363 5.2636L11.3999 10.1272L16.2635 5.2636C16.615 4.91213 17.1848 4.91213 17.5363 5.2636C17.8878 5.61508 17.8878 6.18492 17.5363 6.5364L12.6727 11.4L17.5363 16.2636C17.8878 16.6151 17.8878 17.1849 17.5363 17.5364C17.1848 17.8879 16.615 17.8879 16.2635 17.5364L11.3999 12.6728L6.5363 17.5364C6.18483 17.8879 5.61498 17.8879 5.26351 17.5364C4.91204 17.1849 4.91204 16.6151 5.26351 16.2636L10.1271 11.4L5.26351 6.5364C4.91204 6.18492 4.91204 5.61508 5.26351 5.2636Z"></path></g></svg></button></header><div class="core-app--nav--content"><section><ul class="core-app--nav--group"><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="News" href="https://code4rena.com/"><div class="logo-24"><img alt="News" loading="lazy" decoding="async" data-nimg="fill" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" src="./Cabal Liquid Staking Token_files/32.svg"></div><p class="core-app--link--label">News</p></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Leaderboard" href="https://code4rena.com/leaderboard"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M9.10789 3.09263C9.79177 1.63579 11.8639 1.63579 12.5477 3.09263L14.197 6.60605C14.2112 6.63621 14.2394 6.65734 14.2724 6.6624L18.0423 7.24182C19.5703 7.47667 20.1931 9.34094 19.1131 10.4471L16.3245 13.3031C16.3023 13.3259 16.2923 13.3578 16.2974 13.3891L16.9465 17.369C17.2019 18.9345 15.5399 20.1051 14.1518 19.3376L10.8762 17.5262C10.8461 17.5095 10.8095 17.5095 10.7794 17.5262L7.5038 19.3376C6.11573 20.1051 4.45379 18.9345 4.70913 17.369L5.35828 13.3891C5.36339 13.3578 5.35331 13.3259 5.33113 13.3031L2.54256 10.4471C1.4625 9.34094 2.08531 7.47667 3.61339 7.24182L7.38328 6.6624C7.41621 6.65734 7.44445 6.63621 7.45861 6.60605L9.10789 3.09263ZM10.7725 3.81389C10.7638 3.81911 10.7507 3.82897 10.7373 3.85751L9.08802 7.37093C8.81904 7.94393 8.28237 8.34535 7.65672 8.44151L3.88683 9.02092C3.85803 9.02535 3.84468 9.03447 3.83657 9.04159C3.82586 9.051 3.81435 9.0666 3.80717 9.08808C3.8 9.10955 3.79982 9.12894 3.80273 9.1429C3.80493 9.15347 3.81011 9.16878 3.83047 9.18962L6.61904 12.0456C7.0405 12.4773 7.23192 13.0834 7.1348 13.6789L6.48565 17.6588C6.48072 17.689 6.48571 17.7045 6.48993 17.714C6.49571 17.727 6.5075 17.743 6.52676 17.7566C6.54602 17.7702 6.5651 17.7759 6.57928 17.7769C6.58962 17.7777 6.60593 17.7772 6.63274 17.7624L9.90837 15.951C10.4805 15.6346 11.1751 15.6346 11.7473 15.951L15.0229 17.7624C15.0497 17.7772 15.066 17.7777 15.0764 17.7769C15.0905 17.7759 15.1096 17.7702 15.1289 17.7566C15.1481 17.743 15.1599 17.727 15.1657 17.714C15.1699 17.7045 15.1749 17.689 15.17 17.6588L14.5208 13.6789C14.4237 13.0834 14.6151 12.4773 15.0366 12.0456L17.8252 9.18962C17.8455 9.16878 17.8507 9.15347 17.8529 9.1429C17.8558 9.12894 17.8556 9.10955 17.8485 9.08808C17.8413 9.0666 17.8298 9.051 17.8191 9.04159C17.811 9.03447 17.7976 9.02535 17.7688 9.02092L13.9989 8.44151C13.3733 8.34535 12.8366 7.94393 12.5676 7.37093L10.9183 3.85751C10.9049 3.82897 10.8918 3.81911 10.8832 3.81389C10.8711 3.80655 10.8519 3.8 10.8278 3.8C10.8037 3.8 10.7846 3.80655 10.7725 3.81389Z"></path></g></svg><p class="core-app--link--label">Leaderboard</p></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Submissions" href="https://code4rena.com/your-submissions"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M6.54287 3C5.92151 3 5.32559 3.24684 4.88622 3.68621C4.44685 4.12558 4.20001 4.72149 4.20001 5.34286V17.0571C4.20001 17.6785 4.44685 18.2744 4.88622 18.7138C5.32559 19.1532 5.9215 19.4 6.54287 19.4H15.3286C15.9499 19.4 16.5459 19.1532 16.9852 18.7138C17.4246 18.2744 17.6714 17.6785 17.6714 17.0571V8.27143C17.6714 8.03842 17.5789 7.81495 17.4141 7.65018L13.0213 3.25733C12.8565 3.09256 12.633 3 12.4 3H6.54287ZM6.12871 4.92869C6.23855 4.81885 6.38753 4.75714 6.54287 4.75714H11.6679V8.27145C11.6679 8.6758 11.9957 9.0036 12.4 9.0036H15.9143V17.0571C15.9143 17.2125 15.8526 17.3615 15.7427 17.4713C15.6329 17.5811 15.4839 17.6429 15.3286 17.6429H6.54287C6.38753 17.6429 6.23855 17.5811 6.12871 17.4713C6.01886 17.3615 5.95716 17.2125 5.95716 17.0571V5.34286C5.95716 5.18752 6.01886 5.03854 6.12871 4.92869ZM14.8183 7.53931L13.1322 5.85323V7.53931H14.8183Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M7.27501 11.9321C7.27501 11.5278 7.6028 11.2 8.00716 11.2H13.8643C14.2687 11.2 14.5964 11.5278 14.5964 11.9321C14.5964 12.3365 14.2687 12.6643 13.8643 12.6643H8.00716C7.6028 12.6643 7.27501 12.3365 7.27501 11.9321Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M7.27501 14.8607C7.27501 14.4564 7.6028 14.1286 8.00716 14.1286H13.8643C14.2687 14.1286 14.5964 14.4564 14.5964 14.8607C14.5964 15.2651 14.2687 15.5929 13.8643 15.5929H8.00716C7.6028 15.5929 7.27501 15.2651 7.27501 14.8607Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M7.27501 9.00357C7.27501 8.59922 7.6028 8.27143 8.00716 8.27143H9.47144C9.87579 8.27143 10.2036 8.59922 10.2036 9.00357C10.2036 9.40792 9.87579 9.73571 9.47144 9.73571H8.00716C7.6028 9.73571 7.27501 9.40792 7.27501 9.00357Z"></path></g></g></svg><p class="core-app--link--label">Submissions</p></a></li></ul></section><hr class="core-app--hr"><section><p class="core-app--nav--heading">Explore C4</p><ul class="core-app--nav--group"><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Audits" href="https://code4rena.com/audits"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M9.81977 3.31602C10.1791 3.10898 10.5866 3 11.0014 3C11.4161 3 11.8236 3.10898 12.1829 3.31602C12.1836 3.31638 12.1842 3.31675 12.1848 3.31711L17.3192 6.25104C17.6787 6.45858 17.9773 6.75701 18.185 7.11637C18.3927 7.47573 18.5023 7.8834 18.5027 8.29848V14.1673C18.5023 14.5823 18.3927 14.9909 18.185 15.3503C17.9773 15.7097 17.6787 16.0081 17.3192 16.2156L17.3158 16.2176L12.1848 19.1496C12.1842 19.1499 12.1835 19.1503 12.1829 19.1507C11.8236 19.3577 11.4161 19.4667 11.0014 19.4667C10.5866 19.4667 10.1792 19.3577 9.8198 19.1507C9.81916 19.1503 9.81851 19.1499 9.81787 19.1496L4.68696 16.2176L4.68348 16.2156C4.32402 16.0081 4.02544 15.7097 3.81772 15.3503C3.61 14.9909 3.50043 14.5833 3.5 14.1682L3.5 8.2994C3.50043 7.88432 3.61 7.47573 3.81772 7.11637C4.02544 6.75701 4.32402 6.45859 4.68348 6.25105L4.68695 6.24904L9.81977 3.31602ZM11.0014 4.8C10.9018 4.8 10.8041 4.8262 10.7179 4.87596L10.7144 4.87796L5.58214 7.81067C5.49664 7.86035 5.4256 7.93154 5.3761 8.01717C5.32641 8.10314 5.30016 8.20066 5.3 8.29996V14.1667C5.30016 14.266 5.32641 14.3635 5.3761 14.4495C5.4256 14.5351 5.49662 14.6063 5.58212 14.656C5.58257 14.6562 5.58303 14.6565 5.58348 14.6568L10.7179 17.5907C10.8041 17.6405 10.9018 17.6667 11.0014 17.6667C11.1009 17.6667 11.1986 17.6405 11.2848 17.5907L11.2883 17.5887L16.4192 14.6568C16.4197 14.6565 16.4201 14.6562 16.4206 14.656C16.5061 14.6063 16.5771 14.5351 16.6266 14.4495C16.6763 14.3636 16.7025 14.2662 16.7027 14.167C16.7027 14.1668 16.7027 14.1672 16.7027 14.167L16.7027 8.30032C16.7027 8.30012 16.7027 8.30052 16.7027 8.30032C16.7025 8.20111 16.6763 8.10307 16.6266 8.01717C16.5771 7.93154 16.5061 7.86036 16.4206 7.81068C16.4201 7.81042 16.4197 7.81015 16.4192 7.80989L11.2848 4.87597C11.1986 4.82621 11.1009 4.8 11.0014 4.8Z"></path></g></svg><p class="core-app--link--label">Audits</p></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Bounties" href="https://code4rena.com/bounties"><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="none" class="core-app--link--icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.808 6.5083C14.984 6.5086 16.1117 6.97597 16.9431 7.80763C17.7746 8.63929 18.2417 9.76714 18.2417 10.9431V13.75C18.2417 14.701 18.0544 15.6426 17.6904 16.5212C17.3265 17.3998 16.7931 18.1981 16.1206 18.8706C15.4482 19.543 14.6499 20.0765 13.7713 20.4404C12.8927 20.8043 11.951 20.9916 11 20.9916C10.049 20.9916 9.10733 20.8043 8.22873 20.4404C7.35013 20.0765 6.55182 19.543 5.87937 18.8706C5.20692 18.1981 4.6735 17.3998 4.30957 16.5212C3.94564 15.6426 3.75833 14.701 3.75833 13.75V10.9431C3.75833 9.76733 4.22526 8.63966 5.05647 7.80803C5.88767 6.9764 7.01511 6.5089 8.19091 6.5083L13.808 6.5083ZM8.19175 8.1583C8.1917 8.1583 8.19165 8.1583 8.19161 8.1583C8.19151 8.1583 8.19142 8.1583 8.19133 8.1583C7.45314 8.15879 6.74534 8.45234 6.22349 8.97446C5.70154 9.49668 5.40833 10.2048 5.40833 10.9431V13.75C5.40833 14.4843 5.55296 15.2114 5.83397 15.8898C6.11498 16.5682 6.52686 17.1846 7.04609 17.7039C7.56533 18.2231 8.18175 18.635 8.86016 18.916C9.53857 19.197 10.2657 19.3416 11 19.3416C11.7343 19.3416 12.4614 19.197 13.1398 18.916C13.8182 18.635 14.4347 18.2231 14.9539 17.7039C15.4731 17.1846 15.885 16.5682 16.166 15.8898C16.447 15.2114 16.5917 14.4843 16.5917 13.75V10.9431C16.5917 10.2047 16.2984 9.49645 15.7763 8.97421C15.2542 8.45202 14.5461 8.15854 13.8077 8.1583M8.19175 8.1583H13.8075Z" fill="var(--color__text-tertiary)"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M7.49981 3.37487C8.42811 2.44657 9.68717 1.92505 11 1.92505C12.3128 1.92505 13.5719 2.44657 14.5002 3.37487C15.4285 4.30317 15.95 5.56223 15.95 6.87505V7.79171H14.3V6.87505C14.3 5.99983 13.9523 5.16047 13.3334 4.5416C12.7146 3.92273 11.8752 3.57505 11 3.57505C10.1248 3.57505 9.28541 3.92273 8.66654 4.5416C8.04767 5.16047 7.69999 5.99983 7.69999 6.87505V7.79171H6.04999V6.87505C6.04999 5.56223 6.5715 4.30317 7.49981 3.37487Z" fill="var(--color__text-tertiary)"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M2.44234 7.02688C2.61156 6.60383 3.09168 6.39806 3.51473 6.56728L5.34806 7.30062C5.77111 7.46983 5.97688 7.94996 5.80766 8.37301C5.63844 8.79605 5.15831 9.00182 4.73527 8.8326L2.90193 8.09927C2.47889 7.93005 2.27312 7.44993 2.44234 7.02688ZM19.5577 7.02688C19.7269 7.44993 19.5211 7.93005 19.0981 8.09927L17.2647 8.8326C16.8417 9.00182 16.3616 8.79605 16.1923 8.37301C16.0231 7.94996 16.2289 7.46983 16.6519 7.30062L18.4853 6.56728C18.9083 6.39806 19.3884 6.60383 19.5577 7.02688ZM1.00833 12.8333C1.00833 12.3776 1.3777 12.0083 1.83333 12.0083H4.58333C5.03897 12.0083 5.40833 12.3776 5.40833 12.8333C5.40833 13.2889 5.03897 13.6583 4.58333 13.6583H1.83333C1.3777 13.6583 1.00833 13.2889 1.00833 12.8333ZM16.5917 12.8333C16.5917 12.3776 16.961 12.0083 17.4167 12.0083H20.1667C20.6223 12.0083 20.9917 12.3776 20.9917 12.8333C20.9917 13.2889 20.6223 13.6583 20.1667 13.6583H17.4167C16.961 13.6583 16.5917 13.2889 16.5917 12.8333ZM11 12.9249C11.4556 12.9249 11.825 13.2943 11.825 13.7499V19.7083C11.825 20.1639 11.4556 20.5333 11 20.5333C10.5444 20.5333 10.175 20.1639 10.175 19.7083V13.7499C10.175 13.2943 10.5444 12.9249 11 12.9249ZM5.80766 17.2935C5.97688 17.7166 5.77111 18.1967 5.34806 18.3659L3.51473 19.0993C3.09168 19.2685 2.61156 19.0627 2.44234 18.6397C2.27312 18.2166 2.47889 17.7365 2.90193 17.5673L4.73527 16.834C5.15831 16.6647 5.63844 16.8705 5.80766 17.2935ZM16.1923 17.2935C16.3616 16.8705 16.8417 16.6647 17.2647 16.834L19.0981 17.5673C19.5211 17.7365 19.7269 18.2166 19.5577 18.6397C19.3884 19.0627 18.9083 19.2685 18.4853 19.0993L16.6519 18.3659C16.2289 18.1967 16.0231 17.7166 16.1923 17.2935Z" fill="var(--color__text-tertiary)"></path></svg><p class="core-app--link--label">Bounties</p></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Reports" href="https://code4rena.com/reports"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M14.9389 4.07141H15.625C16.2956 4.07141 16.9111 4.37228 17.3448 4.86051C17.7752 5.34489 18 5.97903 18 6.61903V17.4524C18 18.0924 17.7752 18.7265 17.3448 19.2109C16.9111 19.6991 16.2956 20 15.625 20H7.375C6.70438 20 6.08893 19.6991 5.65516 19.2109C5.22481 18.7265 5 18.0924 5 17.4524V6.61903C5 5.97903 5.22481 5.34489 5.65516 4.86051C6.08893 4.37228 6.70438 4.07141 7.375 4.07141H8.06109C8.28105 3.34179 9.05005 3 9.625 3H13.375C13.9499 3 14.7189 3.34179 14.9389 4.07141ZM8.11306 6.07141H7.375C7.31628 6.07141 7.23225 6.09664 7.1503 6.18888C7.06492 6.28497 7 6.43812 7 6.61903V17.4524C7 17.6333 7.06492 17.7864 7.1503 17.8825C7.23225 17.9748 7.31628 18 7.375 18H15.625C15.6837 18 15.7677 17.9748 15.8497 17.8825C15.9351 17.7864 16 17.6333 16 17.4524V6.61903C16 6.43812 15.9351 6.28498 15.8497 6.18888C15.7678 6.09664 15.6837 6.07141 15.625 6.07141H14.8869C14.6157 6.7029 13.911 7 13.375 7H9.625C9.08896 7 8.38425 6.7029 8.11306 6.07141Z"></path></g></g></svg><p class="core-app--link--label">Reports</p></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Docs (opens in new window)" target="_blank" rel="noreferrer noopener" href="https://docs.code4rena.com/"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M11 5.5C7.68629 5.5 5 8.18629 5 11.5C5 14.8137 7.68629 17.5 11 17.5C14.3137 17.5 17 14.8137 17 11.5C17 8.18629 14.3137 5.5 11 5.5ZM3 11.5C3 7.08172 6.58172 3.5 11 3.5C15.4183 3.5 19 7.08172 19 11.5C19 15.9183 15.4183 19.5 11 19.5C6.58172 19.5 3 15.9183 3 11.5Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M11 10.5C11.5523 10.5 12 10.9477 12 11.5V14.7C12 15.2523 11.5523 15.7 11 15.7C10.4477 15.7 10 15.2523 10 14.7V11.5C10 10.9477 10.4477 10.5 11 10.5Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M10 8.29974C10 7.74746 10.4477 7.29974 11 7.29974H11.01C11.5623 7.29974 12.01 7.74746 12.01 8.29974C12.01 8.85203 11.5623 9.29974 11.01 9.29974H11C10.4477 9.29974 10 8.85203 10 8.29974Z"></path></g></g></svg><p class="core-app--link--label">Docs</p><svg class="core-app--link--external" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M13.6778 4.8C13.1807 4.8 12.7778 4.39706 12.7778 3.9C12.7778 3.40294 13.1807 3 13.6778 3H18.5667C19.0637 3 19.4667 3.40294 19.4667 3.9V8.78889C19.4667 9.28595 19.0637 9.68889 18.5667 9.68889C18.0696 9.68889 17.6667 9.28595 17.6667 8.78889V6.07279L10.2401 13.4994C9.88861 13.8508 9.31876 13.8508 8.96729 13.4994C8.61582 13.1479 8.61582 12.578 8.96729 12.2266L16.3939 4.8H13.6778ZM5.52961 7.24448C5.3361 7.24448 5.15052 7.32135 5.01369 7.45818C4.87685 7.59501 4.79998 7.7806 4.79998 7.97411V16.9371C4.79998 17.1306 4.87685 17.3162 5.01369 17.453C5.15052 17.5898 5.3361 17.6667 5.52961 17.6667H14.4926C14.6861 17.6667 14.8717 17.5898 15.0085 17.453C15.1453 17.3162 15.2222 17.1306 15.2222 16.9371V12.0482C15.2222 11.5511 15.6251 11.1482 16.1222 11.1482C16.6193 11.1482 17.0222 11.5511 17.0222 12.0482V16.9371C17.0222 17.608 16.7557 18.2514 16.2813 18.7258C15.8069 19.2002 15.1635 19.4667 14.4926 19.4667H5.52961C4.85871 19.4667 4.21529 19.2002 3.74089 18.7258C3.2665 18.2514 2.99998 17.608 2.99998 16.9371V7.97411C2.99998 7.30321 3.2665 6.65979 3.74089 6.18539C4.21529 5.71099 4.85871 5.44448 5.52961 5.44448H10.4185C10.9156 5.44448 11.3185 5.84742 11.3185 6.34448C11.3185 6.84154 10.9156 7.24448 10.4185 7.24448H5.52961Z"></path></g></g></svg></a></li><li class="core-app--nav--link"><a aria-describedby="core-app--nav--tooltip" aria-label="Support" href="https://code4rena.com/help"><svg class="core-app--link--icon" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M11.2349 4.8C7.68095 4.8 4.7999 7.68105 4.7999 11.235C4.7999 12.7888 5.34945 14.2118 6.26567 15.3238C6.51173 15.6225 6.53935 16.045 6.33426 16.3731L5.52372 17.67H11.2349C14.7889 17.67 17.6699 14.789 17.6699 11.235C17.6699 7.68105 14.7889 4.8 11.2349 4.8ZM2.9999 11.235C2.9999 6.68693 6.68684 3 11.2349 3C15.783 3 19.4699 6.68693 19.4699 11.235C19.4699 15.7831 15.783 19.47 11.2349 19.47H3.8999C3.57273 19.47 3.27133 19.2925 3.11272 19.0063C2.95412 18.7201 2.9633 18.3704 3.1367 18.093L4.47913 15.9451C3.54708 14.6104 2.9999 12.9857 2.9999 11.235Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M11.1412 8.81802C10.8498 8.76805 10.5502 8.8228 10.2954 8.97256C10.0406 9.12232 9.84699 9.35744 9.7489 9.63627C9.58396 10.1052 9.07013 10.3516 8.60124 10.1866C8.13235 10.0217 7.88596 9.50784 8.0509 9.03895C8.29005 8.35912 8.76208 7.78587 9.38339 7.42072C10.0047 7.05557 10.7352 6.92209 11.4455 7.04393C12.1558 7.16576 12.8 7.53505 13.2641 8.08637C13.7281 8.63754 13.9821 9.3351 13.9812 10.0555C13.9808 11.2501 13.0967 12.0226 12.5046 12.4174C12.1811 12.633 11.864 12.7909 11.6313 12.8944C11.5137 12.9466 11.4144 12.9864 11.3424 13.0138C11.3064 13.0276 11.2769 13.0383 11.2552 13.046L11.2286 13.0553L11.2198 13.0583L11.2166 13.0594L11.2153 13.0599L11.2286 13.0553L11.2142 13.0602C10.7426 13.2174 10.2329 12.9626 10.0758 12.491C9.91858 12.0195 10.1734 11.5098 10.645 11.3526L10.6434 11.3531L10.6522 11.35C10.6621 11.3465 10.6789 11.3404 10.7016 11.3318C10.7473 11.3143 10.8161 11.2869 10.9002 11.2495C11.071 11.1736 11.2918 11.0626 11.5061 10.9197C11.9897 10.5973 12.1812 10.2942 12.1812 10.0548L12.1812 10.0535C12.1816 9.75789 12.0774 9.4717 11.8871 9.24557C11.6967 9.01945 11.4325 8.86799 11.1412 8.81802Z"></path><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M10.0869 15.075C10.0869 14.578 10.4899 14.175 10.9869 14.175H10.9969C11.494 14.175 11.8969 14.578 11.8969 15.075C11.8969 15.5721 11.494 15.975 10.9969 15.975H10.9869C10.4899 15.975 10.0869 15.5721 10.0869 15.075Z"></path></g></g></svg><p class="core-app--link--label">Support</p></a></li></ul></section></div><div id="core-app--nav--tooltip" role="tooltip" class="core-app--nav--tooltip"></div><div class="core-app--nav--footer"><button class="core-app--settings--submenu-trigger" aria-describedby="core-app--nav--tooltip" aria-label="User Options" type="button"><div class="avatar-c4 img-fill--cover " style="border-radius: 4px; width: 24px; height: 24px;"><img alt="Avatar for enthu2218" loading="lazy" decoding="async" data-nimg="fill" sizes="40px" srcset="/_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=16&amp;q=75 16w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=32&amp;q=75 32w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=48&amp;q=75 48w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=64&amp;q=75 64w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=96&amp;q=75 96w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=128&amp;q=75 128w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=256&amp;q=75 256w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=384&amp;q=75 384w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=640&amp;q=75 640w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=750&amp;q=75 750w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=828&amp;q=75 828w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=1080&amp;q=75 1080w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=1200&amp;q=75 1200w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=1920&amp;q=75 1920w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=2048&amp;q=75 2048w, /_next/image?url=https%3A%2F%2Fapi-v1.code4rena.com%2Favatars%2Fenthu2218&amp;w=3840&amp;q=75 3840w" src="./Cabal Liquid Staking Token_files/enthu2218.png" style="position: absolute; height: 100%; width: 100%; inset: 0px; color: transparent;"></div><strong class="username">enthu2218</strong><svg class="chevron-up" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M10.2636 6.2636C10.6151 5.91213 11.1849 5.91213 11.5364 6.2636L17.0364 11.7636C17.3879 12.1151 17.3879 12.6849 17.0364 13.0364C16.6849 13.3879 16.1151 13.3879 15.7636 13.0364L10.9 8.17279L6.0364 13.0364C5.68492 13.3879 5.11508 13.3879 4.7636 13.0364C4.41213 12.6849 4.41213 12.1151 4.7636 11.7636L10.2636 6.2636Z"></path></g></g></svg></button></div></nav><button type="button" aria-controls="core_app_nav" aria-expanded="true" aria-label="Collapse sidebar" class="core-app--nav--collapsible"><svg class="toggle-menu" width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M10.5363 5.2636C10.8878 5.61508 10.8878 6.18492 10.5363 6.5364L6.1727 10.9L10.5363 15.2636C10.8878 15.6151 10.8878 16.1849 10.5363 16.5364C10.1848 16.8879 9.61498 16.8879 9.26351 16.5364L4.26351 11.5364C3.91204 11.1849 3.91204 10.6151 4.26351 10.2636L9.26351 5.2636C9.61498 4.91213 10.1848 4.91213 10.5363 5.2636ZM17.5363 5.2636C17.8878 5.61508 17.8878 6.18492 17.5363 6.5364L13.1727 10.9L17.5363 15.2636C17.8878 15.6151 17.8878 16.1849 17.5363 16.5364C17.1848 16.8879 16.615 16.8879 16.2635 16.5364L11.2635 11.5364C10.912 11.1849 10.912 10.6151 11.2635 10.2636L16.2635 5.2636C16.615 4.91213 17.1848 4.91213 17.5363 5.2636Z"></path></g></svg></button></div><main class="core-app--main sidebar--open"><div class="core-app-report"><header class="core-app--header no-print"><div class="core-app--header--left"><a class="core-app--header--redirect" href="https://code4rena.com/reports"><svg width="24px" height="24px" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg"><g><path fill="var(--color__text-tertiary)" fill-rule="evenodd" clip-rule="evenodd" d="M13.0364 5.2636C13.3878 5.61508 13.3878 6.18492 13.0364 6.5364L8.17276 11.4L13.0364 16.2636C13.3878 16.6151 13.3878 17.1849 13.0364 17.5364C12.6849 17.8879 12.115 17.8879 11.7636 17.5364L6.26357 12.0364C5.9121 11.6849 5.9121 11.1151 6.26357 10.7636L11.7636 5.2636C12.115 4.91213 12.6849 4.91213 13.0364 5.2636Z"></path></g></svg><strong>Reports</strong></a><div class="core-app--header--filters"></div></div></header><a class="core-app-report__back-button limited-width" href="https://code4rena.com/reports">Reports</a><section class="core-app-report__top limited-width"><div class="core-app-report__top-content"><div class="core-app-report__project"><div class="core-app-report__project--top"><div class="core-app-report__project-link project-link"><a href="https://x.com/CabalVIP" class="logo-64"><img alt="Cabal" loading="lazy" decoding="async" data-nimg="fill" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;color:transparent" sizes="70px" srcset="/_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=16&amp;q=75 16w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=32&amp;q=75 32w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=48&amp;q=75 48w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=64&amp;q=75 64w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=96&amp;q=75 96w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=128&amp;q=75 128w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=256&amp;q=75 256w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=384&amp;q=75 384w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=640&amp;q=75 640w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=750&amp;q=75 750w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=828&amp;q=75 828w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=1080&amp;q=75 1080w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=1200&amp;q=75 1200w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=1920&amp;q=75 1920w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=2048&amp;q=75 2048w, /_next/image?url=https%3A%2F%2Fcode4-api-v0-public-storage.s3.us-east-1.amazonaws.com%2Fupload-NnwpwCS5Huo&amp;w=3840&amp;q=75 3840w" src="./Cabal Liquid Staking Token_files/upload-NnwpwCS5Huo.jpeg"></a></div><div class="core-app-report__details"><h1 class="type__headline__xs">Cabal Liquid Staking Token<!-- --> Findings &amp; Analysis Report</h1></div></div></div></div><ul class="core-app-report__details-grid"><div class="core-app-report__details-wrapper"><li class="core-app-report__published"><span class="core-app-report__grid-value">PUBLISHED <!-- -->May 28, 2025</span></li></div></ul></section><div class=" core-app-report__md-wrapper limited-width type__copy"><div class="core-app-report__container"><div class="core-app-report__contents markdown-body"><h1 style="position:relative;" id="overview"><a class="anchor before" aria-label="overview permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#overview"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Overview</h1>
<h2 style="position:relative;" id="about-c4"><a class="anchor before" aria-label="about c4 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#about-c4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>About C4</h2>
<p>Code4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.</p>
<p>A C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.</p>
<p>During the audit outlined in this document, C4 conducted an analysis of the Cabal Liquid Staking Token smart contract system. The audit took place from April 28 to May 05, 2025.</p>
<p>Final report assembled by Code4rena.</p>
<h1 style="position:relative;" id="summary"><a class="anchor before" aria-label="summary permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#summary"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Summary</h1>
<p>The C4 analysis yielded an aggregated total of 8 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.</p>
<p>All of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Cabal team.</p>
<h1 style="position:relative;" id="scope"><a class="anchor before" aria-label="scope permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#scope"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Scope</h1>
<p>The code under review can be found within the <a href="https://github.com/code-423n4/2025-04-cabal">C4 Cabal Liquid Staking Token repository</a>, and is composed of 8 smart contracts written in the Move programming language and includes 2,574 lines of Move code.</p>
<h1 style="position:relative;" id="severity-criteria"><a class="anchor before" aria-label="severity criteria permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#severity-criteria"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Severity Criteria</h1>
<p>C4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.</p>
<p>High-level considerations for vulnerabilities span the following key areas when conducting assessments:</p>
<ul>
<li>Malicious Input Handling</li>
<li>Escalation of privileges</li>
<li>Arithmetic</li>
<li>Gas use</li>
</ul>
<p>For more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on <a href="https://code4rena.com/">the C4 website</a>, specifically our section on <a href="https://docs.code4rena.com/awarding/judging-criteria/severity-categorization">Severity Categorization</a>.</p>
<h1 style="position:relative;" id="high-risk-findings-1"><a class="anchor before" aria-label="high risk findings 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#high-risk-findings-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>High Risk Findings (1)</h1>
<h2 style="position:relative;" id="h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking"><a class="anchor before" aria-label="h 01 lp unstaking only burns the shares but leaves the underlying tokens in the system which distorts the shares to tokens ratio and leads to incorrect amounts being calculated during staking and unstaking permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-156">[H-01] LP unstaking only burns the shares but leaves the underlying tokens in the system, which distorts the shares-to-tokens ratio and leads to incorrect amounts being calculated during staking and unstaking</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-176">TheSchnilch</a>, also found by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-232">ret2basic</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054</a></p>
<h3 style="position:relative;" id="finding-description"><a class="anchor before" aria-label="finding description permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description</h3>
<p>When a user unstakes LP tokens, the corresponding shares (Cabal tokens) are burned. However, the actual undelegation from the validator will occur only after a delay of up to 3 days. During this period, the shares are already burned, but the underlying tokens are still included in shares-to-token conversions.
This is a problem because, in <code>process_lp_unstake</code>, the amount of tokens to unbond is calculated as follows:
<a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054</a></p>
<p>The <code>lp_amount</code> is calculated based on the amount of tokens actually staked on the validator. This includes tokens that are pending to be undelegated (<code>unstaked_pending_amounts</code>), for which the Cabal tokens have already been burned.</p>
<p>This means that the <code>unbonding_amount</code> is also calculated incorrectly because the <code>lp_amount</code> is too high. As a result, the <code>unbonding_amount</code> will also be too high, and the unstaker will receive too many tokens that are actually belonging to other users.</p>
<p>Since the Cabal tokens a user receives are also calculated this way in <code>process_lp_stake</code>, users will receive too few shares when there are pending undelegations. As a result, they will have fewer tokens after the next <code>batch_undelegate_pending_lps</code>:
<a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953</a></p>
<h3 style="position:relative;" id="impact"><a class="anchor before" aria-label="impact permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#impact"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Because users receive too many tokens that actually belong to other users, and since this issue occurs during normal unstaking and staking, it is high severity.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps"><a class="anchor before" aria-label="recommended mitigation steps permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>The <code>unstaked_pending_amounts</code> should be subtracted from the <code>lp_amount</code> to correctly account for the pending tokens to be undelegated, for which the Cabal tokens have already been burned.</p>
<h3 style="position:relative;" id="proof-of-concept"><a class="anchor before" aria-label="proof of concept permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="0" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    #[test(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        c = @staking_addr, user_a = @0xAAA, user_b = @0xBBB, user_c = @0xCCC</span></span>
<span class="grvsc-line"><span class="grvsc-source">    )]</span></span>
<span class="grvsc-line"><span class="grvsc-source">    fun test_poc(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        c: &amp;signer,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        user_a: &amp;signer,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        user_b: &amp;signer,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        user_c: &amp;signer</span></span>
<span class="grvsc-line"><span class="grvsc-source">    ) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        test_setup(c, string::utf8(b"initvaloper1test"));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        //gets the metadata for all tokens</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let ulp_metadata = coin::metadata(@initia_std, string::utf8(b"ulp"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let init_metadata = coin::metadata(@initia_std, string::utf8(b"uinit"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let cabal_lp_metadata = cabal::get_cabal_token_metadata(1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let x_init_metadata = cabal::get_xinit_metadata();</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let sx_init_metadata = cabal::get_sxinit_metadata();</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        let initia_signer = &amp;account::create_signer_for_test(@initia_std);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        let ulp_decimals = 1_000_000; //ulp has 6 decimals</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        let deposit_amount_a = 100 * ulp_decimals; //the amount user a deposits</span></span>
<span class="grvsc-line"><span class="grvsc-source">        primary_fungible_store::transfer( //user a must first be funded</span></span>
<span class="grvsc-line"><span class="grvsc-source">            initia_signer,</span></span>
<span class="grvsc-line"><span class="grvsc-source">            ulp_metadata,</span></span>
<span class="grvsc-line"><span class="grvsc-source">            signer::address_of(user_a),</span></span>
<span class="grvsc-line"><span class="grvsc-source">            deposit_amount_a</span></span>
<span class="grvsc-line"><span class="grvsc-source">        );</span></span>
<span class="grvsc-line"><span class="grvsc-source">        utils::increase_block(1, 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        cabal::mock_stake(user_a, 1, deposit_amount_a); //user a stakes 100 ulp</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        utils::increase_block(1, 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        let deposit_amount_b = 50 * ulp_decimals; //the amount user b stakes</span></span>
<span class="grvsc-line"><span class="grvsc-source">        primary_fungible_store::transfer(</span></span>
<span class="grvsc-line"><span class="grvsc-source">            initia_signer,</span></span>
<span class="grvsc-line"><span class="grvsc-source">            ulp_metadata,</span></span>
<span class="grvsc-line"><span class="grvsc-source">            signer::address_of(user_b),</span></span>
<span class="grvsc-line"><span class="grvsc-source">            deposit_amount_b</span></span>
<span class="grvsc-line"><span class="grvsc-source">        );</span></span>
<span class="grvsc-line"><span class="grvsc-source">        utils::increase_block(1, 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        cabal::mock_stake(user_b, 1, deposit_amount_b); //user b stakes 50 ulp</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        utils::increase_block(1, 1000);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        cabal::mock_unstake(user_b, 1, deposit_amount_b); //user b unstakes 50 ulp this means the cabal tokens are now 100 and the underlying tokens 150</span></span>
<span class="grvsc-line"><span class="grvsc-source">        //This mock unstaking uses the pool balances instead of querying the validator because Cosmos is not supported during testing. </span></span>
<span class="grvsc-line"><span class="grvsc-source">        //However, this is not a problem, since the pools are only modified after the undelegation, not during the unstaking</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        utils::increase_block(1, 1000);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        cabal::mock_unstake(user_a, 1, 50 * ulp_decimals); //user a unstakes half of his cabal lp tokens for which 50 ulp tokens should be unstaked but actually 75 are getting unstaked</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>You can also add <code>debug::print(&amp;unbonding_amount);</code> to line 1334 in cabal.move to verify that 75 ULP tokens are being unstaked instead of 50.</p>
<p>To run the POC, paste it into the file <code>tests/core_staking_test.move</code> and run the command <code>initiad move test -f test_poc</code></p>
<hr>
<h1 style="position:relative;" id="medium-risk-findings-7"><a class="anchor before" aria-label="medium risk findings 7 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#medium-risk-findings-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Medium Risk Findings (7)</h1>
<h2 style="position:relative;" id="m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos"><a class="anchor before" aria-label="m 01 reentrancy check in lock_stakingreentry_check causes concurrent init deposit failures dos permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-27">[M-01] Reentrancy Check in <code>lock_staking::reentry_check</code> Causes Concurrent INIT Deposit Failures (DOS)</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-29">rare_one</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661</a></p>
<h3 style="position:relative;" id="finding-description-and-impact"><a class="anchor before" aria-label="finding description and impact permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description-and-impact"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>The liquid staking protocol’s <code>deposit_init_for_xinit</code> function, which allows users to deposit INIT tokens to receive xINIT, is vulnerable to transaction failures when multiple users deposit concurrently in the same block. The function withdraws INIT tokens and delegates them to a validator via <code>pool_router::add_stake</code>, which triggers <code>lock_staking::delegate</code>. This, in turn, invokes <code>reentry_check</code> to prevent multiple delegations in the same block. </p>
<p>If a second user attempts to deposit in the same block as another, their transaction fails with error code 196618 (EREENTER), as <code>reentry_check</code> detects that the StakingAccount was already modified in the current block. This vulnerability disrupts users’ ability to participate in the protocol, particularly during periods of high transaction activity.</p>
<h3 style="position:relative;" id="root-cause"><a class="anchor before" aria-label="root cause permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#root-cause"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Root Cause:</h3>
<p>The <code>reentry_check</code> function in lock_staking.move enforces a strict one-delegation-per-block rule for a given StakingAccount:</p>
<pre data-index="1" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">fun reentry_check(</span></span>
<span class="grvsc-line"><span class="grvsc-source">    staking_account: &amp;mut StakingAccount, </span></span>
<span class="grvsc-line"><span class="grvsc-source">    with_update: bool</span></span>
<span class="grvsc-line"><span class="grvsc-source">) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let (height, _) = block::get_block_info();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(staking_account.last_height != height, error::invalid_state(EREENTER));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (with_update) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        staking_account.last_height = height;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
<p>This function checks if <code>staking_account.last_height</code> equals the current block height and aborts with EREENTER if true. If <code>with_update</code> is true, it updates <code>last_height</code> to the current height, marking the block as processed.</p>
<p>In cabal.move, the <code>deposit_init_for_xinit</code> function processes user deposits independently:</p>
<pre data-index="2" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">public entry fun deposit_init_for_xinit(account: &amp;signer, deposit_amount: u64) acquires ModuleStore {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    emergency::assert_no_paused();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(deposit_amount &gt; 0, error::invalid_argument(EINVALID_COIN_AMOUNT));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let m_store = borrow_global&lt;ModuleStore&gt;(@staking_addr);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let coin_metadata = coin::metadata(@initia_std, string::utf8(b"uinit"));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // calculate mint xinit</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let init_amount = pool_router::get_real_total_stakes(coin_metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let x_init_amount = option::extract(&amp;mut fungible_asset::supply(m_store.x_init_metadata));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let mint_x_init_amount = if (x_init_amount == 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deposit_amount</span></span>
<span class="grvsc-line"><span class="grvsc-source">    } else {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let ratio = bigdecimal::from_ratio_u64(deposit_amount, init_amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        // Round up because of truncation</span></span>
<span class="grvsc-line"><span class="grvsc-source">        (bigdecimal::mul_by_u128_ceil(ratio, x_init_amount) as u64)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(mint_x_init_amount &gt; 0, error::invalid_argument(EINVALID_STAKE_AMOUNT));</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // withdraw init to stake</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let fa = primary_fungible_store::withdraw(</span></span>
<span class="grvsc-line"><span class="grvsc-source">        account,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        coin_metadata,</span></span>
<span class="grvsc-line"><span class="grvsc-source">        deposit_amount</span></span>
<span class="grvsc-line"><span class="grvsc-source">    );</span></span>
<span class="grvsc-line"><span class="grvsc-source">    pool_router::add_stake(fa); // Triggers lock_staking::delegate</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    // mint xINIT to user</span></span>
<span class="grvsc-line"><span class="grvsc-source">    coin::mint_to(&amp;m_store.x_init_caps.mint_cap, signer::address_of(account), mint_x_init_amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
<p>When multiple users call <code>deposit_init_for_xinit</code> in the same block:</p>
<ul>
<li>The first user’s deposit passes <code>reentry_check</code>, updates <code>staking_account.last_height</code> to the current block height (assuming <code>with_update = true</code> in <code>lock_staking::delegate</code>), and completes, minting xINIT.</li>
<li>The second user’s deposit triggers <code>reentry_check</code> via <code>pool_router::add_stake</code> and <code>lock_staking::delegate</code>. Since <code>staking_account.last_height</code> equals the current height, the transaction aborts with EREENTER, preventing the deposit and xINIT minting.</li>
</ul>
<p>The function’s lack of coordination for concurrent deposits results in multiple <code>lock_staking::delegate</code> calls, triggering the reentrancy failure. This vulnerability is evident in production scenarios where users deposit INIT during high network activity, such as during market events or protocol launches.</p>
<p><strong>IMPACTS:</strong></p>
<p>Denial-of-Service (DoS) for Users: Users attempting to deposit INIT in a block with multiple deposits will face transaction failures, losing gas fees and being unable to receive xINIT. This disrupts their ability to participate in liquid staking, particularly during peak usage periods.</p>
<p>Financial Loss: Failed transactions result in gas fee losses for users, which can accumulate significantly in high-traffic scenarios, deterring participation.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-1"><a class="anchor before" aria-label="recommended mitigation steps 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Implement a batching mechanism to aggregate all user INIT deposits within a block and process them as a single delegation, ensuring only one call to <code>lock_staking::delegate</code> per block and bypassing the <code>reentry_check</code> restriction.</p>
<h3 style="position:relative;" id="proof-of-concept-1"><a class="anchor before" aria-label="proof of concept 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>Initialize the protocol using initialize to set up the xINIT pool.</p>
<p>Simulate two users depositing INIT in the same block using mock<em>deposit</em>init<em>for</em>xinit.</p>
<p>Observe the EREENTER error (code 196618) from reentry_check for the second deposit.</p>
<p>// User 1 transaction (submitted in block 100)
public entry fun user1<em>deposit(account: &amp;signer) {
deposit</em>init<em>for</em>xinit(account, 500<em>000</em>000);
}</p>
<p>// User 2 transaction (submitted in block 100)
public entry fun user2<em>deposit(account: &amp;signer) {
deposit</em>init<em>for</em>xinit(account, 200<em>000</em>000);
}</p>
<p>Setup:</p>
<p>Deploy the protocol and initialize it.</p>
<p>Fund User 1 (@0x1) with 500,000,000 INIT and User 2 (@0x2) with 200,000,000 INIT.</p>
<p>Set block height to 100.</p>
<p>User 1 submits user1<em>deposit in block 100, calling `deposit</em>init<em>for</em>xinit<code>, withdrawing 500,000,000 INIT, delegating via</code>pool<em>router::add</em>stake<code>(triggering</code>lock_staking::delegate`), and minting approximately 500,000,000 xINIT (adjusted for pool size).</p>
<p>User 2 submits user2<em>deposit in block 100, calling `deposit</em>init<em>for</em>xinit<code>, but</code>pool<em>router::add</em>stake<code>triggers</code>lock<em>staking::delegate<code>and</code>reentry</em>check<code>. Since</code>staking<em>account.last</em>height` equals 100 (from User 1’s deposit), the transaction aborts with EREENTER (code 196618).</p>
<p>Result:</p>
<p>User 1: Receives ~500,000,000 xINIT.</p>
<p>User 2: Transaction fails, loses gas fees, receives no xINIT.</p>
<p>This test demonstrates the issue</p>
<pre data-index="3" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">fun test_concurrent_deposits(c: &amp;signer, user_a: &amp;signer, user_b: &amp;signer) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    test_setup(c, string::utf8(b"initvaloper1test"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let init_metadata = coin::metadata(@initia_std, string::utf8(b"uinit"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let x_init_metadata = cabal::get_xinit_metadata();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Transfer INIT to users</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let deposit_a = 500_000_000;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let deposit_b = 200_000_000;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_a), deposit_a);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_b), deposit_b);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Simulate concurrent deposits (no block increase between them)</span></span>
<span class="grvsc-line"><span class="grvsc-source">    cabal::mock_deposit_init_for_xinit(user_a, deposit_a);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    cabal::mock_deposit_init_for_xinit(user_b, deposit_b);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    utils::increase_block(1, 1);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Verify xINIT balances</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let user_a_xinit = primary_fungible_store::balance(signer::address_of(user_a), x_init_metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let user_b_xinit = primary_fungible_store::balance(signer::address_of(user_b), x_init_metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(user_a_xinit == deposit_a || user_a_xinit == deposit_a - 1, 1007);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(user_b_xinit == deposit_b || user_b_xinit == deposit_b - 1, 1008);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    </span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Verify global state</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let final_xinit_supply = cabal::get_xinit_total_supply();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let final_total_staked_init = cabal::get_pool_router_total_init();</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(final_xinit_supply == (MINIMUM_LIQUIDITY as u128) + (deposit_a as u128) + (deposit_b as u128), 1009);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    assert!(final_total_staked_init == MINIMUM_LIQUIDITY + deposit_a + deposit_b, 1010);</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
<p>and the result</p>
<pre data-index="4" data-language="solidity" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">Failures</span><span class="mtk1"> </span><span class="mtk4">in</span><span class="mtk1"> </span><span class="mtk7">0xe472ba1c00b2ee2b007b4c5788839d6fb7371c6</span><span class="mtk1">::core_staking_test:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">┌── </span><span class="mtk12">test_concurrent_deposits</span><span class="mtk1"> ──────</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span><span class="mtk12">error</span><span class="mtk1">[</span><span class="mtk12">E11001</span><span class="mtk1">]: </span><span class="mtk12">test</span><span class="mtk1"> </span><span class="mtk12">failure</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│      ┌─ ././</span><span class="mtk12">vip</span><span class="mtk1">-</span><span class="mtk12">contract</span><span class="mtk1">/</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">lock_staking</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">1226</span><span class="mtk1">:</span><span class="mtk7">9</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│      │</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span><span class="mtk7">1222</span><span class="mtk1"> │     </span><span class="mtk12">fun</span><span class="mtk1"> </span><span class="mtk11">reentry_check</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│      │         ------------- </span><span class="mtk12">In</span><span class="mtk1"> </span><span class="mtk4">this</span><span class="mtk1"> </span><span class="mtk4">function</span><span class="mtk1"> </span><span class="mtk11">in</span><span class="mtk1"> 0</span><span class="mtk11">xe55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab</span><span class="mtk1">::</span><span class="mtk11">lock_staking</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│      ·</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ 1226 │         </span><span class="mtk11">assert</span><span class="mtk1">!(staking_account.last_height != </span><span class="mtk12">height</span><span class="mtk1">, </span><span class="mtk12">error</span><span class="mtk1">::</span><span class="mtk10">invalid_state</span><span class="mtk1">(</span><span class="mtk10">EREENTER</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│      │         ^^^^^^ </span><span class="mtk12">Test</span><span class="mtk1"> </span><span class="mtk12">was</span><span class="mtk1"> </span><span class="mtk12">not</span><span class="mtk1"> </span><span class="mtk12">expected</span><span class="mtk1"> </span><span class="mtk12">to</span><span class="mtk1"> </span><span class="mtk12">error</span><span class="mtk1">, </span><span class="mtk12">but</span><span class="mtk1"> </span><span class="mtk12">it</span><span class="mtk1"> </span><span class="mtk12">aborted</span><span class="mtk1"> </span><span class="mtk12">with</span><span class="mtk1"> </span><span class="mtk12">code</span><span class="mtk1"> </span><span class="mtk7">196618</span><span class="mtk1"> </span><span class="mtk12">originating</span><span class="mtk1"> </span><span class="mtk4">in</span><span class="mtk1"> </span><span class="mtk12">the</span><span class="mtk1"> </span><span class="mtk10">module</span><span class="mtk1"> </span><span class="mtk12">e55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab</span><span class="mtk1">::</span><span class="mtk12">lock_staking</span><span class="mtk1"> </span><span class="mtk12">rooted</span><span class="mtk1"> </span><span class="mtk12">here</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span><span class="mtk12">stack</span><span class="mtk1"> </span><span class="mtk12">trace</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">lock_staking</span><span class="mtk1">::</span><span class="mtk11">delegate_internal</span><span class="mtk1">(././</span><span class="mtk12">vip</span><span class="mtk1">-</span><span class="mtk12">contract</span><span class="mtk1">/</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">lock_staking</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">715</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">lock_staking</span><span class="mtk1">::</span><span class="mtk11">delegate</span><span class="mtk1">(././</span><span class="mtk12">vip</span><span class="mtk1">-</span><span class="mtk12">contract</span><span class="mtk1">/</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">lock_staking</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">256</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">pool_router</span><span class="mtk1">::</span><span class="mtk11">mock_process_delegate_init</span><span class="mtk1">(./</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">pool_router</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">608</span><span class="mtk1">-</span><span class="mtk7">614</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">pool_router</span><span class="mtk1">::</span><span class="mtk11">mock_add_stake</span><span class="mtk1">(./</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">pool_router</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">630</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">cabal</span><span class="mtk1">::</span><span class="mtk11">mock_deposit_init_for_xinit</span><span class="mtk1">(./</span><span class="mtk12">sources</span><span class="mtk1">/</span><span class="mtk12">cabal</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">1196</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│       </span><span class="mtk12">core_staking_test</span><span class="mtk1">::</span><span class="mtk11">test_concurrent_deposits</span><span class="mtk1">(./</span><span class="mtk12">tests</span><span class="mtk1">/</span><span class="mtk12">core_staking_test</span><span class="mtk1">.</span><span class="mtk12">move</span><span class="mtk1">:</span><span class="mtk7">780</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">│ </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">└──────────────────</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">Test</span><span class="mtk1"> </span><span class="mtk12">result</span><span class="mtk1">: </span><span class="mtk12">FAILED</span><span class="mtk1">. </span><span class="mtk12">Total</span><span class="mtk1"> </span><span class="mtk12">tests</span><span class="mtk1">: </span><span class="mtk7">1</span><span class="mtk1">; </span><span class="mtk12">passed</span><span class="mtk1">: </span><span class="mtk7">0</span><span class="mtk1">; </span><span class="mtk12">failed</span><span class="mtk1">: </span><span class="mtk7">1</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution"><a class="anchor before" aria-label="m 02 unstaking calculates user share at request time ignoring slashing  leading to dos and unfair distribution permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-83">[M-02] Unstaking calculates user share at request time, ignoring slashing — leading to DoS and unfair distribution</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-86">0xAlix2</a>, also found by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-279">adam-idarrha</a>, <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-263">givn</a>, <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-179">maxzuvex</a>, and <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-173">TheSchnilch</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080">https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080</a>
<a href="https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022">https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-1"><a class="anchor before" aria-label="finding description and impact 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description-and-impact-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding Description and Impact</h3>
<p>Users can stake both INIT and LP tokens into different validator pools by calling functions like <code>deposit_init_for_xinit</code> or <code>stake_asset</code>. To exit, users initiate an unstake via <code>initiate_unstake</code>, which starts an unbonding period. After this delay, they can claim their tokens through <code>claim_unbonded_assets</code>.</p>
<p>Behind the scenes, these staked assets are delegated to validators, and slashing may occur—meaning a portion of the delegated tokens could be penalized (burned). To stay accurate, the protocol uses <code>pool_router::get_real_total_stakes</code> to track the current delegated amount. However, the current unstaking flow doesn’t properly account for slashing events that may occur during the unbonding period.</p>
<p>When a user initiates an unstake, either <code>process_lp_unstake</code> or <code>process_xinit_unstake</code> is called. For simplicity, we focus on <code>process_lp_unstake</code>.</p>
<p>In <a href="https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1043C1-L1083C6"><code>process_lp_unstake</code></a>, the claimable amount is calculated up front at unstake time:</p>
<pre data-index="5" data-language="rust" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> reward_amount = </span><span class="mtk11">compound_lp_pool_rewards</span><span class="mtk1">(m_store, unstaking_type);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> lp_amount = reward_amount + pool_router::</span><span class="mtk11">get_real_total_stakes</span><span class="mtk1">(...);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> cabal_lp_amount = option::</span><span class="mtk11">extract</span><span class="mtk1">(...);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> ratio = bigdecimal::</span><span class="mtk11">from_ratio_u128</span><span class="mtk1">(unstake_amount as </span><span class="mtk4">u128</span><span class="mtk1">, cabal_lp_amount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> unbonding_amount = bigdecimal::</span><span class="mtk11">mul_by_u64_truncate</span><span class="mtk1">(ratio, lp_amount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">vector::</span><span class="mtk11">push_back</span><span class="mtk1">(&amp;</span><span class="mtk4">mut</span><span class="mtk1"> cabal_store.unbonding_entries, UnbondingEntry {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    amount: unbonding_amount,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">});</span></span></span></code></pre>
<p>Later, in <a href="https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L711C22-L750"><code>claim_unbonded_assets</code></a>, this precomputed amount is blindly transferred to the user:</p>
<pre data-index="6" data-language="rust" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">primary_fungible_store::</span><span class="mtk11">transfer</span><span class="mtk1">(</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    &amp;package::</span><span class="mtk11">get_assets_store_signer</span><span class="mtk1">(),</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    metadata,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    account_addr,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    amount </span><span class="mtk3">// ← Precomputed at unstake time</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">);</span></span></span></code></pre>
<p>This design introduces a critical flaw: it assumes the pool value remains constant between unstake and claim, which is not guaranteed. If slashing happens during this period:</p>
<ul>
<li>A large user may claim more than the pool holds → DoS</li>
<li>An early user may claim full value post-slash → Other users absorb full loss</li>
</ul>
<p><strong>NB:</strong>
This differs from systems like Lido, where the amount returned is computed at claim time based on the user’s share of the pool, ensuring fair slashing distribution.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-2"><a class="anchor before" aria-label="recommended mitigation steps 2 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended Mitigation Steps</h3>
<p>Instead of locking in the claimable amount at unstake time, store the user’s <strong>percentage share</strong> of the total LP supply. Then, during <code>claim_unbonded_assets</code>, recalculate the actual amount using the current pool value (i.e., post-slash).</p>
<p>This ensures slashing risk is shared proportionally among all stakers, and prevents DoS or overclaiming exploits.</p>
<h3 style="position:relative;" id="proof-of-concept-2"><a class="anchor before" aria-label="proof of concept 2 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p><strong>Case 1 – Whale Unstakes 50%, Then Pool Is Slashed by 51%</strong></p>
<p><strong>Scenario:</strong></p>
<ul>
<li>Total pool value: 1,000 LP tokens</li>
<li>A whale holds 500 LP and unstakes it, expecting to claim 500 units</li>
<li>The remaining users hold the other 500 LP</li>
<li>Before the whale claims, the pool is slashed by 51%, reducing it to 490 units</li>
</ul>
<p><strong>Current behavior (problem):</strong></p>
<ul>
<li>The whale still tries to claim 500 units</li>
<li>The pool only has 490 units left → this would revert, fail, or break accounting</li>
<li>Essentially, the whale locks in a pre-slash value and now the pool can’t fulfill it</li>
</ul>
<p><strong>What should happen:</strong></p>
<ul>
<li>Claim should be recalculated at execution time</li>
<li>500 LP × (490 / 1000) = 245 units</li>
<li>Whale gets 245 units, the rest of the pool reflects that slashing fairly across all holders</li>
</ul>
<p><strong>Case 2 – Early User Unstakes, Pool Slashed, Claims Full Amount</strong></p>
<p><strong>Scenario:</strong></p>
<ul>
<li>Pool has 1,000 LP total</li>
<li>User A holds 100 LP, unstakes and expects 100 units</li>
<li>User B holds 900 LP</li>
<li>A 50% slash hits before User A claims → pool is now worth 500 units</li>
</ul>
<p><strong>Current behavior (problem):</strong></p>
<ul>
<li>User A claims 100 units (based on original rate)</li>
<li>Only 400 units remain for User B’s 900 LP</li>
<li>That means User B absorbs the full impact of the slash — clearly unfair</li>
</ul>
<p><strong>What should happen:</strong></p>
<ul>
<li>Claim is based on current pool state</li>
<li>100 LP × (500 / 1000) = 50 units</li>
<li>User A gets 50 units, User B’s 900 LP is worth 450 → everyone shares the slash proportionally</li>
</ul>
<hr>
<h2 style="position:relative;" id="m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards"><a class="anchor before" aria-label="m 03 attacker can desynchronize supply snapshot during same block unstake reducing everyones rewards permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-125">[M-03] Attacker Can Desynchronize Supply Snapshot During Same-Block Unstake, Reducing Everyone’s Rewards</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-135">maxzuvex</a>, also found by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-117">0xAlix2</a> and <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-177">TheSchnilch</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-2"><a class="anchor before" aria-label="finding description and impact 2 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description-and-impact-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>An attacker holding Cabal LSTs (like sxINIT) can monitor the mempool for the manager’s <code>voting_reward::snapshot()</code> transaction. By submitting his own <code>cabal::initiate_unstake</code> transaction to execute in the <em>same block</em> (<code>H</code>) as the manager’s snapshot, the attacker can use two flaws:</p>
<ol>
<li><code>cabal_token::burn</code> (called by their unstake) doesn’t update the supply snapshot for block <code>H</code>, leaving the recorded supply artificially high (pre-burn).</li>
<li><code>cabal_token::check_snapshot</code> skips recording the attacker’s <em>own</em> balance for block <code>H</code>.
Later reward calculations use the stale high supply but retrieve the attacker’s now lower (post-burn) balance via fallback logic. This desynchronization causes the total calculated reward shares to be less than 100%, reducing the rewards paid out to <em>all</em> users for that cycle.</li>
</ol>
<p><strong>Attacker Exploit:</strong></p>
<ol>
<li><strong>Manager Snapshots Supply:</strong> <code>voting_reward::snapshot</code> triggers <code>cabal_token::snapshot</code>, recording the LST total supply (<code>S₀</code>) for block <code>H</code>.</li>
<li><strong>User Unstakes (Same Block H):</strong> The user calls <code>cabal::initiate_unstake</code>.</li>
<li>Internally, <code>cabal_token::check_snapshot</code> is called but <strong>skips writing</strong> the user’s pre-burn balance for block <code>H</code> due to same-block logic.</li>
<li>The user’s live balance decreases.</li>
<li><code>cabal_token::burn</code> executes, reducing the live supply, but <strong>fails to update</strong> the recorded supply snapshot for <code>H</code> (which remains <code>S₀</code>).</li>
<li><strong>Reward Calculation Uses Inconsistent State:</strong> Later, rewards for cycle <code>H</code> are calculated:</li>
<li><code>get_snapshot_supply(H)</code> returns the stale, <strong>pre-burn <code>S₀</code></strong>.</li>
<li><code>get_snapshot_balance(user, H)</code> finds no user snapshot for <code>H</code> and falls back, returning the user’s <strong>live, post-burn balance</strong>.</li>
<li><strong>Result:</strong> The reward share calculation uses <code>post_burn_balance / pre_burn_supply</code>, causing the sum of all shares to be &lt; 1, thus reducing payouts for everyone. An attacker triggers this by ensuring their <code>initiate_unstake</code> executes in the same block as the manager’s <code>snapshot</code> (e.g., via mempool monitoring).</li>
</ol>
<pre data-index="7" data-language="go" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// 1. In `cabal_token::burn` (called by attacker's `initiate_unstake` in block H)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">public fun </span><span class="mtk11">burn</span><span class="mtk1">(burn_cap: &amp;BurnCapability, fa: FungibleAsset) acquires ManagingRefs, HolderStore, ModuleStore { </span><span class="mtk3">// Added missing acquires for context</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">metadata</span><span class="mtk1"> = burn_cap.metadata;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">metadata_addr</span><span class="mtk1"> = object::</span><span class="mtk11">object_address</span><span class="mtk1">(&amp;metadata);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    assert!(exists&lt;ManagingRefs&gt;(metadata_addr), EMANAGING_REFS_NOT_FOUND);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">refs</span><span class="mtk1"> = borrow_global&lt;ManagingRefs&gt;(metadata_addr);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Burn reduces the LIVE supply</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    fungible_asset::</span><span class="mtk11">burn</span><span class="mtk1">(&amp;refs.burn_ref, fa);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// --- VULNERABILITY PART 1 ---</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ATTACKER EXPLOIT: This function is called in block H AFTER cabal_token::snapshot recorded</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// the supply. However, UNLIKE mint_to, this function DOES NOT check if it's the snapshot</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// block and DOES NOT update the HolderStore::supply_snapshots table for block H.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// The recorded supply for H remains the stale, pre-burn value (S₀).</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">/* Missing logic similar to mint_to:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">        if (is_snapshot_block) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">            update supply_snapshots table with new (lower) supply S₁;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">        }</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">    */</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// 2. In `cabal_token::check_snapshot` (called during attacker's unstake in block H)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">fun </span><span class="mtk11">check_snapshot</span><span class="mtk1">(c_balance: &amp;mut CabalBalance, current_snapshot_block: u64, prev_snapshot_block: Option&lt;u64&gt;) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">current_block_height</span><span class="mtk1"> = block::</span><span class="mtk11">get_current_block_height</span><span class="mtk1">(); </span><span class="mtk3">// Is H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">snapshot_block</span><span class="mtk1"> = current_snapshot_block; </span><span class="mtk3">// is H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// --- VULNERABILITY PART 2 ---</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (current_block_height == current_snapshot_block) { </span><span class="mtk3">// TRUE (H == H)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// ATTACKER EXPLOIT: This condition is met.The logic inside prevents writing</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// the attacker's PRE-BURN balance to their personal snapshot table for block H.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">if</span><span class="mtk1"> (option::</span><span class="mtk11">is_none</span><span class="mtk1">(&amp;prev_snapshot_block)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">            </span><span class="mtk15">return</span><span class="mtk1">; </span><span class="mtk3">// Early return, no write for H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        };</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Tries to write for Previous_H instead, still no write for H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk12">snapshot_block</span><span class="mtk1"> = option::</span><span class="mtk11">extract</span><span class="mtk1">(&amp;mut prev_snapshot_block);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    };</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// The code path that writes `table::add(&amp;mut c_balance.snapshot, key, c_balance.balance)`</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// requires `current_block_height &gt; snapshot_block`, which is FALSE here.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// RESULT: Attacker's balance for H is NOT recorded.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// 3. In `cabal_token::get_snapshot_balance_internal` (called during reward calculation for block H)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    fun </span><span class="mtk11">get_snapshot_balance_internal</span><span class="mtk1">(cabal_balance: &amp;CabalBalance, block_height: u64): u64 { </span><span class="mtk3">// block_height is H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// ... start_block check ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Search attacker's personal table for entry &gt;= H</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">key</span><span class="mtk1"> = table_key::</span><span class="mtk11">encode_u64</span><span class="mtk1">(block_height);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">iter</span><span class="mtk1"> = table::</span><span class="mtk11">iter</span><span class="mtk1">(&amp;cabal_balance.snapshot, option::</span><span class="mtk11">some</span><span class="mtk1">(key), option::</span><span class="mtk11">none</span><span class="mtk1">(), </span><span class="mtk7">2</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// --- VULNERABILITY PART 3 ---</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Because the write was skipped (Vuln Part 2), no entry &gt;= H is found for the attacker.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> (!table::prepare&lt;vector&lt;u8&gt;, u64&gt;(iter)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// ATTACKER EXPLOIT: Fallback logic returns the attacker's LIVE balance.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// At this point (reward calculation time), the live balance is the POST-BURN balance.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> cabal_balance.balance;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    };</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// This part is not reached for the attacker in this scenario</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let (_, balance) = table::</span><span class="mtk11">next</span><span class="mtk1">(iter);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    *balance</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<p><strong>Impact:</strong></p>
<ul>
<li><strong>Invariant violation</strong><br>
The attack breaks the core guarantee <code>Σ balances_H = supply_H</code>. Because the attacker’s balance is recorded <em>after</em> the burn while the supply is recorded <em>before</em>, the numerator shrinks but the denominator stays high.</li>
<li><strong>Universal reward loss</strong><br>
Reward shares now sum to <strong>&lt; 1</strong>, so the bribe contract distributes fewer tokens than were deposited. Every honest staker at snapshot H loses part of their yield; the missing amount remains stranded in the pool.</li>
<li><strong>Direct leverage for the attacker</strong><br>
An exiting holder gives up only their own one‑cycle reward while slashing everyone else’s payout by the same absolute amount. They can repeat the manoeuvre each epoch—or threaten to—creating a zero‑cost grief / extortion vector.</li>
<li><strong>Compromise of a core protocol function</strong><br>
Fair, supply‑proportional bribe distribution is a primary feature of Cabal. Desynchronising balances and supply corrupts that mechanism, undermining trust in the staking programme.</li>
<li><strong>Irreversible cycle corruption</strong><br>
Once the snapshot for block H is polluted, the mis‑distribution for that cycle is permanent. users cannot reclaim the lost bribes without an invasive state migration.</li>
</ul>
<h3 style="position:relative;" id="recommended-mitigation-steps-3"><a class="anchor before" aria-label="recommended mitigation steps 3 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<ol>
<li><strong>Add Supply Update to <code>burn</code>:</strong> Modify <code>cabal_token::burn</code> to check if it’s executing in the same block as a snapshot. If so, update the <code>supply_snapshots</code> table for that block height with the new, lower supply <em>after</em> the burn, mirroring the logic in <code>cabal_token::mint_to</code>.</li>
<li><strong>Fix <code>check_snapshot</code>:</strong> Ensure <code>check_snapshot</code> <em>always</em> writes the user’s pre-interaction balance for the current snapshot block <code>H</code> when needed, removing the logic that skips this write during same-block interactions.</li>
</ol>
<hr>
<h2 style="position:relative;" id="m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds"><a class="anchor before" aria-label="m 04 unstaking from lp pools will cause underflow and lock user funds permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-155">[M-04] Unstaking from LP pools will cause underflow and lock user funds</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-267">givn</a>, also found by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-118">0xAlix2</a>, <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-175">bareli</a>, and <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-280">den-sosnowsky</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420</a></p>
<h3 style="position:relative;" id="description"><a class="anchor before" aria-label="description permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#description"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Description</h3>
<p>When users unstake their LP tokens they call <code>initiate_unstake</code> for the required amount. This creates <code>UnbondingEntry</code> and increases the pending unstake amount - <code>unstaked_pending_amounts[unstaking_type] + unbonding_amount</code>.</p>
<p>At some point an admin (or user) will invoke <code>batch_undelegate_pending_lps()</code>:</p>
<pre data-index="8" data-language="js" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk15">for</span><span class="mtk1"> (</span><span class="mtk12">i</span><span class="mtk1"> </span><span class="mtk4">in</span><span class="mtk1"> </span><span class="mtk7">0.</span><span class="mtk1">.</span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">length</span><span class="mtk1">(&amp;</span><span class="mtk12">m_store</span><span class="mtk1">.</span><span class="mtk12">unbond_period</span><span class="mtk1">)) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// undelegate</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	pool_router::</span><span class="mtk11">unlock</span><span class="mtk1">(</span><span class="mtk12">m_store</span><span class="mtk1">.</span><span class="mtk12">stake_token_metadata</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">], </span><span class="mtk12">m_store</span><span class="mtk1">.</span><span class="mtk12">unstaked_pending_amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">]);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// clear pending</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">m_store</span><span class="mtk1">.</span><span class="mtk12">unstaked_pending_amounts</span><span class="mtk1">[</span><span class="mtk12">i</span><span class="mtk1">] = </span><span class="mtk7">0</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">};</span></span></span></code></pre>
<p>The <code>pool_router::unlock</code> calculates what % of every pool should be undelegated so that the desired LP token amount is reached. This happens by calculating a fraction, iterating over the pools and subtracting an amount equal to that fraction. The issue is that when the <strong>last pool element</strong> is reached, the remaining amount is <strong>all</strong> removed from there:</p>
<pre data-index="9" data-language="js" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">temp_amount</span><span class="mtk1"> = </span><span class="mtk11">if</span><span class="mtk1"> (</span><span class="mtk12">i</span><span class="mtk1"> == </span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">length</span><span class="mtk1">(&amp;</span><span class="mtk12">pools</span><span class="mtk1">) - </span><span class="mtk7">1</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">remain_amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">} </span><span class="mtk12">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">bigdecimal:</span><span class="mtk1">:</span><span class="mtk11">mul_by_u64_truncate</span><span class="mtk1">(</span><span class="mtk12">ratio</span><span class="mtk1">, </span><span class="mtk12">temp_pool</span><span class="mtk1">.</span><span class="mtk12">amount</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">};</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">remain_amount</span><span class="mtk1"> = </span><span class="mtk12">remain_amount</span><span class="mtk1"> - </span><span class="mtk12">temp_amount</span><span class="mtk1">;</span></span></span></code></pre>
<p>This means that if the last pool is empty or with insufficient funds an underflow will occur here:</p>
<pre data-index="10" data-language="js" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">temp_pool</span><span class="mtk1">.</span><span class="mtk12">amount</span><span class="mtk1"> = </span><span class="mtk12">temp_pool</span><span class="mtk1">.</span><span class="mtk12">amount</span><span class="mtk1"> - </span><span class="mtk12">temp_amount</span><span class="mtk1">;</span></span></span></code></pre>
<p>The protocol tries to always fund the pool with least staked tokens by using <code>get_most_underutilized_pool</code>, but this does not prevent situations of imbalance, like:</p>
<ul>
<li>The most underutilized pool receives a very big deposit and dwarfs the rest</li>
<li>New pool is being freshly added </li>
<li>
<p>Users in large numbers withdrawing their funds.
Thus, the subtraction can still underflow in situations that are likely to happen over time.</p>
<h3 style="position:relative;" id="impact-1"><a class="anchor before" aria-label="impact 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#impact-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
</li>
<li>Staked LP tokens can’t be fully withdrawn from protocol.</li>
<li>The amount of funds locked can vary greatly, depending on the stake/unstake &amp; operation patterns. </li>
<li>
<p>Once undelegate amount has been requested it can’t be reduced to try to unlock a smaller amount and get the maximum funds possible. Delegations are locked until someone else deposits.</p>
<h3 style="position:relative;" id="root-cause-1"><a class="anchor before" aria-label="root cause 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#root-cause-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Root Cause</h3>
<p>Trying to withdraw too much from pool when funds are located in other pools.</p>
<h3 style="position:relative;" id="proof-of-concept-3"><a class="anchor before" aria-label="proof of concept 3 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<p>The following code replicates the undelegate calculations of <code>pool_router::unlock</code> and demonstrates that not all the funds can be withdrawn.</p>
</li>
</ul>
<p>Place this test in <code>pool_router.move</code>. Run it with <code>yarn run test- test_unlock_lp_amounts</code>.</p>
<pre data-index="11" data-language="js" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">#[</span><span class="mtk12">test</span><span class="mtk1">, </span><span class="mtk11">expected_failure</span><span class="mtk1">()]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">public</span><span class="mtk1"> </span><span class="mtk12">fun</span><span class="mtk1"> </span><span class="mtk11">test_unlock_lp_amounts</span><span class="mtk1">() {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">unlock_amount</span><span class="mtk1"> = 2</span><span class="mtk12">_000_000u64</span><span class="mtk1">; </span><span class="mtk3">// Unlock LP</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">pools</span><span class="mtk1"> = </span><span class="mtk12">vector</span><span class="mtk1">[ </span><span class="mtk3">// LP staked in each pool</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk7">20_000_000</span><span class="mtk1">, </span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk7">20_000_000</span><span class="mtk1">,</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk7">10_000</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk4">let</span><span class="mtk1"> </span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk7">20</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">loop</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		debug::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">"Begin undelegation round"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk12">pools</span><span class="mtk1"> = </span><span class="mtk11">calculate_undelegates</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">, </span><span class="mtk12">unlock_amount</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk12">i</span><span class="mtk1"> = </span><span class="mtk12">i</span><span class="mtk1"> - </span><span class="mtk7">1</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		debug::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">""</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk15">if</span><span class="mtk1">(</span><span class="mtk12">i</span><span class="mtk1"> == </span><span class="mtk7">0</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">			</span><span class="mtk15">break</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	};</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// Pool amounts after last iteration</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// [debug] "New pool stake amounts"</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// [debug] 4500</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// [debug] 4500</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// [debug] 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk3">// Now we continue undelegating smaller amounts, but action will underflow</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	debug::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">" ---- Undelegate smaller amount #1 ---- "</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">pools</span><span class="mtk1"> = </span><span class="mtk11">calculate_undelegates</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">, </span><span class="mtk7">1_000</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	debug::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">" ---- Undelegate smaller amount #2 ---- "</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">pools</span><span class="mtk1"> = </span><span class="mtk11">calculate_undelegates</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">, </span><span class="mtk7">1_000</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">/// Simplified version of pool_router::unlock_lp</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">#[</span><span class="mtk12">test_only</span><span class="mtk1">]</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk12">fun</span><span class="mtk1"> </span><span class="mtk11">calculate_undelegates</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">: </span><span class="mtk12">vector</span><span class="mtk1">&lt;</span><span class="mtk12">u64</span><span class="mtk1">&gt;, </span><span class="mtk12">unlock_amount</span><span class="mtk1">: </span><span class="mtk12">u64</span><span class="mtk1">): </span><span class="mtk12">vector</span><span class="mtk1">&lt;</span><span class="mtk12">u64</span><span class="mtk1">&gt; {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	let </span><span class="mtk12">pools_length</span><span class="mtk1"> = </span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">length</span><span class="mtk1">(&amp;</span><span class="mtk12">pools</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	let </span><span class="mtk12">total_stakes</span><span class="mtk1"> = </span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">fold</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">, 0</span><span class="mtk12">u64</span><span class="mtk1">, |</span><span class="mtk12">acc</span><span class="mtk1">, </span><span class="mtk12">elem</span><span class="mtk1">| </span><span class="mtk12">acc</span><span class="mtk1"> + </span><span class="mtk12">elem</span><span class="mtk1">); </span><span class="mtk3">// LP staked in across all pools</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	let </span><span class="mtk12">remain_amount:</span><span class="mtk1"> </span><span class="mtk12">u64</span><span class="mtk1"> = </span><span class="mtk12">unlock_amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">let</span><span class="mtk1"> </span><span class="mtk12">ratio</span><span class="mtk1"> = </span><span class="mtk12">bigdecimal</span><span class="mtk1">::</span><span class="mtk11">from_ratio_u64</span><span class="mtk1">(</span><span class="mtk12">unlock_amount</span><span class="mtk1">, </span><span class="mtk12">total_stakes</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">debug</span><span class="mtk1">::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">"Total staked before undelegate"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">debug</span><span class="mtk1">::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">total_stakes</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">assert</span><span class="mtk1">!(</span><span class="mtk12">total_stakes</span><span class="mtk1"> &gt;= </span><span class="mtk12">unlock_amount</span><span class="mtk1">, </span><span class="mtk7">1000777</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk11">for</span><span class="mtk1"> (</span><span class="mtk12">i</span><span class="mtk1"> </span><span class="mtk4">in</span><span class="mtk1"> </span><span class="mtk7">0.</span><span class="mtk1">.</span><span class="mtk12">pools_length</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		let </span><span class="mtk12">pool_stake</span><span class="mtk1"> = </span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">borrow_mut</span><span class="mtk1">(&amp;</span><span class="mtk12">mut</span><span class="mtk1"> </span><span class="mtk12">pools</span><span class="mtk1">, </span><span class="mtk12">i</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		let </span><span class="mtk12">undelegate_amount</span><span class="mtk1"> = </span><span class="mtk11">if</span><span class="mtk1"> (</span><span class="mtk12">i</span><span class="mtk1"> == </span><span class="mtk12">pools_length</span><span class="mtk1"> - </span><span class="mtk7">1</span><span class="mtk1">) {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">			</span><span class="mtk12">remain_amount</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		} </span><span class="mtk12">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">			</span><span class="mtk12">bigdecimal:</span><span class="mtk1">:</span><span class="mtk11">mul_by_u64_truncate</span><span class="mtk1">(</span><span class="mtk12">ratio</span><span class="mtk1">, *</span><span class="mtk12">pool_stake</span><span class="mtk1">)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		};</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk12">remain_amount</span><span class="mtk1"> = </span><span class="mtk12">remain_amount</span><span class="mtk1"> - </span><span class="mtk12">undelegate_amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk3">// Update state tracking</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		*</span><span class="mtk12">pool_stake</span><span class="mtk1"> = *</span><span class="mtk12">pool_stake</span><span class="mtk1"> - </span><span class="mtk12">undelegate_amount</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	};</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">debug</span><span class="mtk1">::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">"New pool stake amounts"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">let</span><span class="mtk1"> </span><span class="mtk12">total_staked_after_undelegate</span><span class="mtk1"> = </span><span class="mtk12">vector</span><span class="mtk1">::</span><span class="mtk11">fold</span><span class="mtk1">(</span><span class="mtk12">pools</span><span class="mtk1">, 0</span><span class="mtk12">u64</span><span class="mtk1">, |</span><span class="mtk12">acc</span><span class="mtk1">, </span><span class="mtk12">elem</span><span class="mtk1">| {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk12">debug:</span><span class="mtk1">:</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">elem</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">		</span><span class="mtk12">acc</span><span class="mtk1"> + </span><span class="mtk12">elem</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	});</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">debug</span><span class="mtk1">::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">string</span><span class="mtk1">::</span><span class="mtk11">utf8</span><span class="mtk1">(</span><span class="mtk12">b</span><span class="mtk8">"Total staked after undelegate"</span><span class="mtk1">));</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">debug</span><span class="mtk1">::</span><span class="mtk11">print</span><span class="mtk1">(&amp;</span><span class="mtk12">total_staked_after_undelegate</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">	</span><span class="mtk12">pools</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">}</span></span></span></code></pre>
<h3 style="position:relative;" id="recommended-mitigation-steps-4"><a class="anchor before" aria-label="recommended mitigation steps 4 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Instead of doing one iteration over the pools and subtracting the remaining amount from the last one, use an loop and modulo arithmetic to iterate multiple times and subtract any possible remaining amounts from the other pools.</p>
<p>Separate undelegate amount calculation from the <code>stargate</code> calls so that multiple <code>MsgUndelegate</code> messages are not sent for the same validator.</p>
<hr>
<h2 style="position:relative;" id="m-05-last-holder-cant-exit-zerosupply-unstake-reverts"><a class="anchor before" aria-label="m 05 last holder cant exit zerosupply unstake reverts permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-05-last-holder-cant-exit-zerosupply-unstake-reverts"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-157">[M-05] Last Holder Can’t Exit, Zero‑Supply Unstake Reverts</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-178">maxzuvex</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998</a></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053</a></p>
<h3 style="position:relative;" id="finding-description-and-impact-3"><a class="anchor before" aria-label="finding description and impact 3 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description-and-impact-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding description and impact</h3>
<p>When a user burns the <strong>entire remaining supply</strong> of a Cabal LST ( sxINIT or Cabal LPT) via <code>initiate_unstake</code>, the follow‑up processing step always aborts with a divide‑by‑zero and the user can never exit.</p>
<ol>
<li><strong>User calls <code>initiate_unstake(stake_type, S)</code> – S equals the whole supply.</strong></li>
<li><code>unstake_xinit</code> / <code>unstake_lp</code> queues <code>process_*_unstake</code> with <code>cosmos::move_execute( … "process_xinit_unstake" | "process_lp_unstake" … )</code> for next transaction.</li>
<li><strong>After queuing</strong>, <code>initiate_unstake</code> burns the LST: <code>cabal_token::burn(S)</code> ⇒ live supply becomes <strong>0</strong>.</li>
<li>Transaction 1 finishes and state now shows <code>supply = 0</code>, <code>pending[i] = S</code>.</li>
<li><strong>Later, Transaction 2 executes <code>process_*_unstake</code>.</strong></li>
<li>Calls <code>compound_*_pool_rewards</code> (does not change LST supply).</li>
<li>Reads the current LST supply: <code>sx_supply = fungible_asset::supply(meta)</code> ⇒ <strong>0</strong>.</li>
<li>Calculates <code>ratio = bigdecimal::from_ratio_u128(unstake_amount, sx_supply)</code> which triggers <code>assert!(denominator != 0)</code> → <strong><code>EDIVISION_BY_ZERO</code> abort</strong>.</li>
</ol>
<p>Because the burn happened in a prior committed transaction, every retry of <code>process_*_unstake</code> gets the same <code>supply == 0</code> state and fails again, so the user’s INIT / LP is permanently locked and it makes a DoS for the final staker of that pool.</p>
<pre data-index="12" data-language="go" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// Simplified logic from process_xinit_unstake</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    entry fun </span><span class="mtk11">process_xinit_unstake</span><span class="mtk1">(account: &amp;signer, staker_addr: address, unstaking_type: u64, unstake_amount: u64) acquires ModuleStore, CabalStore, LockExempt {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// ... permission checks, reward compounding ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        let </span><span class="mtk12">m_store</span><span class="mtk1"> = borrow_global_mut&lt;ModuleStore&gt;(@staking_addr);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        let </span><span class="mtk12">x_init_amount</span><span class="mtk1"> = m_store.staked_amounts[unstaking_type];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// --- VULNERABILITY ---</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// 'unstake_amount' is the original amount burned (== total supply in this case).</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// 'sx_init_amount' reads the supply *after* the burn in initiate_unstake, so it's 0.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        let </span><span class="mtk12">sx_init_amount</span><span class="mtk1"> = option::</span><span class="mtk11">extract</span><span class="mtk1">(&amp;mut fungible_asset::</span><span class="mtk11">supply</span><span class="mtk1">(m_store.cabal_stake_token_metadata[unstaking_type])); </span><span class="mtk3">// Returns 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// This attempts bigdecimal::from_ratio_u128(S, 0) --&gt; Division by Zero!</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        let </span><span class="mtk12">ratio</span><span class="mtk1"> = bigdecimal::</span><span class="mtk11">from_ratio_u128</span><span class="mtk1">(unstake_amount as u128, sx_init_amount);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// Transaction reverts here.</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">        </span><span class="mtk3">// ... rest of function is unreachable ...</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    }</span></span></span></code></pre>
<p><strong>Impact:</strong></p>
<p>If an address burns the last sxINIT / LPT in circulation, every call to <code>process_*_unstake</code> reverts with <code>EDIVISION_BY_ZERO</code>, so no <code>UnbondingEntry</code> is recorded and the underlying INIT / LP can never be claimed. The final staker’s funds are permanently locked and causes a pool‑level denial of service.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-5"><a class="anchor before" aria-label="recommended mitigation steps 5 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>In <code>process_xinit_unstake</code> and <code>process_lp_unstake</code>:</p>
<pre data-index="13" data-language="go" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">let </span><span class="mtk12">pool_before</span><span class="mtk1"> = m_store.staked_amounts[pool];</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">let </span><span class="mtk12">supply</span><span class="mtk1">      = fungible_asset::</span><span class="mtk11">supply</span><span class="mtk1">(meta);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">let </span><span class="mtk12">unbond</span><span class="mtk1"> = </span><span class="mtk15">if</span><span class="mtk1"> supply == </span><span class="mtk7">0</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    </span><span class="mtk3">// last holder – give them the entire pool</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    pool_before</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">} </span><span class="mtk15">else</span><span class="mtk1"> {</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    let </span><span class="mtk12">r</span><span class="mtk1"> = bigdecimal::</span><span class="mtk11">from_ratio_u128</span><span class="mtk1">(unstake_amount, supply);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">    bigdecimal::</span><span class="mtk11">mul_by_u64_truncate</span><span class="mtk1">(r, pool_before)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">};</span></span></span></code></pre>
<ul>
<li>Guard against <code>supply == 0</code>.</li>
<li>If it’s the final unstake, transfer the whole remaining pool; otherwise keep the original ratio logic.</li>
</ul>
<h3 style="position:relative;" id="proof-of-concept-4"><a class="anchor before" aria-label="proof of concept 4 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept-4"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<pre data-index="14" data-language="go" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// Assume pool index 1 is an LP‑staking pool</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">let pool_idx: </span><span class="mtk12">u64</span><span class="mtk1"> = </span><span class="mtk7">1</span><span class="mtk1">;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// ── step 1: mint exactly 1 Cabal‑LPT to Alice ───────────────────────────</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">let </span><span class="mtk12">mint_cap</span><span class="mtk1"> = &amp;ModuleStore.cabal_stake_token_caps[pool_idx].mint_cap;</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">cabal_token::</span><span class="mtk11">mint_to</span><span class="mtk1">(mint_cap, @alice, </span><span class="mtk7">1</span><span class="mtk1">);          </span><span class="mtk3">// total supply = 1</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// ── step 2: Alice initiates unstake of the ENTIRE supply ────────────────</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">cabal::</span><span class="mtk11">initiate_unstake</span><span class="mtk1">(&amp;</span><span class="mtk11">signer</span><span class="mtk1">(@alice), pool_idx, </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">/*</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * inside initiate_unstake:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *   • cabal_token::burn(1)            → total supply becomes 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *   • schedules process_lp_unstake()  (async)</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> */</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">// ── step 3: worker executes queued call ──────────────────────────────────</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk1">cabal::</span><span class="mtk11">process_lp_unstake</span><span class="mtk1">(&amp;assets_signer, @alice, pool_idx, </span><span class="mtk7">1</span><span class="mtk1">);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3">/*</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * inside process_lp_unstake:</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *   let sx_supply = fungible_asset::supply(lp_metadata);   // == 0</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *   let ratio     = bigdecimal::from_ratio_u128(1, sx_supply);</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *                         └────── divide‑by‑zero → abort</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> *</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> * transaction reverts with EZeroDenominator</span></span></span>
<span class="grvsc-line"><span class="grvsc-source"><span class="mtk3"> */</span></span></span></code></pre>
<hr>
<h2 style="position:relative;" id="m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds"><a class="anchor before" aria-label="m 06 lp redelegation uses inaccurate internal tracker amount leading to potential failures or orphaned funds permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-185">[M-06] LP Redelegation Uses Inaccurate Internal Tracker Amount, Leading to Potential Failures or Orphaned Funds</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-213">edoscoba</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339</a></p>
<h3 style="position:relative;" id="summary-1"><a class="anchor before" aria-label="summary 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#summary-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Summary</h3>
<p>The <code>redelegate_lp</code> function, called during validator changes for LP pools, uses the internal <code>pool.amount</code> tracker to specify the amount for <code>MsgBeginRedelegate</code>. This tracker can diverge from the actual staked amount due to unreflected rewards or slashing, potentially causing redelegation failures or leaving funds staked with the old validator.</p>
<h3 style="position:relative;" id="finding-description-1"><a class="anchor before" aria-label="finding description 1 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#finding-description-1"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Finding Description</h3>
<p>The <code>pool_router::change_validator</code> function allows the deployer (<code>@staking_addr</code>) to migrate staked assets managed by a specific <code>StakePool</code> object from one validator to another. For LP token pools, it calls the internal helper function <code>redelegate_lp</code> located in <a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339">pool_router.move#L327-L339</a>.</p>
<p>The <code>redelegate_lp</code> function constructs a <code>MsgBeginRedelegate</code> message to be sent via <code>cosmos::stargate</code>. The amount of tokens to be redelegated in this message is taken directly from the <code>pool.amount</code> field of the <code>StakePool</code> resource:</p>
<pre data-index="15" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">    fun redelegate_lp(pool: &amp;StakePool, new_validator_address: String) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let denom = coin::metadata_to_denom(pool.metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let coin = Coin { denom, amount: pool.amount }; // &lt;&lt;&lt; Uses pool.amount</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        let msg = MsgBeginRedelegate {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            // ... other fields ...</span></span>
<span class="grvsc-line"><span class="grvsc-source">            amount: vector[coin] // &lt;&lt;&lt; Amount specified in the message</span></span>
<span class="grvsc-line"><span class="grvsc-source">        };</span></span>
<span class="grvsc-line"><span class="grvsc-source">        cosmos::stargate(&amp;object::generate_signer_for_extending(&amp;pool.ref), marshal(&amp;msg));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span></code></pre>
<p>However, the <code>pool.amount</code> is merely an internal counter updated by <code>pool_router::add_stake</code> and <code>pool_router::unstake</code> and <code>pool_router::unlock_lp</code>. It does not automatically reflect changes in the actual staked balance within the underlying <code>mstaking</code> module due to:</p>
<ol>
<li><strong>Accrued Rewards:</strong> Rewards earned by the staked LP tokens increase the actual delegation shares/amount but are not reflected in <code>pool.amount</code> until <code>compound_lp_pool_rewards</code> runs (triggered by user actions) and subsequently calls <code>add_stake</code>.</li>
<li><strong>Slashing</strong>: If the validator is slashed, the actual delegation shares/amount decreases, but <code>pool.amount</code> is never updated to reflect this loss.</li>
</ol>
<p>Therefore, <code>pool.amount</code> can easily drift from the true staked amount. Sending a <code>MsgBeginRedelegate</code> with this potentially inaccurate amount breaks the expectation that the administrative function correctly manages the entirety of the funds associated with the <code>StakePool</code> object.</p>
<h3 style="position:relative;" id="impact-2"><a class="anchor before" aria-label="impact 2 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#impact-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>Using an inaccurate amount in <code>MsgBeginRedelegate</code> leads to two primary negative outcomes:</p>
<ol>
<li><strong>Redelegation Failure</strong>:If <code>pool.amount</code> is greater than the actual staked amount (e.g., due to slashing), the underlying <code>mstaking</code> module will reject the request, causing the <code>cosmos::stargate</code>  call and the entire <code>change_validator</code> transaction to abort. This prevents the deployer from migrating funds away from a potentially slashed or undesirable validator.</li>
<li><strong>Partial Redelegation / Orphaned Funds:</strong> If <code>pool.amount</code> is less than the actual staked amount (e.g., due to accrued rewards not yet reflected), the <code>mstaking</code> module will likely succeed in redelegating only the specified <code>pool.amount</code>. The remaining tokens (the difference) will be left staked with the original validator. However, the <code>change_validator</code> function proceeds to update <code>pool.validator</code> to the new address. This creates an inconsistent state where the <code>StakePool</code> object points to the new validator, but some funds remain with the old one, potentially becoming difficult to track, manage, or withdraw through the router’s standard logic.</li>
</ol>
<h3 style="position:relative;" id="likelihood"><a class="anchor before" aria-label="likelihood permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#likelihood"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Likelihood</h3>
<p>The likelihood of <code>pool.amount</code> becoming inaccurate is <strong>High</strong>. Staking rewards are expected to accrue over time. If users don’t frequently stake or unstake from a specific LP pool, the <code>compound_lp_pool_rewards</code> function won’t run often, causing <code>pool.amount</code> to lag behind the actual staked amount (actual &gt; tracker). Slashing events, while less frequent, would cause the tracker to exceed the actual amount. </p>
<p>Therefore, drift between <code>pool.amount</code> and the real staked value is highly likely. The likelihood of this drift causing a problem during a <code>change_validator</code> call is <strong>Medium</strong>, as it depends on when the deployer chooses to execute this administrative action relative to the drift.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-6"><a class="anchor before" aria-label="recommended mitigation steps 6 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-6"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p>Modify the <code>redelegate_lp</code> function to query the actual delegation amount from the underlying <code>mstaking</code> module before constructing the <code>MsgBeginRedelegate</code> message. This can be done using a <code>query_stargate</code> call similar to the one used in <code>get_lp_real_stakes</code>. Use this queried, accurate amount instead of <code>pool.amount</code>.</p>
<p>Apply the following conceptual change (exact query path and response parsing might need adjustment based on Initia’s <code>mstaking</code> module specifics) to <a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339">pool_router.move#L327-L339</a>:</p>
<pre data-index="16" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">     fun redelegate_lp(pool: &amp;StakePool, new_validator_address: String) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">         let denom = coin::metadata_to_denom(pool.metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">-        let coin = Coin { denom, amount: pool.amount };</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let pool_addr = object::address_from_extend_ref(&amp;pool.ref);</span></span>
<span class="grvsc-line"><span class="grvsc-source"> </span></span>
<span class="grvsc-line"><span class="grvsc-source">+        // Query the actual staked amount instead of relying on the internal tracker</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let path = b"/initia.mstaking.v1.Query/Delegation"; // Adjust path if needed</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let request = DelegationRequest { validator_addr: pool.validator, delegator_addr: address::to_sdk(pool_addr) };</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let response_bytes = query_stargate(path, marshal(&amp;request));</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        // Note: Need robust parsing and error handling for the query response here.</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        // Assuming successful query and parsing to get the actual_staked_amount:</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let actual_staked_amount = parse_delegation_response_amount(response_bytes, denom); // Placeholder for parsing logic</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        assert!(actual_staked_amount &gt; 0, error::invalid_state(0)); // Add appropriate error code</span></span>
<span class="grvsc-line"><span class="grvsc-source">+</span></span>
<span class="grvsc-line"><span class="grvsc-source">+        let coin = Coin { denom, amount: actual_staked_amount }; // Use the queried amount</span></span>
<span class="grvsc-line"><span class="grvsc-source">         let msg = MsgBeginRedelegate {</span></span>
<span class="grvsc-line"><span class="grvsc-source">             _type_: string::utf8(b"/initia.mstaking.v1.MsgBeginRedelegate"),</span></span>
<span class="grvsc-line"><span class="grvsc-source">             delegator_address: to_sdk(object::address_from_extend_ref(&amp;pool.ref)),</span></span></code></pre>
<p>(Note: The <code>parse_delegation_response_amount</code> function is illustrative; the actual implementation would involve using <code>unmarshal</code> and navigating the <code>DelegationResponse</code> struct as done in <code>get_lp_real_stakes</code> to extract the correct amount for the given denom.)</p>
<h3 style="position:relative;" id="proof-of-concept-5"><a class="anchor before" aria-label="proof of concept 5 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#proof-of-concept-5"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Proof of Concept</h3>
<ol>
<li><strong>Setup:</strong> Configure an LP pool using <code>add_pool</code>. Stake some LP tokens via <code>cabal::stake_asset</code> (which calls <code>pool_router::add_stake</code>), setting <code>pool.amount</code> to, say, 1,000,000.</li>
<li><strong>Scenario 1 (Rewards Accrued):</strong> Assume rewards accrue in the underlying <code>mstaking</code> module, increasing the actual staked amount to 1,050,000, but no user actions trigger compounding, so <code>pool.amount</code> remains 1,000,000.</li>
<li><strong>Action:</strong> The deployer calls <code>change_validator</code> for this pool. <code>redelegate_lp</code> is called.</li>
<li><strong>Execution:</strong> <code>redelegate_lp</code> constructs <code>MsgBeginRedelegate</code> with <code>amount = 1,000,000</code>.</li>
<li><strong>Outcome:</strong> The <code>mstaking</code> module successfully redelegates 1,000,000 tokens. 50,000 tokens remain staked with the old validator. <code>change_validator</code> updates <code>pool.validator</code> to the new address. The 50,000 tokens are now potentially orphaned from the router’s perspective.</li>
<li><strong>Scenario 2 (Slashing Occurred):</strong> Assume the validator was slashed, reducing the actual staked amount to 950,000, but <code>pool.amount</code> remains 1,000,000.</li>
<li><strong>Action:</strong> The deployer calls <code>change_validator</code>. <code>redelegate_lp</code> is called.</li>
<li><strong>Execution:</strong> <code>reredelegate_lp</code> constructs <code>MsgBeginRedelegate</code> with <code>amount = 1,000,000</code>.</li>
<li><strong>Outcome:</strong> The <code>mstaking</code> module rejects the request because only 950,000 tokens are available. The <code>cosmos::stargate</code> call fails, causing the <code>change_validator</code> transaction to abort. The validator cannot be changed.</li>
</ol>
<hr>
<h2 style="position:relative;" id="m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens"><a class="anchor before" aria-label="m 07 desynchronization of cabals internal accounting with actual staked init amounts leads to over minting of sxinit tokens permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a><a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-252">[M-07] Desynchronization of Cabal’s internal accounting with actual staked INIT amounts leads to over-minting of sxINIT tokens</a></h2>
<p><em>Submitted by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-108">ChainSentry</a>, also found by <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-235">Afriauditor</a>, <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-262">givn</a>, and <a href="https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-18">maze</a></em></p>
<p><a href="https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796">https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796</a></p>
<h3 style="position:relative;" id="summary-2"><a class="anchor before" aria-label="summary 2 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#summary-2"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Summary</h3>
<p>The Cabal Protocol’s implementation of <code>compound_xinit_pool_rewards</code> fails to synchronize the protocol’s internal accounting (<code>m_store.staked_amounts</code>) with the actual amount of INIT tokens staked in the underlying Initia staking system. This creates a vulnerability where external events like slashing penalties or validator-initiated actions that reduce the staked amount are not reflected in Cabal’s internal state. The reward compounding function simply adds claimed rewards to its internal tracking variable without verifying that this matches reality, creating a divergence between what Cabal thinks is staked and what actually is staked. When slashing occurs, users who stake xINIT will receive more sxINIT than they should based on the actual backing ratio. This leads to economic dilution of all sxINIT holders.</p>
<p>This issue is particularly concerning because it compounds over time - each slashing event that goes unaccounted for widens the gap between reported and actual values, eventually leading to significant economic damage for the protocol and its users.</p>
<p><strong>Technical Explanation</strong></p>
<p>The core issue lies in the <code>compound_xinit_pool_rewards</code> function in <code>cabal.move</code>, which is responsible for claiming staking rewards and updating the protocol’s internal state:</p>
<pre data-index="17" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">fun compound_xinit_pool_rewards(m_store: &amp;mut ModuleStore, pool_index: u64) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let coin_metadata = coin::metadata(@initia_std, string::utf8(b"uinit"));</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let reward_fa = pool_router::withdraw_rewards(coin_metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let reward_amount = fungible_asset::amount(&amp;reward_fa);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    if (reward_amount &gt; 0) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        // calculate fee amount</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let fee_ratio = bigdecimal::from_ratio_u64(m_store.xinit_stake_reward_fee_bps, BPS_BASE);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let fee_amount = bigdecimal::mul_by_u64_truncate(fee_ratio, reward_amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let fee_fa = fungible_asset::extract(&amp;mut reward_fa, fee_amount);</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let rewards_remaining = reward_amount - fee_amount;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        primary_fungible_store::deposit(package::get_commission_fee_store_address(), fee_fa);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        m_store.stake_reward_amounts[pool_index] = m_store.stake_reward_amounts[pool_index] + rewards_remaining;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        pool_router::add_stake(reward_fa);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">        // mint xINIT to pool</span></span>
<span class="grvsc-line"><span class="grvsc-source">        m_store.staked_amounts[pool_index] = m_store.staked_amounts[pool_index] + rewards_remaining;</span></span>
<span class="grvsc-line"><span class="grvsc-source">        coin::mint_to(&amp;m_store.x_init_caps.mint_cap, package::get_assets_store_address(), rewards_remaining);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    } else {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        fungible_asset::destroy_zero(reward_fa);</span></span>
<span class="grvsc-line"><span class="grvsc-source">    }</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
<p>The issue occurs because this function:</p>
<ol>
<li>Claims rewards from the staking system via <code>pool_router::withdraw_rewards</code></li>
<li>Processes these rewards and restakes them via <code>pool_router::add_stake</code></li>
<li>Updates <code>m_store.staked_amounts[pool_index]</code> by simply adding the rewards amount</li>
<li>Never verifies that this updated value matches the actual staked amount in the underlying system</li>
</ol>
<p>However, the protocol has a function <code>pool_router::get_real_total_stakes</code> that does query the actual staked amount from the Initia staking system:</p>
<pre data-index="18" data-language="move" class="grvsc-container dark-default-dark"><code class="grvsc-code"><span class="grvsc-line"><span class="grvsc-source">// From pool_router.move</span></span>
<span class="grvsc-line"><span class="grvsc-source">pub fun get_real_total_stakes(metadata: Object&lt;Metadata&gt;): u64 {</span></span>
<span class="grvsc-line"><span class="grvsc-source">    // Sum up all stake amounts from the underlying staking system</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let total_stakes: u64 = 0;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    /* ... */</span></span>
<span class="grvsc-line"><span class="grvsc-source">    let pools = *simple_map::borrow(&amp;router.token_pool_map, &amp;metadata);</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    for (i in 0..vector::length(&amp;pools)) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">        let amount = if (metadata == utils::get_init_metadata()) {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            get_init_real_stakes(&amp;pools[i])</span></span>
<span class="grvsc-line"><span class="grvsc-source">        } else {</span></span>
<span class="grvsc-line"><span class="grvsc-source">            get_lp_real_stakes(&amp;pools[i])</span></span>
<span class="grvsc-line"><span class="grvsc-source">        };</span></span>
<span class="grvsc-line"><span class="grvsc-source">        total_stakes = total_stakes + amount;</span></span>
<span class="grvsc-line"><span class="grvsc-source">    };</span></span>
<span class="grvsc-line"><span class="grvsc-source"></span></span>
<span class="grvsc-line"><span class="grvsc-source">    total_stakes</span></span>
<span class="grvsc-line"><span class="grvsc-source">}</span></span></code></pre>
<p>This function is never called during reward compounding, leading to the desynchronization.</p>
<p><strong>The following scenario demonstrates how this vulnerability can lead to over-minting of sxINIT tokens:</strong></p>
<ol>
<li>
<p>Initial state:</p>
<ul>
<li>1,000,000,000 INIT staked in the Initia staking system</li>
<li><code>m_store.staked_amounts[0]</code> = 1,000,000,000</li>
<li>Total sxINIT supply = 1,000,000,000</li>
</ul>
</li>
<li>
<p>A slashing event occurs in the Initia staking system, reducing the staked INIT by 5%:</p>
<ul>
<li>Actual staked INIT = 950,000,000</li>
<li><code>m_store.staked_amounts[0]</code> still = 1,000,000,000 (unchanged)</li>
</ul>
</li>
<li>
<p>Rewards of 50,000,000 INIT are claimed via <code>compound_xinit_pool_rewards</code>:</p>
<ul>
<li>Function adds 50,000,000 to <code>m_store.staked_amounts[0]</code>, making it 1,050,000,000</li>
<li>Actual staked INIT after adding rewards = 1,000,000,000 (950,000,000 + 50,000,000)</li>
</ul>
</li>
<li>
<p>User comes to stake 100,000,000 xINIT:</p>
<ul>
<li>According to Cabal’s accounting: Exchange rate = 1,050,000,000 INIT / 1,000,000,000 sxINIT = 1.05</li>
<li>User should receive: 100,000,000 / 1.05 = 95,238,095 sxINIT</li>
<li>But the actual exchange rate should be: 1,000,000,000 INIT / 1,000,000,000 sxINIT = 1.0</li>
<li>User should actually receive: 100,000,000 / 1.0 = 100,000,000 sxINIT</li>
</ul>
</li>
<li>
<p>The discrepancy:</p>
<ul>
<li>User receives 95,238,095 sxINIT</li>
<li>These tokens are backed by only 90,702,948 INIT (95,238,095 * 1,000,000,000 / 1,050,000,000)</li>
<li>This means the user has been short-changed by 4,761,905 INIT worth of backing</li>
</ul>
</li>
</ol>
<p>The issue becomes even more severe with multiple slashing events and/or larger stake amounts.</p>
<h3 style="position:relative;" id="impact-3"><a class="anchor before" aria-label="impact 3 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#impact-3"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Impact</h3>
<p>The impact of this vulnerability is significant and affects multiple areas:</p>
<ol>
<li><strong>Violation of Core Protocol Invariants</strong>: The fundamental invariant <code>1 xINIT ≈ 1 INIT</code> is broken. This undermines the entire economic model of the protocol as described in the documentation.</li>
<li><strong>Economic Dilution</strong>: When new users stake xINIT and receive sxINIT based on incorrect exchange rates, they get fewer tokens than they should. This effectively transfers value from new users to existing sxINIT holders.</li>
<li>
<p><strong>Systemic Risk</strong>: Each uncorrected slashing event compounds the problem. Over time, the divergence between tracked and actual amounts could become severe, potentially leading to:</p>
<ul>
<li>Loss of user confidence in the protocol</li>
<li>Inability to properly value sxINIT tokens</li>
<li>Difficulty in integrating with other DeFi protocols due to unreliable pricing</li>
</ul>
</li>
<li><strong>Unbonding Issues</strong>: When users try to unstake their sxINIT tokens, they might not receive the expected amount of xINIT back, leading to unexpected losses.</li>
</ol>
<p>This issue affects all users of the Cabal Protocol, with the severity increasing over time as more slashing events occur without correction.</p>
<h3 style="position:relative;" id="recommended-mitigation-steps-7"><a class="anchor before" aria-label="recommended mitigation steps 7 permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#recommended-mitigation-steps-7"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Recommended mitigation steps</h3>
<p><strong>Sync with Reality</strong>: Modify the <code>compound_xinit_pool_rewards</code> function to query the actual staked amounts after claiming rewards.</p>
<hr>
<h1 style="position:relative;" id="disclosures"><a class="anchor before" aria-label="disclosures permalink" href="https://code4rena.com/reports/2025-04-cabal-liquid-staking-token#disclosures"><svg width="16" viewBox="0 0 16 16" version="1.1" height="16" aria-hidden="true"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Disclosures</h1>
<p>C4 is an open organization governed by participants in the community.</p>
<p>C4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.</p>
<p>C4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.</p>
<style class="grvsc-styles">
  .grvsc-container {
    overflow: auto;
    position: relative;
    -webkit-overflow-scrolling: touch;
    padding-top: 1rem;
    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));
    padding-bottom: 1rem;
    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));
    border-radius: 8px;
    border-radius: var(--grvsc-border-radius, 8px);
    font-feature-settings: normal;
    line-height: 1.4;
  }
  
  .grvsc-code {
    display: table;
  }
  
  .grvsc-line {
    display: table-row;
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }
  
  .grvsc-line > * {
    position: relative;
  }
  
  .grvsc-gutter-pad {
    display: table-cell;
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  .grvsc-gutter {
    display: table-cell;
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter::before {
    content: attr(data-content);
  }
  
  .grvsc-source {
    display: table-cell;
    padding-left: 1.5rem;
    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));
    padding-right: 1.5rem;
    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));
  }
  
  .grvsc-source:empty::after {
    content: ' ';
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
  }
  
  .grvsc-gutter + .grvsc-source {
    padding-left: 0.75rem;
    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);
  }
  
  /* Line transformer styles */
  
  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {
    content: ' ';
    position: absolute;
    width: 100%;
  }
  
  .grvsc-line-diff-add::before {
    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));
  }
  
  .grvsc-line-diff-del::before {
    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));
  }
  
  .grvsc-line-number {
    padding: 0 2px;
    text-align: right;
    opacity: 0.7;
  }
  
  .dark-default-dark {
    background-color: #1E1E1E;
    color: #D4D4D4;
  }
  .dark-default-dark .mtk12 { color: #9CDCFE; }
  .dark-default-dark .mtk1 { color: #D4D4D4; }
  .dark-default-dark .mtk4 { color: #569CD6; }
  .dark-default-dark .mtk7 { color: #B5CEA8; }
  .dark-default-dark .mtk11 { color: #DCDCAA; }
  .dark-default-dark .mtk10 { color: #4EC9B0; }
  .dark-default-dark .mtk3 { color: #6A9955; }
  .dark-default-dark .mtk15 { color: #C586C0; }
  .dark-default-dark .mtk8 { color: #CE9178; }
  .dark-default-dark .grvsc-line-highlighted::before {
    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));
    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));
  }
</style></div></div><div class="core-app-report__sidebar"><div class="core-app-report__toc"><div class="core-app-report__toc-header"><h1 class="core-app-report__toc-title">Table of contents</h1><svg class="core-app-report__toc-arrow " width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 9.5L12 16.5L5 9.5" stroke="#ADABB2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div></div></div></div></div></main></div></div><script src="./Cabal Liquid Staking Token_files/webpack-ee83ff9cf0b0c89c.js.download" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/9b7eb431f23ca42e-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/b603571150b520e0-s.p.ttf\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n3:HL[\"/_next/static/media/d9396795aa5ec363-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n4:HL[\"/_next/static/css/aa1e03632b0a9f00.css\",\"style\"]\n5:HL[\"/_next/static/css/2c612863d5a616cb.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"6:I[12846,[],\"\"]\n9:I[4707,[],\"\"]\nb:I[36423,[],\"\"]\nc:I[15718,[\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"3211\",\"static/chunks/app/reports/error-337d8165658cb655.js\"],\"default\"]\nf:I[61060,[],\"\"]\na:[\"slug\",\"2025-04-cabal-liquid-staking-token\",\"d\"]\n10:[]\n0:[\"$\",\"$L6\",null,{\"buildId\":\"GcxK7sNbw6COX75T-g0fs\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"reports\",\"2025-04-cabal-liquid-staking-token\"],\"initialTree\":[\"\",{\"children\":[\"reports\",{\"children\":[[\"slug\",\"2025-04-cabal-liquid-staking-token\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"reports\",{\"children\":[[\"slug\",\"2025-04-cabal-liquid-staking-token\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L7\",\"$L8\",null],null],null]},[null,[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"reports\",\"children\",\"$a\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"reports\",\"children\"],\"error\":\"$c\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/aa1e03632b0a9f00.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2c612863d5a616cb.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],\"$Ld\"],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Le\"],\"globalErrorComponent\":\"$f\",\"missingSlots\":\"$W10\"}]\n"])</script><script>self.__next_f.push([1,"11:I[36525,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"6686\",\"static/chunks/6686-dd6382cfde9e8708.js\",\"5813\",\"static/chunks/5813-7499623caf5cc29b.js\",\"1638\",\"static/chunks/1638-db2c32ae38fcd41e.js\",\"191\",\"static/chunks/191-92b4f6645071a623.js\",\"5028\",\"static/chunks/5028-123aa2d0fc9289a2.js\",\"867\",\"static/chunks/867-d827a4f529ecb777.js\",\"7834\",\"static/chunks/7834-2536a8f829bd1d9d.js\",\"3185\",\"static/chunks/app/layout-c054eff4d03ebbf2.js\"],\"default\"]\n12:I[75292,[\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"9160\",\"static/chunks/app/not-found-c0beac80bd3674ca.js\"],\"default\"]\n13:I[80319,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-db2c32ae38fcd41e.js\",\"191\",\"static/chunks/191-92b4f6645071a623.js\",\"5028\",\"static/chunks/5028-123aa2d0fc9289a2.js\",\"867\",\"static/chunks/867-d827a4f529ecb777.js\",\"7834\",\"static/chunks/7834-2536a8f829bd1d9d.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-220cafabfbe0a147.js\"],\"default\"]\n14:I[39350,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea"])</script><script>self.__next_f.push([1,"2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-db2c32ae38fcd41e.js\",\"191\",\"static/chunks/191-92b4f6645071a623.js\",\"5028\",\"static/chunks/5028-123aa2d0fc9289a2.js\",\"867\",\"static/chunks/867-d827a4f529ecb777.js\",\"7834\",\"static/chunks/7834-2536a8f829bd1d9d.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-220cafabfbe0a147.js\"],\"default\"]\n17:I[75899,[\"8550\",\"static/chunks/da2599a7-883aa94cd391c09d.js\",\"8218\",\"static/chunks/aaea2bcf-7a609d2a8547b978.js\",\"5501\",\"static/chunks/c16f53c3-1c73b34d2bc72b67.js\",\"5986\",\"static/chunks/0815f603-89dbad4b5756c5c4.js\",\"2972\",\"static/chunks/2972-f84899d403fe0acb.js\",\"5878\",\"static/chunks/5878-bdbba189b5f619d7.js\",\"1700\",\"static/chunks/1700-bbc1d97db9b9492c.js\",\"2636\",\"static/chunks/2636-173262633c516a97.js\",\"3504\",\"static/chunks/3504-22e800882144201d.js\",\"4105\",\"static/chunks/4105-30871074ad2edc9d.js\",\"6390\",\"static/chunks/6390-77d8d06791482011.js\",\"1638\",\"static/chunks/1638-db2c32ae38fcd41e.js\",\"191\",\"static/chunks/191-92b4f6645071a623.js\",\"5028\",\"static/chunks/5028-123aa2d0fc9289a2.js\",\"867\",\"static/chunks/867-d827a4f529ecb777.js\",\"7834\",\"static/chunks/7834-2536a8f829bd1d9d.js\",\"1960\",\"static/chunks/app/reports/%5Bslug%5D/page-220cafabfbe0a147.js\"],\"default\"]\nd:[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"dark __variable_145019 __variable_7d3254 __variable_38ceec\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L11\",null,{\"hasLoginHistory\":true,\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"template"])</script><script>self.__next_f.push([1,"Styles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"$L12\",null,{}],\"notFoundStyles\":[]}]}]}]}]\n15:T258f8,"])</script><script>self.__next_f.push([1,"\u003ch1 id=\"overview\" style=\"position:relative;\"\u003e\u003ca href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eOverview\u003c/h1\u003e\n\u003ch2 id=\"about-c4\" style=\"position:relative;\"\u003e\u003ca href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eAbout C4\u003c/h2\u003e\n\u003cp\u003eCode4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eA C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eDuring the audit outlined in this document, C4 conducted an analysis of the Cabal Liquid Staking Token smart contract system. The audit took place from April 28 to May 05, 2025.\u003c/p\u003e\n\u003cp\u003eFinal report assembled by Code4rena.\u003c/p\u003e\n\u003ch1 id=\"summary\" style=\"position:relative;\"\u003e\u003ca href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h1\u003e\n\u003cp\u003eThe C4 analysis yielded an aggregated total of 8 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.\u003c/p\u003e\n\u003cp\u003eAll of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Cabal team.\u003c/p\u003e\n\u003ch1 id=\"scope\" style=\"position:relative;\"\u003e\u003ca href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScope\u003c/h1\u003e\n\u003cp\u003eThe code under review can be found within the \u003ca href=\"https://github.com/code-423n4/2025-04-cabal\"\u003eC4 Cabal Liquid Staking Token repository\u003c/a\u003e, and is composed of 8 smart contracts written in the Move programming language and includes 2,574 lines of Move code.\u003c/p\u003e\n\u003ch1 id=\"severity-criteria\" style=\"position:relative;\"\u003e\u003ca href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSeverity Criteria\u003c/h1\u003e\n\u003cp\u003eC4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.\u003c/p\u003e\n\u003cp\u003eHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMalicious Input Handling\u003c/li\u003e\n\u003cli\u003eEscalation of privileges\u003c/li\u003e\n\u003cli\u003eArithmetic\u003c/li\u003e\n\u003cli\u003eGas use\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on \u003ca href=\"https://code4rena.com\"\u003ethe C4 website\u003c/a\u003e, specifically our section on \u003ca href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\"\u003eSeverity Categorization\u003c/a\u003e.\u003c/p\u003e\n\u003ch1 id=\"high-risk-findings-1\" style=\"position:relative;\"\u003e\u003ca href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eHigh Risk Findings (1)\u003c/h1\u003e\n\u003ch2 id=\"h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\" style=\"position:relative;\"\u003e\u003ca href=\"#h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\" aria-label=\"h 01 lp unstaking only burns the shares but leaves the underlying tokens in the system which distorts the shares to tokens ratio and leads to incorrect amounts being calculated during staking and unstaking permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-156\"\u003e[H-01] LP unstaking only burns the shares but leaves the underlying tokens in the system, which distorts the shares-to-tokens ratio and leads to incorrect amounts being calculated during staking and unstaking\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-176\"\u003eTheSchnilch\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-232\"\u003eret2basic\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description\" aria-label=\"finding description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eWhen a user unstakes LP tokens, the corresponding shares (Cabal tokens) are burned. However, the actual undelegation from the validator will occur only after a delay of up to 3 days. During this period, the shares are already burned, but the underlying tokens are still included in shares-to-token conversions.\nThis is a problem because, in \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e, the amount of tokens to unbond is calculated as follows:\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003elp_amount\u003c/code\u003e is calculated based on the amount of tokens actually staked on the validator. This includes tokens that are pending to be undelegated (\u003ccode\u003eunstaked_pending_amounts\u003c/code\u003e), for which the Cabal tokens have already been burned.\u003c/p\u003e\n\u003cp\u003eThis means that the \u003ccode\u003eunbonding_amount\u003c/code\u003e is also calculated incorrectly because the \u003ccode\u003elp_amount\u003c/code\u003e is too high. As a result, the \u003ccode\u003eunbonding_amount\u003c/code\u003e will also be too high, and the unstaker will receive too many tokens that are actually belonging to other users.\u003c/p\u003e\n\u003cp\u003eSince the Cabal tokens a user receives are also calculated this way in \u003ccode\u003eprocess_lp_stake\u003c/code\u003e, users will receive too few shares when there are pending undelegations. As a result, they will have fewer tokens after the next \u003ccode\u003ebatch_undelegate_pending_lps\u003c/code\u003e:\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact\" style=\"position:relative;\"\u003e\u003ca href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eBecause users receive too many tokens that actually belong to other users, and since this issue occurs during normal unstaking and staking, it is high severity.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eunstaked_pending_amounts\u003c/code\u003e should be subtracted from the \u003ccode\u003elp_amount\u003c/code\u003e to correctly account for the pending tokens to be undelegated, for which the Cabal tokens have already been burned.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"0\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    #[test(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        c = @staking_addr, user_a = @0xAAA, user_b = @0xBBB, user_c = @0xCCC\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    )]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    fun test_poc(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        c: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_a: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_b: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_c: \u0026amp;signer\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        test_setup(c, string::utf8(b\u0026quot;initvaloper1test\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //gets the metadata for all tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ulp_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;ulp\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let init_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let cabal_lp_metadata = cabal::get_cabal_token_metadata(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let x_init_metadata = cabal::get_xinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let sx_init_metadata = cabal::get_sxinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let initia_signer = \u0026amp;account::create_signer_for_test(@initia_std);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ulp_decimals = 1_000_000; //ulp has 6 decimals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let deposit_amount_a = 100 * ulp_decimals; //the amount user a deposits\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::transfer( //user a must first be funded\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            initia_signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ulp_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            signer::address_of(user_a),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            deposit_amount_a\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_stake(user_a, 1, deposit_amount_a); //user a stakes 100 ulp\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let deposit_amount_b = 50 * ulp_decimals; //the amount user b stakes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::transfer(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            initia_signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ulp_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            signer::address_of(user_b),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            deposit_amount_b\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_stake(user_b, 1, deposit_amount_b); //user b stakes 50 ulp\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_unstake(user_b, 1, deposit_amount_b); //user b unstakes 50 ulp this means the cabal tokens are now 100 and the underlying tokens 150\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //This mock unstaking uses the pool balances instead of querying the validator because Cosmos is not supported during testing. \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //However, this is not a problem, since the pools are only modified after the undelegation, not during the unstaking\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_unstake(user_a, 1, 50 * ulp_decimals); //user a unstakes half of his cabal lp tokens for which 50 ulp tokens should be unstaked but actually 75 are getting unstaked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can also add \u003ccode\u003edebug::print(\u0026#x26;unbonding_amount);\u003c/code\u003e to line 1334 in cabal.move to verify that 75 ULP tokens are being unstaked instead of 50.\u003c/p\u003e\n\u003cp\u003eTo run the POC, paste it into the file \u003ccode\u003etests/core_staking_test.move\u003c/code\u003e and run the command \u003ccode\u003einitiad move test -f test_poc\u003c/code\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"medium-risk-findings-7\" style=\"position:relative;\"\u003e\u003ca href=\"#medium-risk-findings-7\" aria-label=\"medium risk findings 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eMedium Risk Findings (7)\u003c/h1\u003e\n\u003ch2 id=\"m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\" style=\"position:relative;\"\u003e\u003ca href=\"#m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\" aria-label=\"m 01 reentrancy check in lock_stakingreentry_check causes concurrent init deposit failures dos permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-27\"\u003e[M-01] Reentrancy Check in \u003ccode\u003elock_staking::reentry_check\u003c/code\u003e Causes Concurrent INIT Deposit Failures (DOS)\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-29\"\u003erare_one\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact\" aria-label=\"finding description and impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eThe liquid staking protocol’s \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e function, which allows users to deposit INIT tokens to receive xINIT, is vulnerable to transaction failures when multiple users deposit concurrently in the same block. The function withdraws INIT tokens and delegates them to a validator via \u003ccode\u003epool_router::add_stake\u003c/code\u003e, which triggers \u003ccode\u003elock_staking::delegate\u003c/code\u003e. This, in turn, invokes \u003ccode\u003ereentry_check\u003c/code\u003e to prevent multiple delegations in the same block. \u003c/p\u003e\n\u003cp\u003eIf a second user attempts to deposit in the same block as another, their transaction fails with error code 196618 (EREENTER), as \u003ccode\u003ereentry_check\u003c/code\u003e detects that the StakingAccount was already modified in the current block. This vulnerability disrupts users’ ability to participate in the protocol, particularly during periods of high transaction activity.\u003c/p\u003e\n\u003ch3 id=\"root-cause\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause:\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003ereentry_check\u003c/code\u003e function in lock_staking.move enforces a strict one-delegation-per-block rule for a given StakingAccount:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"1\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun reentry_check(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    staking_account: \u0026amp;mut StakingAccount, \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    with_update: bool\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let (height, _) = block::get_block_info();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(staking_account.last_height != height, error::invalid_state(EREENTER));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (with_update) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        staking_account.last_height = height;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function checks if \u003ccode\u003estaking_account.last_height\u003c/code\u003e equals the current block height and aborts with EREENTER if true. If \u003ccode\u003ewith_update\u003c/code\u003e is true, it updates \u003ccode\u003elast_height\u003c/code\u003e to the current height, marking the block as processed.\u003c/p\u003e\n\u003cp\u003eIn cabal.move, the \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e function processes user deposits independently:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"2\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epublic entry fun deposit_init_for_xinit(account: \u0026amp;signer, deposit_amount: u64) acquires ModuleStore {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    emergency::assert_no_paused();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(deposit_amount \u0026gt; 0, error::invalid_argument(EINVALID_COIN_AMOUNT));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let m_store = borrow_global\u0026lt;ModuleStore\u0026gt;(@staking_addr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let coin_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // calculate mint xinit\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let init_amount = pool_router::get_real_total_stakes(coin_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let x_init_amount = option::extract(\u0026amp;mut fungible_asset::supply(m_store.x_init_metadata));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let mint_x_init_amount = if (x_init_amount == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deposit_amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ratio = bigdecimal::from_ratio_u64(deposit_amount, init_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Round up because of truncation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        (bigdecimal::mul_by_u128_ceil(ratio, x_init_amount) as u64)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(mint_x_init_amount \u0026gt; 0, error::invalid_argument(EINVALID_STAKE_AMOUNT));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // withdraw init to stake\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let fa = primary_fungible_store::withdraw(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        account,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        coin_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deposit_amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    pool_router::add_stake(fa); // Triggers lock_staking::delegate\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // mint xINIT to user\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    coin::mint_to(\u0026amp;m_store.x_init_caps.mint_cap, signer::address_of(account), mint_x_init_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen multiple users call \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e in the same block:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe first user’s deposit passes \u003ccode\u003ereentry_check\u003c/code\u003e, updates \u003ccode\u003estaking_account.last_height\u003c/code\u003e to the current block height (assuming \u003ccode\u003ewith_update = true\u003c/code\u003e in \u003ccode\u003elock_staking::delegate\u003c/code\u003e), and completes, minting xINIT.\u003c/li\u003e\n\u003cli\u003eThe second user’s deposit triggers \u003ccode\u003ereentry_check\u003c/code\u003e via \u003ccode\u003epool_router::add_stake\u003c/code\u003e and \u003ccode\u003elock_staking::delegate\u003c/code\u003e. Since \u003ccode\u003estaking_account.last_height\u003c/code\u003e equals the current height, the transaction aborts with EREENTER, preventing the deposit and xINIT minting.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe function’s lack of coordination for concurrent deposits results in multiple \u003ccode\u003elock_staking::delegate\u003c/code\u003e calls, triggering the reentrancy failure. This vulnerability is evident in production scenarios where users deposit INIT during high network activity, such as during market events or protocol launches.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIMPACTS:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eDenial-of-Service (DoS) for Users: Users attempting to deposit INIT in a block with multiple deposits will face transaction failures, losing gas fees and being unable to receive xINIT. This disrupts their ability to participate in liquid staking, particularly during peak usage periods.\u003c/p\u003e\n\u003cp\u003eFinancial Loss: Failed transactions result in gas fee losses for users, which can accumulate significantly in high-traffic scenarios, deterring participation.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eImplement a batching mechanism to aggregate all user INIT deposits within a block and process them as a single delegation, ensuring only one call to \u003ccode\u003elock_staking::delegate\u003c/code\u003e per block and bypassing the \u003ccode\u003ereentry_check\u003c/code\u003e restriction.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-1\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eInitialize the protocol using initialize to set up the xINIT pool.\u003c/p\u003e\n\u003cp\u003eSimulate two users depositing INIT in the same block using mock\u003cem\u003edeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit.\u003c/p\u003e\n\u003cp\u003eObserve the EREENTER error (code 196618) from reentry_check for the second deposit.\u003c/p\u003e\n\u003cp\u003e// User 1 transaction (submitted in block 100)\npublic entry fun user1\u003cem\u003edeposit(account: \u0026#x26;signer) {\ndeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit(account, 500\u003cem\u003e000\u003c/em\u003e000);\n}\u003c/p\u003e\n\u003cp\u003e// User 2 transaction (submitted in block 100)\npublic entry fun user2\u003cem\u003edeposit(account: \u0026#x26;signer) {\ndeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit(account, 200\u003cem\u003e000\u003c/em\u003e000);\n}\u003c/p\u003e\n\u003cp\u003eSetup:\u003c/p\u003e\n\u003cp\u003eDeploy the protocol and initialize it.\u003c/p\u003e\n\u003cp\u003eFund User 1 (@0x1) with 500,000,000 INIT and User 2 (@0x2) with 200,000,000 INIT.\u003c/p\u003e\n\u003cp\u003eSet block height to 100.\u003c/p\u003e\n\u003cp\u003eUser 1 submits user1\u003cem\u003edeposit in block 100, calling `deposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit\u003ccode\u003e, withdrawing 500,000,000 INIT, delegating via\u003c/code\u003epool\u003cem\u003erouter::add\u003c/em\u003estake\u003ccode\u003e(triggering\u003c/code\u003elock_staking::delegate`), and minting approximately 500,000,000 xINIT (adjusted for pool size).\u003c/p\u003e\n\u003cp\u003eUser 2 submits user2\u003cem\u003edeposit in block 100, calling `deposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit\u003ccode\u003e, but\u003c/code\u003epool\u003cem\u003erouter::add\u003c/em\u003estake\u003ccode\u003etriggers\u003c/code\u003elock\u003cem\u003estaking::delegate\u003ccode\u003eand\u003c/code\u003ereentry\u003c/em\u003echeck\u003ccode\u003e. Since\u003c/code\u003estaking\u003cem\u003eaccount.last\u003c/em\u003eheight` equals 100 (from User 1’s deposit), the transaction aborts with EREENTER (code 196618).\u003c/p\u003e\n\u003cp\u003eResult:\u003c/p\u003e\n\u003cp\u003eUser 1: Receives ~500,000,000 xINIT.\u003c/p\u003e\n\u003cp\u003eUser 2: Transaction fails, loses gas fees, receives no xINIT.\u003c/p\u003e\n\u003cp\u003eThis test demonstrates the issue\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"3\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun test_concurrent_deposits(c: \u0026amp;signer, user_a: \u0026amp;signer, user_b: \u0026amp;signer) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    test_setup(c, string::utf8(b\u0026quot;initvaloper1test\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let init_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let x_init_metadata = cabal::get_xinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Transfer INIT to users\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let deposit_a = 500_000_000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let deposit_b = 200_000_000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_a), deposit_a);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_b), deposit_b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Simulate concurrent deposits (no block increase between them)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cabal::mock_deposit_init_for_xinit(user_a, deposit_a);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cabal::mock_deposit_init_for_xinit(user_b, deposit_b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify xINIT balances\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let user_a_xinit = primary_fungible_store::balance(signer::address_of(user_a), x_init_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let user_b_xinit = primary_fungible_store::balance(signer::address_of(user_b), x_init_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(user_a_xinit == deposit_a || user_a_xinit == deposit_a - 1, 1007);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(user_b_xinit == deposit_b || user_b_xinit == deposit_b - 1, 1008);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify global state\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let final_xinit_supply = cabal::get_xinit_total_supply();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let final_total_staked_init = cabal::get_pool_router_total_init();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(final_xinit_supply == (MINIMUM_LIQUIDITY as u128) + (deposit_a as u128) + (deposit_b as u128), 1009);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(final_total_staked_init == MINIMUM_LIQUIDITY + deposit_a + deposit_b, 1010);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand the result\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eFailures\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xe472ba1c00b2ee2b007b4c5788839d6fb7371c6\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::core_staking_test:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e┌── \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest_concurrent_deposits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ──────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eE11001\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailure\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      ┌─ ././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1226\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e9\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1222\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e │     \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereentry_check\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │         ------------- \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e 0\u003c/span\u003e\u003cspan class=\"mtk11\"\u003exe55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elock_staking\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      ·\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ 1226 │         \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassert\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e!(staking_account.last_height != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eheight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk10\"\u003einvalid_state\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk10\"\u003eEREENTER\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │         ^^^^^^ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpected\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaborted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewith\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e196618\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eoriginating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ethe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003emodule\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ee55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erooted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ehere\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estack\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etrace\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate_internal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e715\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_process_delegate_init\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e608\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e614\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_add_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e630\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecabal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_deposit_init_for_xinit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecabal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1196\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore_staking_test\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_concurrent_deposits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etests\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore_staking_test\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e780\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e└──────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFAILED\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e. \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTotal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etests\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epassed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\" style=\"position:relative;\"\u003e\u003ca href=\"#m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\" aria-label=\"m 02 unstaking calculates user share at request time ignoring slashing  leading to dos and unfair distribution permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-83\"\u003e[M-02] Unstaking calculates user share at request time, ignoring slashing — leading to DoS and unfair distribution\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-86\"\u003e0xAlix2\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-279\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-263\"\u003egivn\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-179\"\u003emaxzuvex\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-173\"\u003eTheSchnilch\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080\u003c/a\u003e\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-1\" aria-label=\"finding description and impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description and Impact\u003c/h3\u003e\n\u003cp\u003eUsers can stake both INIT and LP tokens into different validator pools by calling functions like \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e or \u003ccode\u003estake_asset\u003c/code\u003e. To exit, users initiate an unstake via \u003ccode\u003einitiate_unstake\u003c/code\u003e, which starts an unbonding period. After this delay, they can claim their tokens through \u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBehind the scenes, these staked assets are delegated to validators, and slashing may occur—meaning a portion of the delegated tokens could be penalized (burned). To stay accurate, the protocol uses \u003ccode\u003epool_router::get_real_total_stakes\u003c/code\u003e to track the current delegated amount. However, the current unstaking flow doesn’t properly account for slashing events that may occur during the unbonding period.\u003c/p\u003e\n\u003cp\u003eWhen a user initiates an unstake, either \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e or \u003ccode\u003eprocess_xinit_unstake\u003c/code\u003e is called. For simplicity, we focus on \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIn \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1043C1-L1083C6\"\u003e\u003ccode\u003eprocess_lp_unstake\u003c/code\u003e\u003c/a\u003e, the claimable amount is calculated up front at unstake time:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"5\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e reward_amount = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecompound_lp_pool_rewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(m_store, unstaking_type);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e lp_amount = reward_amount + pool_router::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_real_total_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(...);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_lp_amount = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(...);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ratio = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount as \u003c/span\u003e\u003cspan class=\"mtk4\"\u003eu128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, cabal_lp_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e unbonding_amount = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(ratio, lp_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003evector::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush_back\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk4\"\u003emut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_store.unbonding_entries, UnbondingEntry {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    amount: unbonding_amount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLater, in \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L711C22-L750\"\u003e\u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e\u003c/a\u003e, this precomputed amount is blindly transferred to the user:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"6\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003eprimary_fungible_store::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u0026amp;package::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_assets_store_signer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    metadata,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    account_addr,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    amount \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ← Precomputed at unstake time\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis design introduces a critical flaw: it assumes the pool value remains constant between unstake and claim, which is not guaranteed. If slashing happens during this period:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA large user may claim more than the pool holds → DoS\u003c/li\u003e\n\u003cli\u003eAn early user may claim full value post-slash → Other users absorb full loss\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eNB:\u003c/strong\u003e\nThis differs from systems like Lido, where the amount returned is computed at claim time based on the user’s share of the pool, ensuring fair slashing distribution.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eInstead of locking in the claimable amount at unstake time, store the user’s \u003cstrong\u003epercentage share\u003c/strong\u003e of the total LP supply. Then, during \u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e, recalculate the actual amount using the current pool value (i.e., post-slash).\u003c/p\u003e\n\u003cp\u003eThis ensures slashing risk is shared proportionally among all stakers, and prevents DoS or overclaiming exploits.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-2\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eCase 1 – Whale Unstakes 50%, Then Pool Is Slashed by 51%\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eScenario:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTotal pool value: 1,000 LP tokens\u003c/li\u003e\n\u003cli\u003eA whale holds 500 LP and unstakes it, expecting to claim 500 units\u003c/li\u003e\n\u003cli\u003eThe remaining users hold the other 500 LP\u003c/li\u003e\n\u003cli\u003eBefore the whale claims, the pool is slashed by 51%, reducing it to 490 units\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCurrent behavior (problem):\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe whale still tries to claim 500 units\u003c/li\u003e\n\u003cli\u003eThe pool only has 490 units left → this would revert, fail, or break accounting\u003c/li\u003e\n\u003cli\u003eEssentially, the whale locks in a pre-slash value and now the pool can’t fulfill it\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eWhat should happen:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eClaim should be recalculated at execution time\u003c/li\u003e\n\u003cli\u003e500 LP × (490 / 1000) = 245 units\u003c/li\u003e\n\u003cli\u003eWhale gets 245 units, the rest of the pool reflects that slashing fairly across all holders\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCase 2 – Early User Unstakes, Pool Slashed, Claims Full Amount\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eScenario:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePool has 1,000 LP total\u003c/li\u003e\n\u003cli\u003eUser A holds 100 LP, unstakes and expects 100 units\u003c/li\u003e\n\u003cli\u003eUser B holds 900 LP\u003c/li\u003e\n\u003cli\u003eA 50% slash hits before User A claims → pool is now worth 500 units\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCurrent behavior (problem):\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUser A claims 100 units (based on original rate)\u003c/li\u003e\n\u003cli\u003eOnly 400 units remain for User B’s 900 LP\u003c/li\u003e\n\u003cli\u003eThat means User B absorbs the full impact of the slash — clearly unfair\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eWhat should happen:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eClaim is based on current pool state\u003c/li\u003e\n\u003cli\u003e100 LP × (500 / 1000) = 50 units\u003c/li\u003e\n\u003cli\u003eUser A gets 50 units, User B’s 900 LP is worth 450 → everyone shares the slash proportionally\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\" style=\"position:relative;\"\u003e\u003ca href=\"#m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\" aria-label=\"m 03 attacker can desynchronize supply snapshot during same block unstake reducing everyones rewards permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-125\"\u003e[M-03] Attacker Can Desynchronize Supply Snapshot During Same-Block Unstake, Reducing Everyone’s Rewards\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-135\"\u003emaxzuvex\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-117\"\u003e0xAlix2\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-177\"\u003eTheSchnilch\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-2\" aria-label=\"finding description and impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eAn attacker holding Cabal LSTs (like sxINIT) can monitor the mempool for the manager’s \u003ccode\u003evoting_reward::snapshot()\u003c/code\u003e transaction. By submitting his own \u003ccode\u003ecabal::initiate_unstake\u003c/code\u003e transaction to execute in the \u003cem\u003esame block\u003c/em\u003e (\u003ccode\u003eH\u003c/code\u003e) as the manager’s snapshot, the attacker can use two flaws:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::burn\u003c/code\u003e (called by their unstake) doesn’t update the supply snapshot for block \u003ccode\u003eH\u003c/code\u003e, leaving the recorded supply artificially high (pre-burn).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::check_snapshot\u003c/code\u003e skips recording the attacker’s \u003cem\u003eown\u003c/em\u003e balance for block \u003ccode\u003eH\u003c/code\u003e.\nLater reward calculations use the stale high supply but retrieve the attacker’s now lower (post-burn) balance via fallback logic. This desynchronization causes the total calculated reward shares to be less than 100%, reducing the rewards paid out to \u003cem\u003eall\u003c/em\u003e users for that cycle.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eAttacker Exploit:\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eManager Snapshots Supply:\u003c/strong\u003e \u003ccode\u003evoting_reward::snapshot\u003c/code\u003e triggers \u003ccode\u003ecabal_token::snapshot\u003c/code\u003e, recording the LST total supply (\u003ccode\u003eS₀\u003c/code\u003e) for block \u003ccode\u003eH\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUser Unstakes (Same Block H):\u003c/strong\u003e The user calls \u003ccode\u003ecabal::initiate_unstake\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eInternally, \u003ccode\u003ecabal_token::check_snapshot\u003c/code\u003e is called but \u003cstrong\u003eskips writing\u003c/strong\u003e the user’s pre-burn balance for block \u003ccode\u003eH\u003c/code\u003e due to same-block logic.\u003c/li\u003e\n\u003cli\u003eThe user’s live balance decreases.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::burn\u003c/code\u003e executes, reducing the live supply, but \u003cstrong\u003efails to update\u003c/strong\u003e the recorded supply snapshot for \u003ccode\u003eH\u003c/code\u003e (which remains \u003ccode\u003eS₀\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReward Calculation Uses Inconsistent State:\u003c/strong\u003e Later, rewards for cycle \u003ccode\u003eH\u003c/code\u003e are calculated:\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eget_snapshot_supply(H)\u003c/code\u003e returns the stale, \u003cstrong\u003epre-burn \u003ccode\u003eS₀\u003c/code\u003e\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eget_snapshot_balance(user, H)\u003c/code\u003e finds no user snapshot for \u003ccode\u003eH\u003c/code\u003e and falls back, returning the user’s \u003cstrong\u003elive, post-burn balance\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eResult:\u003c/strong\u003e The reward share calculation uses \u003ccode\u003epost_burn_balance / pre_burn_supply\u003c/code\u003e, causing the sum of all shares to be \u0026#x3C; 1, thus reducing payouts for everyone. An attacker triggers this by ensuring their \u003ccode\u003einitiate_unstake\u003c/code\u003e executes in the same block as the manager’s \u003ccode\u003esnapshot\u003c/code\u003e (e.g., via mempool monitoring).\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"7\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 1. In `cabal_token::burn` (called by attacker\u0026#39;s `initiate_unstake` in block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003epublic fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(burn_cap: \u0026amp;BurnCapability, fa: FungibleAsset) acquires ManagingRefs, HolderStore, ModuleStore { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Added missing acquires for context\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emetadata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = burn_cap.metadata;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emetadata_addr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = object::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eobject_address\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;metadata);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    assert!(exists\u0026lt;ManagingRefs\u0026gt;(metadata_addr), EMANAGING_REFS_NOT_FOUND);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefs\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = borrow_global\u0026lt;ManagingRefs\u0026gt;(metadata_addr);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Burn reduces the LIVE supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;refs.burn_ref, fa);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 1 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: This function is called in block H AFTER cabal_token::snapshot recorded\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// the supply. However, UNLIKE mint_to, this function DOES NOT check if it\u0026#39;s the snapshot\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// block and DOES NOT update the HolderStore::supply_snapshots table for block H.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// The recorded supply for H remains the stale, pre-burn value (S₀).\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* Missing logic similar to mint_to:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e        if (is_snapshot_block) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e            update supply_snapshots table with new (lower) supply S₁;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e    */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 2. In `cabal_token::check_snapshot` (called during attacker\u0026#39;s unstake in block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003echeck_snapshot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(c_balance: \u0026amp;mut CabalBalance, current_snapshot_block: u64, prev_snapshot_block: Option\u0026lt;u64\u0026gt;) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrent_block_height\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = block::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_current_block_height\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esnapshot_block\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = current_snapshot_block; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 2 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (current_block_height == current_snapshot_block) { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// TRUE (H == H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: This condition is met.The logic inside prevents writing\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// the attacker\u0026#39;s PRE-BURN balance to their personal snapshot table for block H.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eis_none\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;prev_snapshot_block)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Early return, no write for H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Tries to write for Previous_H instead, still no write for H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esnapshot_block\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;mut prev_snapshot_block);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// The code path that writes `table::add(\u0026amp;mut c_balance.snapshot, key, c_balance.balance)`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// requires `current_block_height \u0026gt; snapshot_block`, which is FALSE here.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// RESULT: Attacker\u0026#39;s balance for H is NOT recorded.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 3. In `cabal_token::get_snapshot_balance_internal` (called during reward calculation for block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_snapshot_balance_internal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(cabal_balance: \u0026amp;CabalBalance, block_height: u64): u64 { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// block_height is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... start_block check ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Search attacker\u0026#39;s personal table for entry \u0026gt;= H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ekey\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = table_key::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode_u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(block_height);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eiter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = table::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eiter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;cabal_balance.snapshot, option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esome\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(key), option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enone\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 3 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Because the write was skipped (Vuln Part 2), no entry \u0026gt;= H is found for the attacker.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (!table::prepare\u0026lt;vector\u0026lt;u8\u0026gt;, u64\u0026gt;(iter)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: Fallback logic returns the attacker\u0026#39;s LIVE balance.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// At this point (reward calculation time), the live balance is the POST-BURN balance.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_balance.balance;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This part is not reached for the attacker in this scenario\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let (_, balance) = table::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enext\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(iter);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    *balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eImpact:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eInvariant violation\u003c/strong\u003e\u003cbr\u003e\nThe attack breaks the core guarantee \u003ccode\u003eΣ balances_H = supply_H\u003c/code\u003e. Because the attacker’s balance is recorded \u003cem\u003eafter\u003c/em\u003e the burn while the supply is recorded \u003cem\u003ebefore\u003c/em\u003e, the numerator shrinks but the denominator stays high.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUniversal reward loss\u003c/strong\u003e\u003cbr\u003e\nReward shares now sum to \u003cstrong\u003e\u0026#x3C; 1\u003c/strong\u003e, so the bribe contract distributes fewer tokens than were deposited. Every honest staker at snapshot H loses part of their yield; the missing amount remains stranded in the pool.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDirect leverage for the attacker\u003c/strong\u003e\u003cbr\u003e\nAn exiting holder gives up only their own one‑cycle reward while slashing everyone else’s payout by the same absolute amount. They can repeat the manoeuvre each epoch—or threaten to—creating a zero‑cost grief / extortion vector.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCompromise of a core protocol function\u003c/strong\u003e\u003cbr\u003e\nFair, supply‑proportional bribe distribution is a primary feature of Cabal. Desynchronising balances and supply corrupts that mechanism, undermining trust in the staking programme.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIrreversible cycle corruption\u003c/strong\u003e\u003cbr\u003e\nOnce the snapshot for block H is polluted, the mis‑distribution for that cycle is permanent. users cannot reclaim the lost bribes without an invasive state migration.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eAdd Supply Update to \u003ccode\u003eburn\u003c/code\u003e:\u003c/strong\u003e Modify \u003ccode\u003ecabal_token::burn\u003c/code\u003e to check if it’s executing in the same block as a snapshot. If so, update the \u003ccode\u003esupply_snapshots\u003c/code\u003e table for that block height with the new, lower supply \u003cem\u003eafter\u003c/em\u003e the burn, mirroring the logic in \u003ccode\u003ecabal_token::mint_to\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFix \u003ccode\u003echeck_snapshot\u003c/code\u003e:\u003c/strong\u003e Ensure \u003ccode\u003echeck_snapshot\u003c/code\u003e \u003cem\u003ealways\u003c/em\u003e writes the user’s pre-interaction balance for the current snapshot block \u003ccode\u003eH\u003c/code\u003e when needed, removing the logic that skips this write during same-block interactions.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\" aria-label=\"m 04 unstaking from lp pools will cause underflow and lock user funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-155\"\u003e[M-04] Unstaking from LP pools will cause underflow and lock user funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-267\"\u003egivn\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-118\"\u003e0xAlix2\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-175\"\u003ebareli\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-280\"\u003eden-sosnowsky\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"description\" style=\"position:relative;\"\u003e\u003ca href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDescription\u003c/h3\u003e\n\u003cp\u003eWhen users unstake their LP tokens they call \u003ccode\u003einitiate_unstake\u003c/code\u003e for the required amount. This creates \u003ccode\u003eUnbondingEntry\u003c/code\u003e and increases the pending unstake amount - \u003ccode\u003eunstaked_pending_amounts[unstaking_type] + unbonding_amount\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAt some point an admin (or user) will invoke \u003ccode\u003ebatch_undelegate_pending_lps()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"8\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunbond_period\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// undelegate\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tpool_router::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eunlock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estake_token_metadata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunstaked_pending_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// clear pending\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunstaked_pending_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003epool_router::unlock\u003c/code\u003e calculates what % of every pool should be undelegated so that the desired LP token amount is reached. This happens by calculating a fraction, iterating over the pools and subtracting an amount equal to that fraction. The issue is that when the \u003cstrong\u003elast pool element\u003c/strong\u003e is reached, the remaining amount is \u003cstrong\u003eall\u003c/strong\u003e removed from there:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"9\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis means that if the last pool is empty or with insufficient funds an underflow will occur here:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"10\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe protocol tries to always fund the pool with least staked tokens by using \u003ccode\u003eget_most_underutilized_pool\u003c/code\u003e, but this does not prevent situations of imbalance, like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe most underutilized pool receives a very big deposit and dwarfs the rest\u003c/li\u003e\n\u003cli\u003eNew pool is being freshly added \u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUsers in large numbers withdrawing their funds.\nThus, the subtraction can still underflow in situations that are likely to happen over time.\u003c/p\u003e\n\u003ch3 id=\"impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003c/li\u003e\n\u003cli\u003eStaked LP tokens can’t be fully withdrawn from protocol.\u003c/li\u003e\n\u003cli\u003eThe amount of funds locked can vary greatly, depending on the stake/unstake \u0026#x26; operation patterns. \u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOnce undelegate amount has been requested it can’t be reduced to try to unlock a smaller amount and get the maximum funds possible. Delegations are locked until someone else deposits.\u003c/p\u003e\n\u003ch3 id=\"root-cause-1\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause-1\" aria-label=\"root cause 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause\u003c/h3\u003e\n\u003cp\u003eTrying to withdraw too much from pool when funds are located in other pools.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-3\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe following code replicates the undelegate calculations of \u003ccode\u003epool_router::unlock\u003c/code\u003e and demonstrates that not all the funds can be withdrawn.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePlace this test in \u003ccode\u003epool_router.move\u003c/code\u003e. Run it with \u003ccode\u003eyarn run test- test_unlock_lp_amounts\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"11\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e#[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexpected_failure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_unlock_lp_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = 2\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_000_000u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Unlock LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[ \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// LP staked in each pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10_000\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eloop\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Begin undelegation round\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk15\"\u003ebreak\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Pool amounts after last iteration\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] \u0026quot;New pool stake amounts\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 4500\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 4500\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Now we continue undelegating smaller amounts, but action will underflow\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; ---- Undelegate smaller amount #1 ---- \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; ---- Undelegate smaller amount #2 ---- \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/// Simplified version of pool_router::unlock_lp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e#[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest_only\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026gt;, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e): \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026gt; {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, 0\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, |\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e| \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// LP staked in across all pools\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Total staked before undelegate\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassert\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e!(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000777\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eborrow_mut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t} \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, *\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Update state tracking\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t*\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = *\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;New pool stake amounts\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_staked_after_undelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, 0\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, |\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e| {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Total staked after undelegate\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_staked_after_undelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eInstead of doing one iteration over the pools and subtracting the remaining amount from the last one, use an loop and modulo arithmetic to iterate multiple times and subtract any possible remaining amounts from the other pools.\u003c/p\u003e\n\u003cp\u003eSeparate undelegate amount calculation from the \u003ccode\u003estargate\u003c/code\u003e calls so that multiple \u003ccode\u003eMsgUndelegate\u003c/code\u003e messages are not sent for the same validator.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-05-last-holder-cant-exit-zerosupply-unstake-reverts\" style=\"position:relative;\"\u003e\u003ca href=\"#m-05-last-holder-cant-exit-zerosupply-unstake-reverts\" aria-label=\"m 05 last holder cant exit zerosupply unstake reverts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-157\"\u003e[M-05] Last Holder Can’t Exit, Zero‑Supply Unstake Reverts\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-178\"\u003emaxzuvex\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-3\" aria-label=\"finding description and impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eWhen a user burns the \u003cstrong\u003eentire remaining supply\u003c/strong\u003e of a Cabal LST ( sxINIT or Cabal LPT) via \u003ccode\u003einitiate_unstake\u003c/code\u003e, the follow‑up processing step always aborts with a divide‑by‑zero and the user can never exit.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eUser calls \u003ccode\u003einitiate_unstake(stake_type, S)\u003c/code\u003e – S equals the whole supply.\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eunstake_xinit\u003c/code\u003e / \u003ccode\u003eunstake_lp\u003c/code\u003e queues \u003ccode\u003eprocess_*_unstake\u003c/code\u003e with \u003ccode\u003ecosmos::move_execute( … \"process_xinit_unstake\" | \"process_lp_unstake\" … )\u003c/code\u003e for next transaction.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAfter queuing\u003c/strong\u003e, \u003ccode\u003einitiate_unstake\u003c/code\u003e burns the LST: \u003ccode\u003ecabal_token::burn(S)\u003c/code\u003e ⇒ live supply becomes \u003cstrong\u003e0\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eTransaction 1 finishes and state now shows \u003ccode\u003esupply = 0\u003c/code\u003e, \u003ccode\u003epending[i] = S\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLater, Transaction 2 executes \u003ccode\u003eprocess_*_unstake\u003c/code\u003e.\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eCalls \u003ccode\u003ecompound_*_pool_rewards\u003c/code\u003e (does not change LST supply).\u003c/li\u003e\n\u003cli\u003eReads the current LST supply: \u003ccode\u003esx_supply = fungible_asset::supply(meta)\u003c/code\u003e ⇒ \u003cstrong\u003e0\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eCalculates \u003ccode\u003eratio = bigdecimal::from_ratio_u128(unstake_amount, sx_supply)\u003c/code\u003e which triggers \u003ccode\u003eassert!(denominator != 0)\u003c/code\u003e → \u003cstrong\u003e\u003ccode\u003eEDIVISION_BY_ZERO\u003c/code\u003e abort\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eBecause the burn happened in a prior committed transaction, every retry of \u003ccode\u003eprocess_*_unstake\u003c/code\u003e gets the same \u003ccode\u003esupply == 0\u003c/code\u003e state and fails again, so the user’s INIT / LP is permanently locked and it makes a DoS for the final staker of that pool.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"12\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Simplified logic from process_xinit_unstake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    entry fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprocess_xinit_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(account: \u0026amp;signer, staker_addr: address, unstaking_type: u64, unstake_amount: u64) acquires ModuleStore, CabalStore, LockExempt {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... permission checks, reward compounding ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = borrow_global_mut\u0026lt;ModuleStore\u0026gt;(@staking_addr);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ex_init_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = m_store.staked_amounts[unstaking_type];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026#39;unstake_amount\u0026#39; is the original amount burned (== total supply in this case).\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026#39;sx_init_amount\u0026#39; reads the supply *after* the burn in initiate_unstake, so it\u0026#39;s 0.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esx_init_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;mut fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(m_store.cabal_stake_token_metadata[unstaking_type])); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Returns 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This attempts bigdecimal::from_ratio_u128(S, 0) --\u0026gt; Division by Zero!\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount as u128, sx_init_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Transaction reverts here.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... rest of function is unreachable ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eImpact:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIf an address burns the last sxINIT / LPT in circulation, every call to \u003ccode\u003eprocess_*_unstake\u003c/code\u003e reverts with \u003ccode\u003eEDIVISION_BY_ZERO\u003c/code\u003e, so no \u003ccode\u003eUnbondingEntry\u003c/code\u003e is recorded and the underlying INIT / LP can never be claimed. The final staker’s funds are permanently locked and causes a pool‑level denial of service.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003eprocess_xinit_unstake\u003c/code\u003e and \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"13\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_before\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = m_store.staked_amounts[pool];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e      = fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(meta);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunbond\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e supply == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// last holder – give them the entire pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    pool_before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003er\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount, supply);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(r, pool_before)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eGuard against \u003ccode\u003esupply == 0\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eIf it’s the final unstake, transfer the whole remaining pool; otherwise keep the original ratio logic.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"proof-of-concept-4\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"14\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Assume pool index 1 is an LP‑staking pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet pool_idx: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 1: mint exactly 1 Cabal‑LPT to Alice ───────────────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emint_cap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u0026amp;ModuleStore.cabal_stake_token_caps[pool_idx].mint_cap;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal_token::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint_to\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(mint_cap, @alice, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// total supply = 1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 2: Alice initiates unstake of the ENTIRE supply ────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitiate_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esigner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(@alice), pool_idx, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/*\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * inside initiate_unstake:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   • cabal_token::burn(1)            → total supply becomes 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   • schedules process_lp_unstake()  (async)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 3: worker executes queued call ──────────────────────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprocess_lp_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;assets_signer, @alice, pool_idx, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/*\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * inside process_lp_unstake:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   let sx_supply = fungible_asset::supply(lp_metadata);   // == 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   let ratio     = bigdecimal::from_ratio_u128(1, sx_supply);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *                         └────── divide‑by‑zero → abort\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * transaction reverts with EZeroDenominator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\" aria-label=\"m 06 lp redelegation uses inaccurate internal tracker amount leading to potential failures or orphaned funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-185\"\u003e[M-06] LP Redelegation Uses Inaccurate Internal Tracker Amount, Leading to Potential Failures or Orphaned Funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-213\"\u003eedoscoba\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-1\" style=\"position:relative;\"\u003e\u003ca href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eredelegate_lp\u003c/code\u003e function, called during validator changes for LP pools, uses the internal \u003ccode\u003epool.amount\u003c/code\u003e tracker to specify the amount for \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e. This tracker can diverge from the actual staked amount due to unreflected rewards or slashing, potentially causing redelegation failures or leaving funds staked with the old validator.\u003c/p\u003e\n\u003ch3 id=\"finding-description-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-1\" aria-label=\"finding description 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003epool_router::change_validator\u003c/code\u003e function allows the deployer (\u003ccode\u003e@staking_addr\u003c/code\u003e) to migrate staked assets managed by a specific \u003ccode\u003eStakePool\u003c/code\u003e object from one validator to another. For LP token pools, it calls the internal helper function \u003ccode\u003eredelegate_lp\u003c/code\u003e located in \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003epool_router.move#L327-L339\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eredelegate_lp\u003c/code\u003e function constructs a \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e message to be sent via \u003ccode\u003ecosmos::stargate\u003c/code\u003e. The amount of tokens to be redelegated in this message is taken directly from the \u003ccode\u003epool.amount\u003c/code\u003e field of the \u003ccode\u003eStakePool\u003c/code\u003e resource:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"15\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    fun redelegate_lp(pool: \u0026amp;StakePool, new_validator_address: String) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let denom = coin::metadata_to_denom(pool.metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let coin = Coin { denom, amount: pool.amount }; // \u0026lt;\u0026lt;\u0026lt; Uses pool.amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let msg = MsgBeginRedelegate {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // ... other fields ...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            amount: vector[coin] // \u0026lt;\u0026lt;\u0026lt; Amount specified in the message\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cosmos::stargate(\u0026amp;object::generate_signer_for_extending(\u0026amp;pool.ref), marshal(\u0026amp;msg));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ccode\u003epool.amount\u003c/code\u003e is merely an internal counter updated by \u003ccode\u003epool_router::add_stake\u003c/code\u003e and \u003ccode\u003epool_router::unstake\u003c/code\u003e and \u003ccode\u003epool_router::unlock_lp\u003c/code\u003e. It does not automatically reflect changes in the actual staked balance within the underlying \u003ccode\u003emstaking\u003c/code\u003e module due to:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eAccrued Rewards:\u003c/strong\u003e Rewards earned by the staked LP tokens increase the actual delegation shares/amount but are not reflected in \u003ccode\u003epool.amount\u003c/code\u003e until \u003ccode\u003ecompound_lp_pool_rewards\u003c/code\u003e runs (triggered by user actions) and subsequently calls \u003ccode\u003eadd_stake\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSlashing\u003c/strong\u003e: If the validator is slashed, the actual delegation shares/amount decreases, but \u003ccode\u003epool.amount\u003c/code\u003e is never updated to reflect this loss.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eTherefore, \u003ccode\u003epool.amount\u003c/code\u003e can easily drift from the true staked amount. Sending a \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with this potentially inaccurate amount breaks the expectation that the administrative function correctly manages the entirety of the funds associated with the \u003ccode\u003eStakePool\u003c/code\u003e object.\u003c/p\u003e\n\u003ch3 id=\"impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUsing an inaccurate amount in \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e leads to two primary negative outcomes:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eRedelegation Failure\u003c/strong\u003e:If \u003ccode\u003epool.amount\u003c/code\u003e is greater than the actual staked amount (e.g., due to slashing), the underlying \u003ccode\u003emstaking\u003c/code\u003e module will reject the request, causing the \u003ccode\u003ecosmos::stargate\u003c/code\u003e  call and the entire \u003ccode\u003echange_validator\u003c/code\u003e transaction to abort. This prevents the deployer from migrating funds away from a potentially slashed or undesirable validator.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePartial Redelegation / Orphaned Funds:\u003c/strong\u003e If \u003ccode\u003epool.amount\u003c/code\u003e is less than the actual staked amount (e.g., due to accrued rewards not yet reflected), the \u003ccode\u003emstaking\u003c/code\u003e module will likely succeed in redelegating only the specified \u003ccode\u003epool.amount\u003c/code\u003e. The remaining tokens (the difference) will be left staked with the original validator. However, the \u003ccode\u003echange_validator\u003c/code\u003e function proceeds to update \u003ccode\u003epool.validator\u003c/code\u003e to the new address. This creates an inconsistent state where the \u003ccode\u003eStakePool\u003c/code\u003e object points to the new validator, but some funds remain with the old one, potentially becoming difficult to track, manage, or withdraw through the router’s standard logic.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"likelihood\" style=\"position:relative;\"\u003e\u003ca href=\"#likelihood\" aria-label=\"likelihood permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eLikelihood\u003c/h3\u003e\n\u003cp\u003eThe likelihood of \u003ccode\u003epool.amount\u003c/code\u003e becoming inaccurate is \u003cstrong\u003eHigh\u003c/strong\u003e. Staking rewards are expected to accrue over time. If users don’t frequently stake or unstake from a specific LP pool, the \u003ccode\u003ecompound_lp_pool_rewards\u003c/code\u003e function won’t run often, causing \u003ccode\u003epool.amount\u003c/code\u003e to lag behind the actual staked amount (actual \u003e tracker). Slashing events, while less frequent, would cause the tracker to exceed the actual amount. \u003c/p\u003e\n\u003cp\u003eTherefore, drift between \u003ccode\u003epool.amount\u003c/code\u003e and the real staked value is highly likely. The likelihood of this drift causing a problem during a \u003ccode\u003echange_validator\u003c/code\u003e call is \u003cstrong\u003eMedium\u003c/strong\u003e, as it depends on when the deployer chooses to execute this administrative action relative to the drift.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eModify the \u003ccode\u003eredelegate_lp\u003c/code\u003e function to query the actual delegation amount from the underlying \u003ccode\u003emstaking\u003c/code\u003e module before constructing the \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e message. This can be done using a \u003ccode\u003equery_stargate\u003c/code\u003e call similar to the one used in \u003ccode\u003eget_lp_real_stakes\u003c/code\u003e. Use this queried, accurate amount instead of \u003ccode\u003epool.amount\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eApply the following conceptual change (exact query path and response parsing might need adjustment based on Initia’s \u003ccode\u003emstaking\u003c/code\u003e module specifics) to \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003epool_router.move#L327-L339\u003c/a\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"16\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     fun redelegate_lp(pool: \u0026amp;StakePool, new_validator_address: String) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e         let denom = coin::metadata_to_denom(pool.metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e-        let coin = Coin { denom, amount: pool.amount };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let pool_addr = object::address_from_extend_ref(\u0026amp;pool.ref);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Query the actual staked amount instead of relying on the internal tracker\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let path = b\u0026quot;/initia.mstaking.v1.Query/Delegation\u0026quot;; // Adjust path if needed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let request = DelegationRequest { validator_addr: pool.validator, delegator_addr: address::to_sdk(pool_addr) };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let response_bytes = query_stargate(path, marshal(\u0026amp;request));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Note: Need robust parsing and error handling for the query response here.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Assuming successful query and parsing to get the actual_staked_amount:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let actual_staked_amount = parse_delegation_response_amount(response_bytes, denom); // Placeholder for parsing logic\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        assert!(actual_staked_amount \u0026gt; 0, error::invalid_state(0)); // Add appropriate error code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let coin = Coin { denom, amount: actual_staked_amount }; // Use the queried amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e         let msg = MsgBeginRedelegate {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e             _type_: string::utf8(b\u0026quot;/initia.mstaking.v1.MsgBeginRedelegate\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e             delegator_address: to_sdk(object::address_from_extend_ref(\u0026amp;pool.ref)),\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e(Note: The \u003ccode\u003eparse_delegation_response_amount\u003c/code\u003e function is illustrative; the actual implementation would involve using \u003ccode\u003eunmarshal\u003c/code\u003e and navigating the \u003ccode\u003eDelegationResponse\u003c/code\u003e struct as done in \u003ccode\u003eget_lp_real_stakes\u003c/code\u003e to extract the correct amount for the given denom.)\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-5\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eSetup:\u003c/strong\u003e Configure an LP pool using \u003ccode\u003eadd_pool\u003c/code\u003e. Stake some LP tokens via \u003ccode\u003ecabal::stake_asset\u003c/code\u003e (which calls \u003ccode\u003epool_router::add_stake\u003c/code\u003e), setting \u003ccode\u003epool.amount\u003c/code\u003e to, say, 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eScenario 1 (Rewards Accrued):\u003c/strong\u003e Assume rewards accrue in the underlying \u003ccode\u003emstaking\u003c/code\u003e module, increasing the actual staked amount to 1,050,000, but no user actions trigger compounding, so \u003ccode\u003epool.amount\u003c/code\u003e remains 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAction:\u003c/strong\u003e The deployer calls \u003ccode\u003echange_validator\u003c/code\u003e for this pool. \u003ccode\u003eredelegate_lp\u003c/code\u003e is called.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExecution:\u003c/strong\u003e \u003ccode\u003eredelegate_lp\u003c/code\u003e constructs \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with \u003ccode\u003eamount = 1,000,000\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOutcome:\u003c/strong\u003e The \u003ccode\u003emstaking\u003c/code\u003e module successfully redelegates 1,000,000 tokens. 50,000 tokens remain staked with the old validator. \u003ccode\u003echange_validator\u003c/code\u003e updates \u003ccode\u003epool.validator\u003c/code\u003e to the new address. The 50,000 tokens are now potentially orphaned from the router’s perspective.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eScenario 2 (Slashing Occurred):\u003c/strong\u003e Assume the validator was slashed, reducing the actual staked amount to 950,000, but \u003ccode\u003epool.amount\u003c/code\u003e remains 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAction:\u003c/strong\u003e The deployer calls \u003ccode\u003echange_validator\u003c/code\u003e. \u003ccode\u003eredelegate_lp\u003c/code\u003e is called.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExecution:\u003c/strong\u003e \u003ccode\u003ereredelegate_lp\u003c/code\u003e constructs \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with \u003ccode\u003eamount = 1,000,000\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOutcome:\u003c/strong\u003e The \u003ccode\u003emstaking\u003c/code\u003e module rejects the request because only 950,000 tokens are available. The \u003ccode\u003ecosmos::stargate\u003c/code\u003e call fails, causing the \u003ccode\u003echange_validator\u003c/code\u003e transaction to abort. The validator cannot be changed.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\" style=\"position:relative;\"\u003e\u003ca href=\"#m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\" aria-label=\"m 07 desynchronization of cabals internal accounting with actual staked init amounts leads to over minting of sxinit tokens permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-252\"\u003e[M-07] Desynchronization of Cabal’s internal accounting with actual staked INIT amounts leads to over-minting of sxINIT tokens\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-108\"\u003eChainSentry\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-235\"\u003eAfriauditor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-262\"\u003egivn\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-18\"\u003emaze\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-2\" style=\"position:relative;\"\u003e\u003ca href=\"#summary-2\" aria-label=\"summary 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h3\u003e\n\u003cp\u003eThe Cabal Protocol’s implementation of \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e fails to synchronize the protocol’s internal accounting (\u003ccode\u003em_store.staked_amounts\u003c/code\u003e) with the actual amount of INIT tokens staked in the underlying Initia staking system. This creates a vulnerability where external events like slashing penalties or validator-initiated actions that reduce the staked amount are not reflected in Cabal’s internal state. The reward compounding function simply adds claimed rewards to its internal tracking variable without verifying that this matches reality, creating a divergence between what Cabal thinks is staked and what actually is staked. When slashing occurs, users who stake xINIT will receive more sxINIT than they should based on the actual backing ratio. This leads to economic dilution of all sxINIT holders.\u003c/p\u003e\n\u003cp\u003eThis issue is particularly concerning because it compounds over time - each slashing event that goes unaccounted for widens the gap between reported and actual values, eventually leading to significant economic damage for the protocol and its users.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eTechnical Explanation\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eThe core issue lies in the \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e function in \u003ccode\u003ecabal.move\u003c/code\u003e, which is responsible for claiming staking rewards and updating the protocol’s internal state:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"17\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun compound_xinit_pool_rewards(m_store: \u0026amp;mut ModuleStore, pool_index: u64) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let coin_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let reward_fa = pool_router::withdraw_rewards(coin_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let reward_amount = fungible_asset::amount(\u0026amp;reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (reward_amount \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // calculate fee amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_ratio = bigdecimal::from_ratio_u64(m_store.xinit_stake_reward_fee_bps, BPS_BASE);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_amount = bigdecimal::mul_by_u64_truncate(fee_ratio, reward_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_fa = fungible_asset::extract(\u0026amp;mut reward_fa, fee_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let rewards_remaining = reward_amount - fee_amount;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::deposit(package::get_commission_fee_store_address(), fee_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        m_store.stake_reward_amounts[pool_index] = m_store.stake_reward_amounts[pool_index] + rewards_remaining;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        pool_router::add_stake(reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // mint xINIT to pool\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        m_store.staked_amounts[pool_index] = m_store.staked_amounts[pool_index] + rewards_remaining;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        coin::mint_to(\u0026amp;m_store.x_init_caps.mint_cap, package::get_assets_store_address(), rewards_remaining);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        fungible_asset::destroy_zero(reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe issue occurs because this function:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eClaims rewards from the staking system via \u003ccode\u003epool_router::withdraw_rewards\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eProcesses these rewards and restakes them via \u003ccode\u003epool_router::add_stake\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eUpdates \u003ccode\u003em_store.staked_amounts[pool_index]\u003c/code\u003e by simply adding the rewards amount\u003c/li\u003e\n\u003cli\u003eNever verifies that this updated value matches the actual staked amount in the underlying system\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eHowever, the protocol has a function \u003ccode\u003epool_router::get_real_total_stakes\u003c/code\u003e that does query the actual staked amount from the Initia staking system:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"18\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e// From pool_router.move\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epub fun get_real_total_stakes(metadata: Object\u0026lt;Metadata\u0026gt;): u64 {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Sum up all stake amounts from the underlying staking system\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let total_stakes: u64 = 0;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    /* ... */\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let pools = *simple_map::borrow(\u0026amp;router.token_pool_map, \u0026amp;metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (i in 0..vector::length(\u0026amp;pools)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let amount = if (metadata == utils::get_init_metadata()) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            get_init_real_stakes(\u0026amp;pools[i])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            get_lp_real_stakes(\u0026amp;pools[i])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        total_stakes = total_stakes + amount;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    total_stakes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function is never called during reward compounding, leading to the desynchronization.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eThe following scenario demonstrates how this vulnerability can lead to over-minting of sxINIT tokens:\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eInitial state:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e1,000,000,000 INIT staked in the Initia staking system\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e = 1,000,000,000\u003c/li\u003e\n\u003cli\u003eTotal sxINIT supply = 1,000,000,000\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA slashing event occurs in the Initia staking system, reducing the staked INIT by 5%:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eActual staked INIT = 950,000,000\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e still = 1,000,000,000 (unchanged)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRewards of 50,000,000 INIT are claimed via \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFunction adds 50,000,000 to \u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e, making it 1,050,000,000\u003c/li\u003e\n\u003cli\u003eActual staked INIT after adding rewards = 1,000,000,000 (950,000,000 + 50,000,000)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUser comes to stake 100,000,000 xINIT:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAccording to Cabal’s accounting: Exchange rate = 1,050,000,000 INIT / 1,000,000,000 sxINIT = 1.05\u003c/li\u003e\n\u003cli\u003eUser should receive: 100,000,000 / 1.05 = 95,238,095 sxINIT\u003c/li\u003e\n\u003cli\u003eBut the actual exchange rate should be: 1,000,000,000 INIT / 1,000,000,000 sxINIT = 1.0\u003c/li\u003e\n\u003cli\u003eUser should actually receive: 100,000,000 / 1.0 = 100,000,000 sxINIT\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe discrepancy:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUser receives 95,238,095 sxINIT\u003c/li\u003e\n\u003cli\u003eThese tokens are backed by only 90,702,948 INIT (95,238,095 * 1,000,000,000 / 1,050,000,000)\u003c/li\u003e\n\u003cli\u003eThis means the user has been short-changed by 4,761,905 INIT worth of backing\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe issue becomes even more severe with multiple slashing events and/or larger stake amounts.\u003c/p\u003e\n\u003ch3 id=\"impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThe impact of this vulnerability is significant and affects multiple areas:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eViolation of Core Protocol Invariants\u003c/strong\u003e: The fundamental invariant \u003ccode\u003e1 xINIT ≈ 1 INIT\u003c/code\u003e is broken. This undermines the entire economic model of the protocol as described in the documentation.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eEconomic Dilution\u003c/strong\u003e: When new users stake xINIT and receive sxINIT based on incorrect exchange rates, they get fewer tokens than they should. This effectively transfers value from new users to existing sxINIT holders.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eSystemic Risk\u003c/strong\u003e: Each uncorrected slashing event compounds the problem. Over time, the divergence between tracked and actual amounts could become severe, potentially leading to:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLoss of user confidence in the protocol\u003c/li\u003e\n\u003cli\u003eInability to properly value sxINIT tokens\u003c/li\u003e\n\u003cli\u003eDifficulty in integrating with other DeFi protocols due to unreliable pricing\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUnbonding Issues\u003c/strong\u003e: When users try to unstake their sxINIT tokens, they might not receive the expected amount of xINIT back, leading to unexpected losses.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis issue affects all users of the Cabal Protocol, with the severity increasing over time as more slashing events occur without correction.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eSync with Reality\u003c/strong\u003e: Modify the \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e function to query the actual staked amounts after claiming rewards.\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"disclosures\" style=\"position:relative;\"\u003e\u003ca href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDisclosures\u003c/h1\u003e\n\u003cp\u003eC4 is an open organization governed by participants in the community.\u003c/p\u003e\n\u003cp\u003eC4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\u003c/p\u003e\n\u003cp\u003eC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\u003c/p\u003e\n\u003cstyle class=\"grvsc-styles\"\u003e\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line \u003e * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting \u003e .grvsc-code \u003e .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n\u003c/style\u003e"])</script><script>self.__next_f.push([1,"16:T99f,"])</script><script>self.__next_f.push([1,"\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#overview\"\u003eOverview\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#about-c4\"\u003eAbout C4\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#scope\"\u003eScope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#severity-criteria\"\u003eSeverity Criteria\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#high-risk-findings-1\"\u003eHigh Risk Findings (1)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\"\u003e[H-01] LP unstaking only burns the shares but leaves the underlying tokens in the system, which distorts the shares-to-tokens ratio and leads to incorrect amounts being calculated during staking and unstaking\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#medium-risk-findings-7\"\u003eMedium Risk Findings (7)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\"\u003e[M-01] Reentrancy Check in \u003ccode\u003elock_staking::reentry_check\u003c/code\u003e Causes Concurrent INIT Deposit Failures (DOS)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\"\u003e[M-02] Unstaking calculates user share at request time, ignoring slashing — leading to DoS and unfair distribution\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\"\u003e[M-03] Attacker Can Desynchronize Supply Snapshot During Same-Block Unstake, Reducing Everyone’s Rewards\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\"\u003e[M-04] Unstaking from LP pools will cause underflow and lock user funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-05-last-holder-cant-exit-zerosupply-unstake-reverts\"\u003e[M-05] Last Holder Can’t Exit, Zero‑Supply Unstake Reverts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\"\u003e[M-06] LP Redelegation Uses Inaccurate Internal Tracker Amount, Leading to Potential Failures or Orphaned Funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\"\u003e[M-07] Desynchronization of Cabal’s internal accounting with actual staked INIT amounts leads to over-minting of sxINIT tokens\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#disclosures\"\u003eDisclosures\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"19:T258f8,"])</script><script>self.__next_f.push([1,"\u003ch1 id=\"overview\" style=\"position:relative;\"\u003e\u003ca href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eOverview\u003c/h1\u003e\n\u003ch2 id=\"about-c4\" style=\"position:relative;\"\u003e\u003ca href=\"#about-c4\" aria-label=\"about c4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eAbout C4\u003c/h2\u003e\n\u003cp\u003eCode4rena (C4) is a competitive audit platform where security researchers, referred to as Wardens, review, audit, and analyze codebases for security vulnerabilities in exchange for bounties provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eA C4 audit is an event in which community participants, referred to as Wardens, review, audit, or analyze smart contract logic in exchange for a bounty provided by sponsoring projects.\u003c/p\u003e\n\u003cp\u003eDuring the audit outlined in this document, C4 conducted an analysis of the Cabal Liquid Staking Token smart contract system. The audit took place from April 28 to May 05, 2025.\u003c/p\u003e\n\u003cp\u003eFinal report assembled by Code4rena.\u003c/p\u003e\n\u003ch1 id=\"summary\" style=\"position:relative;\"\u003e\u003ca href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h1\u003e\n\u003cp\u003eThe C4 analysis yielded an aggregated total of 8 unique vulnerabilities. Of these vulnerabilities, 1 received a risk rating in the category of HIGH severity and 7 received a risk rating in the category of MEDIUM severity.\u003c/p\u003e\n\u003cp\u003eAll of the issues presented here are linked back to their original finding, which may include relevant context from the judge and Cabal team.\u003c/p\u003e\n\u003ch1 id=\"scope\" style=\"position:relative;\"\u003e\u003ca href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eScope\u003c/h1\u003e\n\u003cp\u003eThe code under review can be found within the \u003ca href=\"https://github.com/code-423n4/2025-04-cabal\"\u003eC4 Cabal Liquid Staking Token repository\u003c/a\u003e, and is composed of 8 smart contracts written in the Move programming language and includes 2,574 lines of Move code.\u003c/p\u003e\n\u003ch1 id=\"severity-criteria\" style=\"position:relative;\"\u003e\u003ca href=\"#severity-criteria\" aria-label=\"severity criteria permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSeverity Criteria\u003c/h1\u003e\n\u003cp\u003eC4 assesses the severity of disclosed vulnerabilities based on three primary risk categories: high, medium, and low/non-critical.\u003c/p\u003e\n\u003cp\u003eHigh-level considerations for vulnerabilities span the following key areas when conducting assessments:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMalicious Input Handling\u003c/li\u003e\n\u003cli\u003eEscalation of privileges\u003c/li\u003e\n\u003cli\u003eArithmetic\u003c/li\u003e\n\u003cli\u003eGas use\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFor more information regarding the severity criteria referenced throughout the submission review process, please refer to the documentation provided on \u003ca href=\"https://code4rena.com\"\u003ethe C4 website\u003c/a\u003e, specifically our section on \u003ca href=\"https://docs.code4rena.com/awarding/judging-criteria/severity-categorization\"\u003eSeverity Categorization\u003c/a\u003e.\u003c/p\u003e\n\u003ch1 id=\"high-risk-findings-1\" style=\"position:relative;\"\u003e\u003ca href=\"#high-risk-findings-1\" aria-label=\"high risk findings 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eHigh Risk Findings (1)\u003c/h1\u003e\n\u003ch2 id=\"h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\" style=\"position:relative;\"\u003e\u003ca href=\"#h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\" aria-label=\"h 01 lp unstaking only burns the shares but leaves the underlying tokens in the system which distorts the shares to tokens ratio and leads to incorrect amounts being calculated during staking and unstaking permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-156\"\u003e[H-01] LP unstaking only burns the shares but leaves the underlying tokens in the system, which distorts the shares-to-tokens ratio and leads to incorrect amounts being calculated during staking and unstaking\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-176\"\u003eTheSchnilch\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-232\"\u003eret2basic\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description\" aria-label=\"finding description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description\u003c/h3\u003e\n\u003cp\u003eWhen a user unstakes LP tokens, the corresponding shares (Cabal tokens) are burned. However, the actual undelegation from the validator will occur only after a delay of up to 3 days. During this period, the shares are already burned, but the underlying tokens are still included in shares-to-token conversions.\nThis is a problem because, in \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e, the amount of tokens to unbond is calculated as follows:\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1054\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003elp_amount\u003c/code\u003e is calculated based on the amount of tokens actually staked on the validator. This includes tokens that are pending to be undelegated (\u003ccode\u003eunstaked_pending_amounts\u003c/code\u003e), for which the Cabal tokens have already been burned.\u003c/p\u003e\n\u003cp\u003eThis means that the \u003ccode\u003eunbonding_amount\u003c/code\u003e is also calculated incorrectly because the \u003ccode\u003elp_amount\u003c/code\u003e is too high. As a result, the \u003ccode\u003eunbonding_amount\u003c/code\u003e will also be too high, and the unstaker will receive too many tokens that are actually belonging to other users.\u003c/p\u003e\n\u003cp\u003eSince the Cabal tokens a user receives are also calculated this way in \u003ccode\u003eprocess_lp_stake\u003c/code\u003e, users will receive too few shares when there are pending undelegations. As a result, they will have fewer tokens after the next \u003ccode\u003ebatch_undelegate_pending_lps\u003c/code\u003e:\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L946-L953\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"impact\" style=\"position:relative;\"\u003e\u003ca href=\"#impact\" aria-label=\"impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eBecause users receive too many tokens that actually belong to other users, and since this issue occurs during normal unstaking and staking, it is high severity.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps\" aria-label=\"recommended mitigation steps permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eunstaked_pending_amounts\u003c/code\u003e should be subtracted from the \u003ccode\u003elp_amount\u003c/code\u003e to correctly account for the pending tokens to be undelegated, for which the Cabal tokens have already been burned.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept\" aria-label=\"proof of concept permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"0\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    #[test(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        c = @staking_addr, user_a = @0xAAA, user_b = @0xBBB, user_c = @0xCCC\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    )]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    fun test_poc(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        c: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_a: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_b: \u0026amp;signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        user_c: \u0026amp;signer\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    ) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        test_setup(c, string::utf8(b\u0026quot;initvaloper1test\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //gets the metadata for all tokens\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ulp_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;ulp\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let init_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let cabal_lp_metadata = cabal::get_cabal_token_metadata(1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let x_init_metadata = cabal::get_xinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let sx_init_metadata = cabal::get_sxinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let initia_signer = \u0026amp;account::create_signer_for_test(@initia_std);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ulp_decimals = 1_000_000; //ulp has 6 decimals\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let deposit_amount_a = 100 * ulp_decimals; //the amount user a deposits\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::transfer( //user a must first be funded\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            initia_signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ulp_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            signer::address_of(user_a),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            deposit_amount_a\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_stake(user_a, 1, deposit_amount_a); //user a stakes 100 ulp\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let deposit_amount_b = 50 * ulp_decimals; //the amount user b stakes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::transfer(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            initia_signer,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            ulp_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            signer::address_of(user_b),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            deposit_amount_b\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_stake(user_b, 1, deposit_amount_b); //user b stakes 50 ulp\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_unstake(user_b, 1, deposit_amount_b); //user b unstakes 50 ulp this means the cabal tokens are now 100 and the underlying tokens 150\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //This mock unstaking uses the pool balances instead of querying the validator because Cosmos is not supported during testing. \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        //However, this is not a problem, since the pools are only modified after the undelegation, not during the unstaking\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        utils::increase_block(1, 1000);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cabal::mock_unstake(user_a, 1, 50 * ulp_decimals); //user a unstakes half of his cabal lp tokens for which 50 ulp tokens should be unstaked but actually 75 are getting unstaked\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can also add \u003ccode\u003edebug::print(\u0026#x26;unbonding_amount);\u003c/code\u003e to line 1334 in cabal.move to verify that 75 ULP tokens are being unstaked instead of 50.\u003c/p\u003e\n\u003cp\u003eTo run the POC, paste it into the file \u003ccode\u003etests/core_staking_test.move\u003c/code\u003e and run the command \u003ccode\u003einitiad move test -f test_poc\u003c/code\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"medium-risk-findings-7\" style=\"position:relative;\"\u003e\u003ca href=\"#medium-risk-findings-7\" aria-label=\"medium risk findings 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eMedium Risk Findings (7)\u003c/h1\u003e\n\u003ch2 id=\"m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\" style=\"position:relative;\"\u003e\u003ca href=\"#m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\" aria-label=\"m 01 reentrancy check in lock_stakingreentry_check causes concurrent init deposit failures dos permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-27\"\u003e[M-01] Reentrancy Check in \u003ccode\u003elock_staking::reentry_check\u003c/code\u003e Causes Concurrent INIT Deposit Failures (DOS)\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-29\"\u003erare_one\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L632C5-#L661\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact\" aria-label=\"finding description and impact permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eThe liquid staking protocol’s \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e function, which allows users to deposit INIT tokens to receive xINIT, is vulnerable to transaction failures when multiple users deposit concurrently in the same block. The function withdraws INIT tokens and delegates them to a validator via \u003ccode\u003epool_router::add_stake\u003c/code\u003e, which triggers \u003ccode\u003elock_staking::delegate\u003c/code\u003e. This, in turn, invokes \u003ccode\u003ereentry_check\u003c/code\u003e to prevent multiple delegations in the same block. \u003c/p\u003e\n\u003cp\u003eIf a second user attempts to deposit in the same block as another, their transaction fails with error code 196618 (EREENTER), as \u003ccode\u003ereentry_check\u003c/code\u003e detects that the StakingAccount was already modified in the current block. This vulnerability disrupts users’ ability to participate in the protocol, particularly during periods of high transaction activity.\u003c/p\u003e\n\u003ch3 id=\"root-cause\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause:\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003ereentry_check\u003c/code\u003e function in lock_staking.move enforces a strict one-delegation-per-block rule for a given StakingAccount:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"1\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun reentry_check(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    staking_account: \u0026amp;mut StakingAccount, \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    with_update: bool\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let (height, _) = block::get_block_info();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(staking_account.last_height != height, error::invalid_state(EREENTER));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (with_update) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        staking_account.last_height = height;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function checks if \u003ccode\u003estaking_account.last_height\u003c/code\u003e equals the current block height and aborts with EREENTER if true. If \u003ccode\u003ewith_update\u003c/code\u003e is true, it updates \u003ccode\u003elast_height\u003c/code\u003e to the current height, marking the block as processed.\u003c/p\u003e\n\u003cp\u003eIn cabal.move, the \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e function processes user deposits independently:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"2\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epublic entry fun deposit_init_for_xinit(account: \u0026amp;signer, deposit_amount: u64) acquires ModuleStore {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    emergency::assert_no_paused();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(deposit_amount \u0026gt; 0, error::invalid_argument(EINVALID_COIN_AMOUNT));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let m_store = borrow_global\u0026lt;ModuleStore\u0026gt;(@staking_addr);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let coin_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // calculate mint xinit\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let init_amount = pool_router::get_real_total_stakes(coin_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let x_init_amount = option::extract(\u0026amp;mut fungible_asset::supply(m_store.x_init_metadata));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let mint_x_init_amount = if (x_init_amount == 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deposit_amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let ratio = bigdecimal::from_ratio_u64(deposit_amount, init_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // Round up because of truncation\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        (bigdecimal::mul_by_u128_ceil(ratio, x_init_amount) as u64)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(mint_x_init_amount \u0026gt; 0, error::invalid_argument(EINVALID_STAKE_AMOUNT));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // withdraw init to stake\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let fa = primary_fungible_store::withdraw(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        account,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        coin_metadata,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        deposit_amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    );\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    pool_router::add_stake(fa); // Triggers lock_staking::delegate\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // mint xINIT to user\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    coin::mint_to(\u0026amp;m_store.x_init_caps.mint_cap, signer::address_of(account), mint_x_init_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhen multiple users call \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e in the same block:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe first user’s deposit passes \u003ccode\u003ereentry_check\u003c/code\u003e, updates \u003ccode\u003estaking_account.last_height\u003c/code\u003e to the current block height (assuming \u003ccode\u003ewith_update = true\u003c/code\u003e in \u003ccode\u003elock_staking::delegate\u003c/code\u003e), and completes, minting xINIT.\u003c/li\u003e\n\u003cli\u003eThe second user’s deposit triggers \u003ccode\u003ereentry_check\u003c/code\u003e via \u003ccode\u003epool_router::add_stake\u003c/code\u003e and \u003ccode\u003elock_staking::delegate\u003c/code\u003e. Since \u003ccode\u003estaking_account.last_height\u003c/code\u003e equals the current height, the transaction aborts with EREENTER, preventing the deposit and xINIT minting.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe function’s lack of coordination for concurrent deposits results in multiple \u003ccode\u003elock_staking::delegate\u003c/code\u003e calls, triggering the reentrancy failure. This vulnerability is evident in production scenarios where users deposit INIT during high network activity, such as during market events or protocol launches.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eIMPACTS:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eDenial-of-Service (DoS) for Users: Users attempting to deposit INIT in a block with multiple deposits will face transaction failures, losing gas fees and being unable to receive xINIT. This disrupts their ability to participate in liquid staking, particularly during peak usage periods.\u003c/p\u003e\n\u003cp\u003eFinancial Loss: Failed transactions result in gas fee losses for users, which can accumulate significantly in high-traffic scenarios, deterring participation.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-1\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-1\" aria-label=\"recommended mitigation steps 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eImplement a batching mechanism to aggregate all user INIT deposits within a block and process them as a single delegation, ensuring only one call to \u003ccode\u003elock_staking::delegate\u003c/code\u003e per block and bypassing the \u003ccode\u003ereentry_check\u003c/code\u003e restriction.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-1\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-1\" aria-label=\"proof of concept 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eInitialize the protocol using initialize to set up the xINIT pool.\u003c/p\u003e\n\u003cp\u003eSimulate two users depositing INIT in the same block using mock\u003cem\u003edeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit.\u003c/p\u003e\n\u003cp\u003eObserve the EREENTER error (code 196618) from reentry_check for the second deposit.\u003c/p\u003e\n\u003cp\u003e// User 1 transaction (submitted in block 100)\npublic entry fun user1\u003cem\u003edeposit(account: \u0026#x26;signer) {\ndeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit(account, 500\u003cem\u003e000\u003c/em\u003e000);\n}\u003c/p\u003e\n\u003cp\u003e// User 2 transaction (submitted in block 100)\npublic entry fun user2\u003cem\u003edeposit(account: \u0026#x26;signer) {\ndeposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit(account, 200\u003cem\u003e000\u003c/em\u003e000);\n}\u003c/p\u003e\n\u003cp\u003eSetup:\u003c/p\u003e\n\u003cp\u003eDeploy the protocol and initialize it.\u003c/p\u003e\n\u003cp\u003eFund User 1 (@0x1) with 500,000,000 INIT and User 2 (@0x2) with 200,000,000 INIT.\u003c/p\u003e\n\u003cp\u003eSet block height to 100.\u003c/p\u003e\n\u003cp\u003eUser 1 submits user1\u003cem\u003edeposit in block 100, calling `deposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit\u003ccode\u003e, withdrawing 500,000,000 INIT, delegating via\u003c/code\u003epool\u003cem\u003erouter::add\u003c/em\u003estake\u003ccode\u003e(triggering\u003c/code\u003elock_staking::delegate`), and minting approximately 500,000,000 xINIT (adjusted for pool size).\u003c/p\u003e\n\u003cp\u003eUser 2 submits user2\u003cem\u003edeposit in block 100, calling `deposit\u003c/em\u003einit\u003cem\u003efor\u003c/em\u003exinit\u003ccode\u003e, but\u003c/code\u003epool\u003cem\u003erouter::add\u003c/em\u003estake\u003ccode\u003etriggers\u003c/code\u003elock\u003cem\u003estaking::delegate\u003ccode\u003eand\u003c/code\u003ereentry\u003c/em\u003echeck\u003ccode\u003e. Since\u003c/code\u003estaking\u003cem\u003eaccount.last\u003c/em\u003eheight` equals 100 (from User 1’s deposit), the transaction aborts with EREENTER (code 196618).\u003c/p\u003e\n\u003cp\u003eResult:\u003c/p\u003e\n\u003cp\u003eUser 1: Receives ~500,000,000 xINIT.\u003c/p\u003e\n\u003cp\u003eUser 2: Transaction fails, loses gas fees, receives no xINIT.\u003c/p\u003e\n\u003cp\u003eThis test demonstrates the issue\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"3\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun test_concurrent_deposits(c: \u0026amp;signer, user_a: \u0026amp;signer, user_b: \u0026amp;signer) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    test_setup(c, string::utf8(b\u0026quot;initvaloper1test\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let init_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let x_init_metadata = cabal::get_xinit_metadata();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Transfer INIT to users\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let deposit_a = 500_000_000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let deposit_b = 200_000_000;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_a), deposit_a);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    primary_fungible_store::transfer(c, init_metadata, signer::address_of(user_b), deposit_b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Simulate concurrent deposits (no block increase between them)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cabal::mock_deposit_init_for_xinit(user_a, deposit_a);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    cabal::mock_deposit_init_for_xinit(user_b, deposit_b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    utils::increase_block(1, 1);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify xINIT balances\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let user_a_xinit = primary_fungible_store::balance(signer::address_of(user_a), x_init_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let user_b_xinit = primary_fungible_store::balance(signer::address_of(user_b), x_init_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(user_a_xinit == deposit_a || user_a_xinit == deposit_a - 1, 1007);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(user_b_xinit == deposit_b || user_b_xinit == deposit_b - 1, 1008);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Verify global state\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let final_xinit_supply = cabal::get_xinit_total_supply();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let final_total_staked_init = cabal::get_pool_router_total_init();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(final_xinit_supply == (MINIMUM_LIQUIDITY as u128) + (deposit_a as u128) + (deposit_b as u128), 1009);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    assert!(final_total_staked_init == MINIMUM_LIQUIDITY + deposit_a + deposit_b, 1010);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand the result\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"solidity\" data-index=\"4\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eFailures\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0xe472ba1c00b2ee2b007b4c5788839d6fb7371c6\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::core_staking_test:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e┌── \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest_concurrent_deposits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ──────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eE11001\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailure\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      ┌─ ././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1226\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e9\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1222\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e │     \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ereentry_check\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │         ------------- \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eIn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ethis\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003efunction\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e 0\u003c/span\u003e\u003cspan class=\"mtk11\"\u003exe55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elock_staking\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      ·\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ 1226 │         \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eassert\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e!(staking_account.last_height != \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eheight\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk10\"\u003einvalid_state\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk10\"\u003eEREENTER\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│      │         ^^^^^^ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewas\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003enot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eexpected\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eto\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eerror\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eaborted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ewith\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecode\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e196618\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eoriginating\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ethe\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk10\"\u003emodule\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ee55cc823efb411bed5eed25aca5277229a54c62ab3769005f86cc44bc0c0e5ab\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erooted\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ehere\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003cspan class=\"mtk12\"\u003estack\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etrace\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate_internal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e715\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003edelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(././\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evip\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk12\"\u003econtract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elock_staking\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e256\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_process_delegate_init\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e608\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e-\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e614\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_add_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_router\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e630\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecabal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emock_deposit_init_for_xinit\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003esources\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecabal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1196\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│       \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore_staking_test\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_concurrent_deposits\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(./\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etests\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e/\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecore_staking_test\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emove\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e780\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e│ \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e└──────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eTest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eresult\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eFAILED\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e. \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eTotal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etests\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epassed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efailed\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\" style=\"position:relative;\"\u003e\u003ca href=\"#m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\" aria-label=\"m 02 unstaking calculates user share at request time ignoring slashing  leading to dos and unfair distribution permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-83\"\u003e[M-02] Unstaking calculates user share at request time, ignoring slashing — leading to DoS and unfair distribution\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-86\"\u003e0xAlix2\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-279\"\u003eadam-idarrha\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-263\"\u003egivn\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-179\"\u003emaxzuvex\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-173\"\u003eTheSchnilch\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1075-L1080\u003c/a\u003e\n\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1017-L1022\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-1\" aria-label=\"finding description and impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description and Impact\u003c/h3\u003e\n\u003cp\u003eUsers can stake both INIT and LP tokens into different validator pools by calling functions like \u003ccode\u003edeposit_init_for_xinit\u003c/code\u003e or \u003ccode\u003estake_asset\u003c/code\u003e. To exit, users initiate an unstake via \u003ccode\u003einitiate_unstake\u003c/code\u003e, which starts an unbonding period. After this delay, they can claim their tokens through \u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBehind the scenes, these staked assets are delegated to validators, and slashing may occur—meaning a portion of the delegated tokens could be penalized (burned). To stay accurate, the protocol uses \u003ccode\u003epool_router::get_real_total_stakes\u003c/code\u003e to track the current delegated amount. However, the current unstaking flow doesn’t properly account for slashing events that may occur during the unbonding period.\u003c/p\u003e\n\u003cp\u003eWhen a user initiates an unstake, either \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e or \u003ccode\u003eprocess_xinit_unstake\u003c/code\u003e is called. For simplicity, we focus on \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIn \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L1043C1-L1083C6\"\u003e\u003ccode\u003eprocess_lp_unstake\u003c/code\u003e\u003c/a\u003e, the claimable amount is calculated up front at unstake time:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"5\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e reward_amount = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecompound_lp_pool_rewards\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(m_store, unstaking_type);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e lp_amount = reward_amount + pool_router::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_real_total_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(...);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_lp_amount = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(...);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e ratio = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount as \u003c/span\u003e\u003cspan class=\"mtk4\"\u003eu128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, cabal_lp_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e unbonding_amount = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(ratio, lp_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003evector::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003epush_back\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk4\"\u003emut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_store.unbonding_entries, UnbondingEntry {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    amount: unbonding_amount,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLater, in \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/main/sources/cabal.move#L711C22-L750\"\u003e\u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e\u003c/a\u003e, this precomputed amount is blindly transferred to the user:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"rust\" data-index=\"6\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003eprimary_fungible_store::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003etransfer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u0026amp;package::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_assets_store_signer\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(),\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    metadata,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    account_addr,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    amount \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ← Precomputed at unstake time\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis design introduces a critical flaw: it assumes the pool value remains constant between unstake and claim, which is not guaranteed. If slashing happens during this period:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA large user may claim more than the pool holds → DoS\u003c/li\u003e\n\u003cli\u003eAn early user may claim full value post-slash → Other users absorb full loss\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eNB:\u003c/strong\u003e\nThis differs from systems like Lido, where the amount returned is computed at claim time based on the user’s share of the pool, ensuring fair slashing distribution.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-2\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-2\" aria-label=\"recommended mitigation steps 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended Mitigation Steps\u003c/h3\u003e\n\u003cp\u003eInstead of locking in the claimable amount at unstake time, store the user’s \u003cstrong\u003epercentage share\u003c/strong\u003e of the total LP supply. Then, during \u003ccode\u003eclaim_unbonded_assets\u003c/code\u003e, recalculate the actual amount using the current pool value (i.e., post-slash).\u003c/p\u003e\n\u003cp\u003eThis ensures slashing risk is shared proportionally among all stakers, and prevents DoS or overclaiming exploits.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-2\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-2\" aria-label=\"proof of concept 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eCase 1 – Whale Unstakes 50%, Then Pool Is Slashed by 51%\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eScenario:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTotal pool value: 1,000 LP tokens\u003c/li\u003e\n\u003cli\u003eA whale holds 500 LP and unstakes it, expecting to claim 500 units\u003c/li\u003e\n\u003cli\u003eThe remaining users hold the other 500 LP\u003c/li\u003e\n\u003cli\u003eBefore the whale claims, the pool is slashed by 51%, reducing it to 490 units\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCurrent behavior (problem):\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe whale still tries to claim 500 units\u003c/li\u003e\n\u003cli\u003eThe pool only has 490 units left → this would revert, fail, or break accounting\u003c/li\u003e\n\u003cli\u003eEssentially, the whale locks in a pre-slash value and now the pool can’t fulfill it\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eWhat should happen:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eClaim should be recalculated at execution time\u003c/li\u003e\n\u003cli\u003e500 LP × (490 / 1000) = 245 units\u003c/li\u003e\n\u003cli\u003eWhale gets 245 units, the rest of the pool reflects that slashing fairly across all holders\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCase 2 – Early User Unstakes, Pool Slashed, Claims Full Amount\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eScenario:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePool has 1,000 LP total\u003c/li\u003e\n\u003cli\u003eUser A holds 100 LP, unstakes and expects 100 units\u003c/li\u003e\n\u003cli\u003eUser B holds 900 LP\u003c/li\u003e\n\u003cli\u003eA 50% slash hits before User A claims → pool is now worth 500 units\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eCurrent behavior (problem):\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUser A claims 100 units (based on original rate)\u003c/li\u003e\n\u003cli\u003eOnly 400 units remain for User B’s 900 LP\u003c/li\u003e\n\u003cli\u003eThat means User B absorbs the full impact of the slash — clearly unfair\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eWhat should happen:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eClaim is based on current pool state\u003c/li\u003e\n\u003cli\u003e100 LP × (500 / 1000) = 50 units\u003c/li\u003e\n\u003cli\u003eUser A gets 50 units, User B’s 900 LP is worth 450 → everyone shares the slash proportionally\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\" style=\"position:relative;\"\u003e\u003ca href=\"#m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\" aria-label=\"m 03 attacker can desynchronize supply snapshot during same block unstake reducing everyones rewards permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-125\"\u003e[M-03] Attacker Can Desynchronize Supply Snapshot During Same-Block Unstake, Reducing Everyone’s Rewards\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-135\"\u003emaxzuvex\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-117\"\u003e0xAlix2\u003c/a\u003e and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-177\"\u003eTheSchnilch\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal_token.move#L219-L227\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-2\" aria-label=\"finding description and impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eAn attacker holding Cabal LSTs (like sxINIT) can monitor the mempool for the manager’s \u003ccode\u003evoting_reward::snapshot()\u003c/code\u003e transaction. By submitting his own \u003ccode\u003ecabal::initiate_unstake\u003c/code\u003e transaction to execute in the \u003cem\u003esame block\u003c/em\u003e (\u003ccode\u003eH\u003c/code\u003e) as the manager’s snapshot, the attacker can use two flaws:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::burn\u003c/code\u003e (called by their unstake) doesn’t update the supply snapshot for block \u003ccode\u003eH\u003c/code\u003e, leaving the recorded supply artificially high (pre-burn).\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::check_snapshot\u003c/code\u003e skips recording the attacker’s \u003cem\u003eown\u003c/em\u003e balance for block \u003ccode\u003eH\u003c/code\u003e.\nLater reward calculations use the stale high supply but retrieve the attacker’s now lower (post-burn) balance via fallback logic. This desynchronization causes the total calculated reward shares to be less than 100%, reducing the rewards paid out to \u003cem\u003eall\u003c/em\u003e users for that cycle.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eAttacker Exploit:\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eManager Snapshots Supply:\u003c/strong\u003e \u003ccode\u003evoting_reward::snapshot\u003c/code\u003e triggers \u003ccode\u003ecabal_token::snapshot\u003c/code\u003e, recording the LST total supply (\u003ccode\u003eS₀\u003c/code\u003e) for block \u003ccode\u003eH\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUser Unstakes (Same Block H):\u003c/strong\u003e The user calls \u003ccode\u003ecabal::initiate_unstake\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eInternally, \u003ccode\u003ecabal_token::check_snapshot\u003c/code\u003e is called but \u003cstrong\u003eskips writing\u003c/strong\u003e the user’s pre-burn balance for block \u003ccode\u003eH\u003c/code\u003e due to same-block logic.\u003c/li\u003e\n\u003cli\u003eThe user’s live balance decreases.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecabal_token::burn\u003c/code\u003e executes, reducing the live supply, but \u003cstrong\u003efails to update\u003c/strong\u003e the recorded supply snapshot for \u003ccode\u003eH\u003c/code\u003e (which remains \u003ccode\u003eS₀\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eReward Calculation Uses Inconsistent State:\u003c/strong\u003e Later, rewards for cycle \u003ccode\u003eH\u003c/code\u003e are calculated:\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eget_snapshot_supply(H)\u003c/code\u003e returns the stale, \u003cstrong\u003epre-burn \u003ccode\u003eS₀\u003c/code\u003e\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eget_snapshot_balance(user, H)\u003c/code\u003e finds no user snapshot for \u003ccode\u003eH\u003c/code\u003e and falls back, returning the user’s \u003cstrong\u003elive, post-burn balance\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eResult:\u003c/strong\u003e The reward share calculation uses \u003ccode\u003epost_burn_balance / pre_burn_supply\u003c/code\u003e, causing the sum of all shares to be \u0026#x3C; 1, thus reducing payouts for everyone. An attacker triggers this by ensuring their \u003ccode\u003einitiate_unstake\u003c/code\u003e executes in the same block as the manager’s \u003ccode\u003esnapshot\u003c/code\u003e (e.g., via mempool monitoring).\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"7\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 1. In `cabal_token::burn` (called by attacker\u0026#39;s `initiate_unstake` in block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003epublic fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(burn_cap: \u0026amp;BurnCapability, fa: FungibleAsset) acquires ManagingRefs, HolderStore, ModuleStore { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Added missing acquires for context\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emetadata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = burn_cap.metadata;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emetadata_addr\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = object::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eobject_address\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;metadata);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    assert!(exists\u0026lt;ManagingRefs\u0026gt;(metadata_addr), EMANAGING_REFS_NOT_FOUND);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003erefs\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = borrow_global\u0026lt;ManagingRefs\u0026gt;(metadata_addr);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Burn reduces the LIVE supply\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eburn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;refs.burn_ref, fa);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 1 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: This function is called in block H AFTER cabal_token::snapshot recorded\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// the supply. However, UNLIKE mint_to, this function DOES NOT check if it\u0026#39;s the snapshot\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// block and DOES NOT update the HolderStore::supply_snapshots table for block H.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// The recorded supply for H remains the stale, pre-burn value (S₀).\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e/* Missing logic similar to mint_to:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e        if (is_snapshot_block) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e            update supply_snapshots table with new (lower) supply S₁;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e    */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 2. In `cabal_token::check_snapshot` (called during attacker\u0026#39;s unstake in block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003efun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003echeck_snapshot\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(c_balance: \u0026amp;mut CabalBalance, current_snapshot_block: u64, prev_snapshot_block: Option\u0026lt;u64\u0026gt;) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ecurrent_block_height\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = block::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_current_block_height\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esnapshot_block\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = current_snapshot_block; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 2 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (current_block_height == current_snapshot_block) { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// TRUE (H == H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: This condition is met.The logic inside prevents writing\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// the attacker\u0026#39;s PRE-BURN balance to their personal snapshot table for block H.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eis_none\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;prev_snapshot_block)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e            \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Early return, no write for H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Tries to write for Previous_H instead, still no write for H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esnapshot_block\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;mut prev_snapshot_block);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// The code path that writes `table::add(\u0026amp;mut c_balance.snapshot, key, c_balance.balance)`\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// requires `current_block_height \u0026gt; snapshot_block`, which is FALSE here.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// RESULT: Attacker\u0026#39;s balance for H is NOT recorded.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// 3. In `cabal_token::get_snapshot_balance_internal` (called during reward calculation for block H)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eget_snapshot_balance_internal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(cabal_balance: \u0026amp;CabalBalance, block_height: u64): u64 { \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// block_height is H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... start_block check ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Search attacker\u0026#39;s personal table for entry \u0026gt;= H\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ekey\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = table_key::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eencode_u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(block_height);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eiter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = table::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eiter\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;cabal_balance.snapshot, option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esome\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(key), option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enone\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(), \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e2\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY PART 3 ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Because the write was skipped (Vuln Part 2), no entry \u0026gt;= H is found for the attacker.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (!table::prepare\u0026lt;vector\u0026lt;u8\u0026gt;, u64\u0026gt;(iter)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ATTACKER EXPLOIT: Fallback logic returns the attacker\u0026#39;s LIVE balance.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// At this point (reward calculation time), the live balance is the POST-BURN balance.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk15\"\u003ereturn\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e cabal_balance.balance;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    };\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This part is not reached for the attacker in this scenario\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let (_, balance) = table::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003enext\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(iter);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    *balance\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eImpact:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eInvariant violation\u003c/strong\u003e\u003cbr\u003e\nThe attack breaks the core guarantee \u003ccode\u003eΣ balances_H = supply_H\u003c/code\u003e. Because the attacker’s balance is recorded \u003cem\u003eafter\u003c/em\u003e the burn while the supply is recorded \u003cem\u003ebefore\u003c/em\u003e, the numerator shrinks but the denominator stays high.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUniversal reward loss\u003c/strong\u003e\u003cbr\u003e\nReward shares now sum to \u003cstrong\u003e\u0026#x3C; 1\u003c/strong\u003e, so the bribe contract distributes fewer tokens than were deposited. Every honest staker at snapshot H loses part of their yield; the missing amount remains stranded in the pool.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDirect leverage for the attacker\u003c/strong\u003e\u003cbr\u003e\nAn exiting holder gives up only their own one‑cycle reward while slashing everyone else’s payout by the same absolute amount. They can repeat the manoeuvre each epoch—or threaten to—creating a zero‑cost grief / extortion vector.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCompromise of a core protocol function\u003c/strong\u003e\u003cbr\u003e\nFair, supply‑proportional bribe distribution is a primary feature of Cabal. Desynchronising balances and supply corrupts that mechanism, undermining trust in the staking programme.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIrreversible cycle corruption\u003c/strong\u003e\u003cbr\u003e\nOnce the snapshot for block H is polluted, the mis‑distribution for that cycle is permanent. users cannot reclaim the lost bribes without an invasive state migration.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"recommended-mitigation-steps-3\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-3\" aria-label=\"recommended mitigation steps 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eAdd Supply Update to \u003ccode\u003eburn\u003c/code\u003e:\u003c/strong\u003e Modify \u003ccode\u003ecabal_token::burn\u003c/code\u003e to check if it’s executing in the same block as a snapshot. If so, update the \u003ccode\u003esupply_snapshots\u003c/code\u003e table for that block height with the new, lower supply \u003cem\u003eafter\u003c/em\u003e the burn, mirroring the logic in \u003ccode\u003ecabal_token::mint_to\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFix \u003ccode\u003echeck_snapshot\u003c/code\u003e:\u003c/strong\u003e Ensure \u003ccode\u003echeck_snapshot\u003c/code\u003e \u003cem\u003ealways\u003c/em\u003e writes the user’s pre-interaction balance for the current snapshot block \u003ccode\u003eH\u003c/code\u003e when needed, removing the logic that skips this write during same-block interactions.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\" aria-label=\"m 04 unstaking from lp pools will cause underflow and lock user funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-155\"\u003e[M-04] Unstaking from LP pools will cause underflow and lock user funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-267\"\u003egivn\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-118\"\u003e0xAlix2\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-175\"\u003ebareli\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-280\"\u003eden-sosnowsky\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L386-L420\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"description\" style=\"position:relative;\"\u003e\u003ca href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDescription\u003c/h3\u003e\n\u003cp\u003eWhen users unstake their LP tokens they call \u003ccode\u003einitiate_unstake\u003c/code\u003e for the required amount. This creates \u003ccode\u003eUnbondingEntry\u003c/code\u003e and increases the pending unstake amount - \u003ccode\u003eunstaked_pending_amounts[unstaking_type] + unbonding_amount\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAt some point an admin (or user) will invoke \u003ccode\u003ebatch_undelegate_pending_lps()\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"8\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk15\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunbond_period\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// undelegate\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tpool_router::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eunlock\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estake_token_metadata\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e], \u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunstaked_pending_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// clear pending\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunstaked_pending_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e] = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003epool_router::unlock\u003c/code\u003e calculates what % of every pool should be undelegated so that the desired LP token amount is reached. This happens by calculating a fraction, iterating over the pools and subtracting an amount equal to that fraction. The issue is that when the \u003cstrong\u003elast pool element\u003c/strong\u003e is reached, the remaining amount is \u003cstrong\u003eall\u003c/strong\u003e removed from there:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"9\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis means that if the last pool is empty or with insufficient funds an underflow will occur here:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"10\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_pool\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eamount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etemp_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe protocol tries to always fund the pool with least staked tokens by using \u003ccode\u003eget_most_underutilized_pool\u003c/code\u003e, but this does not prevent situations of imbalance, like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe most underutilized pool receives a very big deposit and dwarfs the rest\u003c/li\u003e\n\u003cli\u003eNew pool is being freshly added \u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUsers in large numbers withdrawing their funds.\nThus, the subtraction can still underflow in situations that are likely to happen over time.\u003c/p\u003e\n\u003ch3 id=\"impact-1\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-1\" aria-label=\"impact 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003c/li\u003e\n\u003cli\u003eStaked LP tokens can’t be fully withdrawn from protocol.\u003c/li\u003e\n\u003cli\u003eThe amount of funds locked can vary greatly, depending on the stake/unstake \u0026#x26; operation patterns. \u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOnce undelegate amount has been requested it can’t be reduced to try to unlock a smaller amount and get the maximum funds possible. Delegations are locked until someone else deposits.\u003c/p\u003e\n\u003ch3 id=\"root-cause-1\" style=\"position:relative;\"\u003e\u003ca href=\"#root-cause-1\" aria-label=\"root cause 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRoot Cause\u003c/h3\u003e\n\u003cp\u003eTrying to withdraw too much from pool when funds are located in other pools.\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-3\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-3\" aria-label=\"proof of concept 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cp\u003eThe following code replicates the undelegate calculations of \u003ccode\u003epool_router::unlock\u003c/code\u003e and demonstrates that not all the funds can be withdrawn.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePlace this test in \u003ccode\u003epool_router.move\u003c/code\u003e. Run it with \u003ccode\u003eyarn run test- test_unlock_lp_amounts\u003c/code\u003e.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"11\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e#[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eexpected_failure\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e()]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003epublic\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003etest_unlock_lp_amounts\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e() {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = 2\u003c/span\u003e\u003cspan class=\"mtk12\"\u003e_000_000u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e; \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Unlock LP\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e[ \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// LP staked in each pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20_000_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk7\"\u003e10_000\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk4\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e20\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eloop\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Begin undelegation round\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk15\"\u003ebreak\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Pool amounts after last iteration\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] \u0026quot;New pool stake amounts\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 4500\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 4500\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// [debug] 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Now we continue undelegating smaller amounts, but action will underflow\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; ---- Undelegate smaller amount #1 ---- \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tdebug::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot; ---- Undelegate smaller amount #2 ---- \u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1_000\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/// Simplified version of pool_router::unlock_lp\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e#[\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etest_only\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk12\"\u003efun\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk11\"\u003ecalculate_undelegates\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026gt;, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e): \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e\u0026gt; {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003elength\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, 0\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, |\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e| \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// LP staked in across all pools\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Total staked before undelegate\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eassert\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e!(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_stakes\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u0026gt;= \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunlock_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1000777\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efor\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk4\"\u003ein\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0.\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e.\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eborrow_mut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003emut\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\tlet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e (\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ei\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e == \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools_length\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e) {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t} \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003ebigdecimal:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, *\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eremain_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Update state tracking\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t*\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = *\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_stake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e - \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eundelegate_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;New pool stake amounts\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003elet\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e \u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_staked_after_undelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk12\"\u003evector\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efold\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, 0\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, |\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e, \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e| {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug:\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e:\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eacc\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e + \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eelem\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t});\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003estring\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eutf8\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u003c/span\u003e\u003cspan class=\"mtk12\"\u003eb\u003c/span\u003e\u003cspan class=\"mtk8\"\u003e\u0026quot;Total staked after undelegate\u0026quot;\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003edebug\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprint\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk12\"\u003etotal_staked_after_undelegate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e\t\u003c/span\u003e\u003cspan class=\"mtk12\"\u003epools\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"recommended-mitigation-steps-4\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-4\" aria-label=\"recommended mitigation steps 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eInstead of doing one iteration over the pools and subtracting the remaining amount from the last one, use an loop and modulo arithmetic to iterate multiple times and subtract any possible remaining amounts from the other pools.\u003c/p\u003e\n\u003cp\u003eSeparate undelegate amount calculation from the \u003ccode\u003estargate\u003c/code\u003e calls so that multiple \u003ccode\u003eMsgUndelegate\u003c/code\u003e messages are not sent for the same validator.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-05-last-holder-cant-exit-zerosupply-unstake-reverts\" style=\"position:relative;\"\u003e\u003ca href=\"#m-05-last-holder-cant-exit-zerosupply-unstake-reverts\" aria-label=\"m 05 last holder cant exit zerosupply unstake reverts permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-157\"\u003e[M-05] Last Holder Can’t Exit, Zero‑Supply Unstake Reverts\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-178\"\u003emaxzuvex\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L996-L998\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L1051-L1053\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"finding-description-and-impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-and-impact-3\" aria-label=\"finding description and impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding description and impact\u003c/h3\u003e\n\u003cp\u003eWhen a user burns the \u003cstrong\u003eentire remaining supply\u003c/strong\u003e of a Cabal LST ( sxINIT or Cabal LPT) via \u003ccode\u003einitiate_unstake\u003c/code\u003e, the follow‑up processing step always aborts with a divide‑by‑zero and the user can never exit.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eUser calls \u003ccode\u003einitiate_unstake(stake_type, S)\u003c/code\u003e – S equals the whole supply.\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eunstake_xinit\u003c/code\u003e / \u003ccode\u003eunstake_lp\u003c/code\u003e queues \u003ccode\u003eprocess_*_unstake\u003c/code\u003e with \u003ccode\u003ecosmos::move_execute( … \"process_xinit_unstake\" | \"process_lp_unstake\" … )\u003c/code\u003e for next transaction.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAfter queuing\u003c/strong\u003e, \u003ccode\u003einitiate_unstake\u003c/code\u003e burns the LST: \u003ccode\u003ecabal_token::burn(S)\u003c/code\u003e ⇒ live supply becomes \u003cstrong\u003e0\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eTransaction 1 finishes and state now shows \u003ccode\u003esupply = 0\u003c/code\u003e, \u003ccode\u003epending[i] = S\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLater, Transaction 2 executes \u003ccode\u003eprocess_*_unstake\u003c/code\u003e.\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eCalls \u003ccode\u003ecompound_*_pool_rewards\u003c/code\u003e (does not change LST supply).\u003c/li\u003e\n\u003cli\u003eReads the current LST supply: \u003ccode\u003esx_supply = fungible_asset::supply(meta)\u003c/code\u003e ⇒ \u003cstrong\u003e0\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eCalculates \u003ccode\u003eratio = bigdecimal::from_ratio_u128(unstake_amount, sx_supply)\u003c/code\u003e which triggers \u003ccode\u003eassert!(denominator != 0)\u003c/code\u003e → \u003cstrong\u003e\u003ccode\u003eEDIVISION_BY_ZERO\u003c/code\u003e abort\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eBecause the burn happened in a prior committed transaction, every retry of \u003ccode\u003eprocess_*_unstake\u003c/code\u003e gets the same \u003ccode\u003esupply == 0\u003c/code\u003e state and fails again, so the user’s INIT / LP is permanently locked and it makes a DoS for the final staker of that pool.\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"12\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Simplified logic from process_xinit_unstake\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    entry fun \u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprocess_xinit_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(account: \u0026amp;signer, staker_addr: address, unstaking_type: u64, unstake_amount: u64) acquires ModuleStore, CabalStore, LockExempt {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... permission checks, reward compounding ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003em_store\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = borrow_global_mut\u0026lt;ModuleStore\u0026gt;(@staking_addr);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003ex_init_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = m_store.staked_amounts[unstaking_type];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// --- VULNERABILITY ---\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026#39;unstake_amount\u0026#39; is the original amount burned (== total supply in this case).\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// \u0026#39;sx_init_amount\u0026#39; reads the supply *after* the burn in initiate_unstake, so it\u0026#39;s 0.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esx_init_amount\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = option::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eextract\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;mut fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(m_store.cabal_stake_token_metadata[unstaking_type])); \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Returns 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// This attempts bigdecimal::from_ratio_u128(S, 0) --\u0026gt; Division by Zero!\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eratio\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount as u128, sx_init_amount);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// Transaction reverts here.\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e        \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// ... rest of function is unreachable ...\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eImpact:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIf an address burns the last sxINIT / LPT in circulation, every call to \u003ccode\u003eprocess_*_unstake\u003c/code\u003e reverts with \u003ccode\u003eEDIVISION_BY_ZERO\u003c/code\u003e, so no \u003ccode\u003eUnbondingEntry\u003c/code\u003e is recorded and the underlying INIT / LP can never be claimed. The final staker’s funds are permanently locked and causes a pool‑level denial of service.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-5\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-5\" aria-label=\"recommended mitigation steps 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003eprocess_xinit_unstake\u003c/code\u003e and \u003ccode\u003eprocess_lp_unstake\u003c/code\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"13\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003epool_before\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = m_store.staked_amounts[pool];\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e      = fungible_asset::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esupply\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(meta);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eunbond\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eif\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e supply == \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e0\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// last holder – give them the entire pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    pool_before\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e} \u003c/span\u003e\u003cspan class=\"mtk15\"\u003eelse\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e {\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    let \u003c/span\u003e\u003cspan class=\"mtk12\"\u003er\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003efrom_ratio_u128\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(unstake_amount, supply);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e    bigdecimal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emul_by_u64_truncate\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(r, pool_before)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eGuard against \u003ccode\u003esupply == 0\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eIf it’s the final unstake, transfer the whole remaining pool; otherwise keep the original ratio logic.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"proof-of-concept-4\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-4\" aria-label=\"proof of concept 4 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"go\" data-index=\"14\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// Assume pool index 1 is an LP‑staking pool\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet pool_idx: \u003c/span\u003e\u003cspan class=\"mtk12\"\u003eu64\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 1: mint exactly 1 Cabal‑LPT to Alice ───────────────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003elet \u003c/span\u003e\u003cspan class=\"mtk12\"\u003emint_cap\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e = \u0026amp;ModuleStore.cabal_stake_token_caps[pool_idx].mint_cap;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal_token::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003emint_to\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(mint_cap, @alice, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);          \u003c/span\u003e\u003cspan class=\"mtk3\"\u003e// total supply = 1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 2: Alice initiates unstake of the ENTIRE supply ────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003einitiate_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;\u003c/span\u003e\u003cspan class=\"mtk11\"\u003esigner\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(@alice), pool_idx, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/*\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * inside initiate_unstake:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   • cabal_token::burn(1)            → total supply becomes 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   • schedules process_lp_unstake()  (async)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e// ── step 3: worker executes queued call ──────────────────────────────────\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk1\"\u003ecabal::\u003c/span\u003e\u003cspan class=\"mtk11\"\u003eprocess_lp_unstake\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e(\u0026amp;assets_signer, @alice, pool_idx, \u003c/span\u003e\u003cspan class=\"mtk7\"\u003e1\u003c/span\u003e\u003cspan class=\"mtk1\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e/*\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * inside process_lp_unstake:\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   let sx_supply = fungible_asset::supply(lp_metadata);   // == 0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *   let ratio     = bigdecimal::from_ratio_u128(1, sx_supply);\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *                         └────── divide‑by‑zero → abort\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e *\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e * transaction reverts with EZeroDenominator\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003cspan class=\"mtk3\"\u003e */\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\" style=\"position:relative;\"\u003e\u003ca href=\"#m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\" aria-label=\"m 06 lp redelegation uses inaccurate internal tracker amount leading to potential failures or orphaned funds permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-185\"\u003e[M-06] LP Redelegation Uses Inaccurate Internal Tracker Amount, Leading to Potential Failures or Orphaned Funds\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-213\"\u003eedoscoba\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-1\" style=\"position:relative;\"\u003e\u003ca href=\"#summary-1\" aria-label=\"summary 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003eredelegate_lp\u003c/code\u003e function, called during validator changes for LP pools, uses the internal \u003ccode\u003epool.amount\u003c/code\u003e tracker to specify the amount for \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e. This tracker can diverge from the actual staked amount due to unreflected rewards or slashing, potentially causing redelegation failures or leaving funds staked with the old validator.\u003c/p\u003e\n\u003ch3 id=\"finding-description-1\" style=\"position:relative;\"\u003e\u003ca href=\"#finding-description-1\" aria-label=\"finding description 1 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eFinding Description\u003c/h3\u003e\n\u003cp\u003eThe \u003ccode\u003epool_router::change_validator\u003c/code\u003e function allows the deployer (\u003ccode\u003e@staking_addr\u003c/code\u003e) to migrate staked assets managed by a specific \u003ccode\u003eStakePool\u003c/code\u003e object from one validator to another. For LP token pools, it calls the internal helper function \u003ccode\u003eredelegate_lp\u003c/code\u003e located in \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003epool_router.move#L327-L339\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eredelegate_lp\u003c/code\u003e function constructs a \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e message to be sent via \u003ccode\u003ecosmos::stargate\u003c/code\u003e. The amount of tokens to be redelegated in this message is taken directly from the \u003ccode\u003epool.amount\u003c/code\u003e field of the \u003ccode\u003eStakePool\u003c/code\u003e resource:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"15\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    fun redelegate_lp(pool: \u0026amp;StakePool, new_validator_address: String) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let denom = coin::metadata_to_denom(pool.metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let coin = Coin { denom, amount: pool.amount }; // \u0026lt;\u0026lt;\u0026lt; Uses pool.amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let msg = MsgBeginRedelegate {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            // ... other fields ...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            amount: vector[coin] // \u0026lt;\u0026lt;\u0026lt; Amount specified in the message\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        cosmos::stargate(\u0026amp;object::generate_signer_for_extending(\u0026amp;pool.ref), marshal(\u0026amp;msg));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHowever, the \u003ccode\u003epool.amount\u003c/code\u003e is merely an internal counter updated by \u003ccode\u003epool_router::add_stake\u003c/code\u003e and \u003ccode\u003epool_router::unstake\u003c/code\u003e and \u003ccode\u003epool_router::unlock_lp\u003c/code\u003e. It does not automatically reflect changes in the actual staked balance within the underlying \u003ccode\u003emstaking\u003c/code\u003e module due to:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eAccrued Rewards:\u003c/strong\u003e Rewards earned by the staked LP tokens increase the actual delegation shares/amount but are not reflected in \u003ccode\u003epool.amount\u003c/code\u003e until \u003ccode\u003ecompound_lp_pool_rewards\u003c/code\u003e runs (triggered by user actions) and subsequently calls \u003ccode\u003eadd_stake\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSlashing\u003c/strong\u003e: If the validator is slashed, the actual delegation shares/amount decreases, but \u003ccode\u003epool.amount\u003c/code\u003e is never updated to reflect this loss.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eTherefore, \u003ccode\u003epool.amount\u003c/code\u003e can easily drift from the true staked amount. Sending a \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with this potentially inaccurate amount breaks the expectation that the administrative function correctly manages the entirety of the funds associated with the \u003ccode\u003eStakePool\u003c/code\u003e object.\u003c/p\u003e\n\u003ch3 id=\"impact-2\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-2\" aria-label=\"impact 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eUsing an inaccurate amount in \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e leads to two primary negative outcomes:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eRedelegation Failure\u003c/strong\u003e:If \u003ccode\u003epool.amount\u003c/code\u003e is greater than the actual staked amount (e.g., due to slashing), the underlying \u003ccode\u003emstaking\u003c/code\u003e module will reject the request, causing the \u003ccode\u003ecosmos::stargate\u003c/code\u003e  call and the entire \u003ccode\u003echange_validator\u003c/code\u003e transaction to abort. This prevents the deployer from migrating funds away from a potentially slashed or undesirable validator.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePartial Redelegation / Orphaned Funds:\u003c/strong\u003e If \u003ccode\u003epool.amount\u003c/code\u003e is less than the actual staked amount (e.g., due to accrued rewards not yet reflected), the \u003ccode\u003emstaking\u003c/code\u003e module will likely succeed in redelegating only the specified \u003ccode\u003epool.amount\u003c/code\u003e. The remaining tokens (the difference) will be left staked with the original validator. However, the \u003ccode\u003echange_validator\u003c/code\u003e function proceeds to update \u003ccode\u003epool.validator\u003c/code\u003e to the new address. This creates an inconsistent state where the \u003ccode\u003eStakePool\u003c/code\u003e object points to the new validator, but some funds remain with the old one, potentially becoming difficult to track, manage, or withdraw through the router’s standard logic.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"likelihood\" style=\"position:relative;\"\u003e\u003ca href=\"#likelihood\" aria-label=\"likelihood permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eLikelihood\u003c/h3\u003e\n\u003cp\u003eThe likelihood of \u003ccode\u003epool.amount\u003c/code\u003e becoming inaccurate is \u003cstrong\u003eHigh\u003c/strong\u003e. Staking rewards are expected to accrue over time. If users don’t frequently stake or unstake from a specific LP pool, the \u003ccode\u003ecompound_lp_pool_rewards\u003c/code\u003e function won’t run often, causing \u003ccode\u003epool.amount\u003c/code\u003e to lag behind the actual staked amount (actual \u003e tracker). Slashing events, while less frequent, would cause the tracker to exceed the actual amount. \u003c/p\u003e\n\u003cp\u003eTherefore, drift between \u003ccode\u003epool.amount\u003c/code\u003e and the real staked value is highly likely. The likelihood of this drift causing a problem during a \u003ccode\u003echange_validator\u003c/code\u003e call is \u003cstrong\u003eMedium\u003c/strong\u003e, as it depends on when the deployer chooses to execute this administrative action relative to the drift.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-6\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-6\" aria-label=\"recommended mitigation steps 6 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003eModify the \u003ccode\u003eredelegate_lp\u003c/code\u003e function to query the actual delegation amount from the underlying \u003ccode\u003emstaking\u003c/code\u003e module before constructing the \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e message. This can be done using a \u003ccode\u003equery_stargate\u003c/code\u003e call similar to the one used in \u003ccode\u003eget_lp_real_stakes\u003c/code\u003e. Use this queried, accurate amount instead of \u003ccode\u003epool.amount\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eApply the following conceptual change (exact query path and response parsing might need adjustment based on Initia’s \u003ccode\u003emstaking\u003c/code\u003e module specifics) to \u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/pool_router.move#L327-L339\"\u003epool_router.move#L327-L339\u003c/a\u003e:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"16\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e     fun redelegate_lp(pool: \u0026amp;StakePool, new_validator_address: String) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e         let denom = coin::metadata_to_denom(pool.metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e-        let coin = Coin { denom, amount: pool.amount };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let pool_addr = object::address_from_extend_ref(\u0026amp;pool.ref);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e \u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Query the actual staked amount instead of relying on the internal tracker\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let path = b\u0026quot;/initia.mstaking.v1.Query/Delegation\u0026quot;; // Adjust path if needed\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let request = DelegationRequest { validator_addr: pool.validator, delegator_addr: address::to_sdk(pool_addr) };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let response_bytes = query_stargate(path, marshal(\u0026amp;request));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Note: Need robust parsing and error handling for the query response here.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        // Assuming successful query and parsing to get the actual_staked_amount:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let actual_staked_amount = parse_delegation_response_amount(response_bytes, denom); // Placeholder for parsing logic\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        assert!(actual_staked_amount \u0026gt; 0, error::invalid_state(0)); // Add appropriate error code\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e+        let coin = Coin { denom, amount: actual_staked_amount }; // Use the queried amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e         let msg = MsgBeginRedelegate {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e             _type_: string::utf8(b\u0026quot;/initia.mstaking.v1.MsgBeginRedelegate\u0026quot;),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e             delegator_address: to_sdk(object::address_from_extend_ref(\u0026amp;pool.ref)),\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e(Note: The \u003ccode\u003eparse_delegation_response_amount\u003c/code\u003e function is illustrative; the actual implementation would involve using \u003ccode\u003eunmarshal\u003c/code\u003e and navigating the \u003ccode\u003eDelegationResponse\u003c/code\u003e struct as done in \u003ccode\u003eget_lp_real_stakes\u003c/code\u003e to extract the correct amount for the given denom.)\u003c/p\u003e\n\u003ch3 id=\"proof-of-concept-5\" style=\"position:relative;\"\u003e\u003ca href=\"#proof-of-concept-5\" aria-label=\"proof of concept 5 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eProof of Concept\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eSetup:\u003c/strong\u003e Configure an LP pool using \u003ccode\u003eadd_pool\u003c/code\u003e. Stake some LP tokens via \u003ccode\u003ecabal::stake_asset\u003c/code\u003e (which calls \u003ccode\u003epool_router::add_stake\u003c/code\u003e), setting \u003ccode\u003epool.amount\u003c/code\u003e to, say, 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eScenario 1 (Rewards Accrued):\u003c/strong\u003e Assume rewards accrue in the underlying \u003ccode\u003emstaking\u003c/code\u003e module, increasing the actual staked amount to 1,050,000, but no user actions trigger compounding, so \u003ccode\u003epool.amount\u003c/code\u003e remains 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAction:\u003c/strong\u003e The deployer calls \u003ccode\u003echange_validator\u003c/code\u003e for this pool. \u003ccode\u003eredelegate_lp\u003c/code\u003e is called.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExecution:\u003c/strong\u003e \u003ccode\u003eredelegate_lp\u003c/code\u003e constructs \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with \u003ccode\u003eamount = 1,000,000\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOutcome:\u003c/strong\u003e The \u003ccode\u003emstaking\u003c/code\u003e module successfully redelegates 1,000,000 tokens. 50,000 tokens remain staked with the old validator. \u003ccode\u003echange_validator\u003c/code\u003e updates \u003ccode\u003epool.validator\u003c/code\u003e to the new address. The 50,000 tokens are now potentially orphaned from the router’s perspective.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eScenario 2 (Slashing Occurred):\u003c/strong\u003e Assume the validator was slashed, reducing the actual staked amount to 950,000, but \u003ccode\u003epool.amount\u003c/code\u003e remains 1,000,000.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAction:\u003c/strong\u003e The deployer calls \u003ccode\u003echange_validator\u003c/code\u003e. \u003ccode\u003eredelegate_lp\u003c/code\u003e is called.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExecution:\u003c/strong\u003e \u003ccode\u003ereredelegate_lp\u003c/code\u003e constructs \u003ccode\u003eMsgBeginRedelegate\u003c/code\u003e with \u003ccode\u003eamount = 1,000,000\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOutcome:\u003c/strong\u003e The \u003ccode\u003emstaking\u003c/code\u003e module rejects the request because only 950,000 tokens are available. The \u003ccode\u003ecosmos::stargate\u003c/code\u003e call fails, causing the \u003ccode\u003echange_validator\u003c/code\u003e transaction to abort. The validator cannot be changed.\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003ch2 id=\"m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\" style=\"position:relative;\"\u003e\u003ca href=\"#m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\" aria-label=\"m 07 desynchronization of cabals internal accounting with actual staked init amounts leads to over minting of sxinit tokens permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003e\u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/F-252\"\u003e[M-07] Desynchronization of Cabal’s internal accounting with actual staked INIT amounts leads to over-minting of sxINIT tokens\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eSubmitted by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-108\"\u003eChainSentry\u003c/a\u003e, also found by \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-235\"\u003eAfriauditor\u003c/a\u003e, \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-262\"\u003egivn\u003c/a\u003e, and \u003ca href=\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions/S-18\"\u003emaze\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796\"\u003ehttps://github.com/code-423n4/2025-04-cabal/blob/5b5f92ab4f95e5f9f405bbfa252860472d164705/sources/cabal.move#L796\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-2\" style=\"position:relative;\"\u003e\u003ca href=\"#summary-2\" aria-label=\"summary 2 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eSummary\u003c/h3\u003e\n\u003cp\u003eThe Cabal Protocol’s implementation of \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e fails to synchronize the protocol’s internal accounting (\u003ccode\u003em_store.staked_amounts\u003c/code\u003e) with the actual amount of INIT tokens staked in the underlying Initia staking system. This creates a vulnerability where external events like slashing penalties or validator-initiated actions that reduce the staked amount are not reflected in Cabal’s internal state. The reward compounding function simply adds claimed rewards to its internal tracking variable without verifying that this matches reality, creating a divergence between what Cabal thinks is staked and what actually is staked. When slashing occurs, users who stake xINIT will receive more sxINIT than they should based on the actual backing ratio. This leads to economic dilution of all sxINIT holders.\u003c/p\u003e\n\u003cp\u003eThis issue is particularly concerning because it compounds over time - each slashing event that goes unaccounted for widens the gap between reported and actual values, eventually leading to significant economic damage for the protocol and its users.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eTechnical Explanation\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eThe core issue lies in the \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e function in \u003ccode\u003ecabal.move\u003c/code\u003e, which is responsible for claiming staking rewards and updating the protocol’s internal state:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"17\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003efun compound_xinit_pool_rewards(m_store: \u0026amp;mut ModuleStore, pool_index: u64) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let coin_metadata = coin::metadata(@initia_std, string::utf8(b\u0026quot;uinit\u0026quot;));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let reward_fa = pool_router::withdraw_rewards(coin_metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let reward_amount = fungible_asset::amount(\u0026amp;reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    if (reward_amount \u0026gt; 0) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // calculate fee amount\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_ratio = bigdecimal::from_ratio_u64(m_store.xinit_stake_reward_fee_bps, BPS_BASE);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_amount = bigdecimal::mul_by_u64_truncate(fee_ratio, reward_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let fee_fa = fungible_asset::extract(\u0026amp;mut reward_fa, fee_amount);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let rewards_remaining = reward_amount - fee_amount;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        primary_fungible_store::deposit(package::get_commission_fee_store_address(), fee_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        m_store.stake_reward_amounts[pool_index] = m_store.stake_reward_amounts[pool_index] + rewards_remaining;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        pool_router::add_stake(reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        // mint xINIT to pool\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        m_store.staked_amounts[pool_index] = m_store.staked_amounts[pool_index] + rewards_remaining;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        coin::mint_to(\u0026amp;m_store.x_init_caps.mint_cap, package::get_assets_store_address(), rewards_remaining);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        fungible_asset::destroy_zero(reward_fa);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe issue occurs because this function:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eClaims rewards from the staking system via \u003ccode\u003epool_router::withdraw_rewards\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eProcesses these rewards and restakes them via \u003ccode\u003epool_router::add_stake\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eUpdates \u003ccode\u003em_store.staked_amounts[pool_index]\u003c/code\u003e by simply adding the rewards amount\u003c/li\u003e\n\u003cli\u003eNever verifies that this updated value matches the actual staked amount in the underlying system\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eHowever, the protocol has a function \u003ccode\u003epool_router::get_real_total_stakes\u003c/code\u003e that does query the actual staked amount from the Initia staking system:\u003c/p\u003e\n\u003cpre class=\"grvsc-container dark-default-dark\" data-language=\"move\" data-index=\"18\"\u003e\u003ccode class=\"grvsc-code\"\u003e\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e// From pool_router.move\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003epub fun get_real_total_stakes(metadata: Object\u0026lt;Metadata\u0026gt;): u64 {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    // Sum up all stake amounts from the underlying staking system\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let total_stakes: u64 = 0;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    /* ... */\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    let pools = *simple_map::borrow(\u0026amp;router.token_pool_map, \u0026amp;metadata);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    for (i in 0..vector::length(\u0026amp;pools)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        let amount = if (metadata == utils::get_init_metadata()) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            get_init_real_stakes(\u0026amp;pools[i])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        } else {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e            get_lp_real_stakes(\u0026amp;pools[i])\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e        total_stakes = total_stakes + amount;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e    total_stakes\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"grvsc-line\"\u003e\u003cspan class=\"grvsc-source\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis function is never called during reward compounding, leading to the desynchronization.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eThe following scenario demonstrates how this vulnerability can lead to over-minting of sxINIT tokens:\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eInitial state:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e1,000,000,000 INIT staked in the Initia staking system\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e = 1,000,000,000\u003c/li\u003e\n\u003cli\u003eTotal sxINIT supply = 1,000,000,000\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eA slashing event occurs in the Initia staking system, reducing the staked INIT by 5%:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eActual staked INIT = 950,000,000\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e still = 1,000,000,000 (unchanged)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRewards of 50,000,000 INIT are claimed via \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFunction adds 50,000,000 to \u003ccode\u003em_store.staked_amounts[0]\u003c/code\u003e, making it 1,050,000,000\u003c/li\u003e\n\u003cli\u003eActual staked INIT after adding rewards = 1,000,000,000 (950,000,000 + 50,000,000)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUser comes to stake 100,000,000 xINIT:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAccording to Cabal’s accounting: Exchange rate = 1,050,000,000 INIT / 1,000,000,000 sxINIT = 1.05\u003c/li\u003e\n\u003cli\u003eUser should receive: 100,000,000 / 1.05 = 95,238,095 sxINIT\u003c/li\u003e\n\u003cli\u003eBut the actual exchange rate should be: 1,000,000,000 INIT / 1,000,000,000 sxINIT = 1.0\u003c/li\u003e\n\u003cli\u003eUser should actually receive: 100,000,000 / 1.0 = 100,000,000 sxINIT\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe discrepancy:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eUser receives 95,238,095 sxINIT\u003c/li\u003e\n\u003cli\u003eThese tokens are backed by only 90,702,948 INIT (95,238,095 * 1,000,000,000 / 1,050,000,000)\u003c/li\u003e\n\u003cli\u003eThis means the user has been short-changed by 4,761,905 INIT worth of backing\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe issue becomes even more severe with multiple slashing events and/or larger stake amounts.\u003c/p\u003e\n\u003ch3 id=\"impact-3\" style=\"position:relative;\"\u003e\u003ca href=\"#impact-3\" aria-label=\"impact 3 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eImpact\u003c/h3\u003e\n\u003cp\u003eThe impact of this vulnerability is significant and affects multiple areas:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eViolation of Core Protocol Invariants\u003c/strong\u003e: The fundamental invariant \u003ccode\u003e1 xINIT ≈ 1 INIT\u003c/code\u003e is broken. This undermines the entire economic model of the protocol as described in the documentation.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eEconomic Dilution\u003c/strong\u003e: When new users stake xINIT and receive sxINIT based on incorrect exchange rates, they get fewer tokens than they should. This effectively transfers value from new users to existing sxINIT holders.\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eSystemic Risk\u003c/strong\u003e: Each uncorrected slashing event compounds the problem. Over time, the divergence between tracked and actual amounts could become severe, potentially leading to:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLoss of user confidence in the protocol\u003c/li\u003e\n\u003cli\u003eInability to properly value sxINIT tokens\u003c/li\u003e\n\u003cli\u003eDifficulty in integrating with other DeFi protocols due to unreliable pricing\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUnbonding Issues\u003c/strong\u003e: When users try to unstake their sxINIT tokens, they might not receive the expected amount of xINIT back, leading to unexpected losses.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis issue affects all users of the Cabal Protocol, with the severity increasing over time as more slashing events occur without correction.\u003c/p\u003e\n\u003ch3 id=\"recommended-mitigation-steps-7\" style=\"position:relative;\"\u003e\u003ca href=\"#recommended-mitigation-steps-7\" aria-label=\"recommended mitigation steps 7 permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eRecommended mitigation steps\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eSync with Reality\u003c/strong\u003e: Modify the \u003ccode\u003ecompound_xinit_pool_rewards\u003c/code\u003e function to query the actual staked amounts after claiming rewards.\u003c/p\u003e\n\u003chr\u003e\n\u003ch1 id=\"disclosures\" style=\"position:relative;\"\u003e\u003ca href=\"#disclosures\" aria-label=\"disclosures permalink\" class=\"anchor before\"\u003e\u003csvg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"\u003e\u003cpath fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\u003e\u003c/path\u003e\u003c/svg\u003e\u003c/a\u003eDisclosures\u003c/h1\u003e\n\u003cp\u003eC4 is an open organization governed by participants in the community.\u003c/p\u003e\n\u003cp\u003eC4 audits incentivize the discovery of exploits, vulnerabilities, and bugs in smart contracts. Security researchers are rewarded at an increasing rate for finding higher-risk issues. Audit submissions are judged by a knowledgeable security researcher and disclosed to sponsoring developers. C4 does not conduct formal verification regarding the provided code but instead provides final verification.\u003c/p\u003e\n\u003cp\u003eC4 does not provide any guarantee or warranty regarding the security of this project. All smart contract software should be used at the sole risk and responsibility of users.\u003c/p\u003e\n\u003cstyle class=\"grvsc-styles\"\u003e\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line \u003e * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting \u003e .grvsc-code \u003e .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n\u003c/style\u003e"])</script><script>self.__next_f.push([1,"1a:T99f,"])</script><script>self.__next_f.push([1,"\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#overview\"\u003eOverview\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#about-c4\"\u003eAbout C4\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#scope\"\u003eScope\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#severity-criteria\"\u003eSeverity Criteria\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#high-risk-findings-1\"\u003eHigh Risk Findings (1)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#h-01-lp-unstaking-only-burns-the-shares-but-leaves-the-underlying-tokens-in-the-system-which-distorts-the-shares-to-tokens-ratio-and-leads-to-incorrect-amounts-being-calculated-during-staking-and-unstaking\"\u003e[H-01] LP unstaking only burns the shares but leaves the underlying tokens in the system, which distorts the shares-to-tokens ratio and leads to incorrect amounts being calculated during staking and unstaking\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"#medium-risk-findings-7\"\u003eMedium Risk Findings (7)\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#m-01-reentrancy-check-in-lock_stakingreentry_check-causes-concurrent-init-deposit-failures-dos\"\u003e[M-01] Reentrancy Check in \u003ccode\u003elock_staking::reentry_check\u003c/code\u003e Causes Concurrent INIT Deposit Failures (DOS)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-02-unstaking-calculates-user-share-at-request-time-ignoring-slashing--leading-to-dos-and-unfair-distribution\"\u003e[M-02] Unstaking calculates user share at request time, ignoring slashing — leading to DoS and unfair distribution\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-03-attacker-can-desynchronize-supply-snapshot-during-same-block-unstake-reducing-everyones-rewards\"\u003e[M-03] Attacker Can Desynchronize Supply Snapshot During Same-Block Unstake, Reducing Everyone’s Rewards\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-04-unstaking-from-lp-pools-will-cause-underflow-and-lock-user-funds\"\u003e[M-04] Unstaking from LP pools will cause underflow and lock user funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-05-last-holder-cant-exit-zerosupply-unstake-reverts\"\u003e[M-05] Last Holder Can’t Exit, Zero‑Supply Unstake Reverts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-06-lp-redelegation-uses-inaccurate-internal-tracker-amount-leading-to-potential-failures-or-orphaned-funds\"\u003e[M-06] LP Redelegation Uses Inaccurate Internal Tracker Amount, Leading to Potential Failures or Orphaned Funds\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#m-07-desynchronization-of-cabals-internal-accounting-with-actual-staked-init-amounts-leads-to-over-minting-of-sxinit-tokens\"\u003e[M-07] Desynchronization of Cabal’s internal accounting with actual staked INIT amounts leads to over-minting of sxINIT tokens\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#disclosures\"\u003eDisclosures\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"1b:{\"name\":\"Cabal\",\"link\":\"https://x.com/CabalVIP\",\"imageUrl\":\"https://code4-api-v0-public-storage.s3.us-east-1.amazonaws.com/upload-NnwpwCS5Huo\"}\n1c:{\"start_time\":\"2025-04-28T20:00:00.000Z\",\"end_time\":\"2025-05-05T20:00:00.000Z\",\"bot_race_time_limit\":1}\n18:{\"uid\":\"XWvQNfYN3iZ\",\"slug\":\"2025-04-cabal-liquid-staking-token\",\"title\":\"Cabal Liquid Staking Token\",\"sponsor\":\"Cabal\",\"date\":\"2025-05-28\",\"findings\":\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions\",\"contest\":504,\"alt_url\":null,\"html\":\"$19\",\"toc\":\"$1a\",\"created_at\":\"2025-05-28T15:37:54.102Z\",\"updated_at\":\"2025-05-28T15:37:54.102Z\",\"sponsor_data\":\"$1b\",\"contest_data\":\"$1c\"}\n8:[\"$\",\"$L13\",null,{\"landingPage\":[\"$\",\"$L14\",null,{\"report\":{\"uid\":\"XWvQNfYN3iZ\",\"slug\":\"2025-04-cabal-liquid-staking-token\",\"title\":\"Cabal Liquid Staking Token\",\"sponsor\":\"Cabal\",\"date\":\"2025-05-28\",\"findings\":\"https://code4rena.com/audits/2025-04-cabal-liquid-staking-token/submissions\",\"contest\":504,\"alt_url\":null,\"html\":\"$15\",\"toc\":\"$16\",\"created_at\":\"2025-05-28T15:37:54.102Z\",\"updated_at\":\"2025-05-28T15:37:54.102Z\",\"sponsor_data\":{\"name\":\"Cabal\",\"link\":\"https://x.com/CabalVIP\",\"imageUrl\":\"https://code4-api-v0-public-storage.s3.us-east-1.amazonaws.com/upload-NnwpwCS5Huo\"},\"contest_data\":{\"start_time\":\"2025-04-28T20:00:00.000Z\",\"end_time\":\"2025-05-05T20:00:00.000Z\",\"bot_race_time_limit\":1}}}],\"coreAppPage\":[\"$\",\"$L17\",null,{\"report\":\"$18\"}]}]\ne:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Code4rena | Keeping high severity bugs out of production\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Top auditors compete to keep high severity bugs out of production. Start a public or private audit within 48 hours.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"application-name\",\"content\":\"Code4rena | Keeping high severity bugs out of production\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"Code4rena is "])</script><script>self.__next_f.push([1,"a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:site_name\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:image\",\"content\":\"https://code4rena.com/images/c4/c4-og-v2.png\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:title\",\"content\":\"Code4rena\"}],[\"$\",\"meta\",\"12\",{\"name\":\"twitter:description\",\"content\":\"Code4rena is a competitive audit platform that finds more high-severity vulnerabilities, more quickly than any other auditing method.\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:image\",\"content\":\"https://code4rena.com/images/c4/c4-og-v2.png\"}],[\"$\",\"link\",\"14\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"256x256\"}],[\"$\",\"link\",\"15\",{\"rel\":\"icon\",\"href\":\"/logos/c4/c4-favicon-32.png\"}],[\"$\",\"link\",\"16\",{\"rel\":\"apple-touch-icon\",\"href\":\"/logos/c4/apple-touch-icon.png\"}],[\"$\",\"meta\",\"17\",{\"name\":\"next-size-adjust\"}]]\n7:null\n"])</script><next-route-announcer style="position: absolute;"><template shadowrootmode="open"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></template></next-route-announcer><wcm-modal><template shadowrootmode="open"><!----><wcm-explorer-context><template shadowrootmode="open"><!----></template></wcm-explorer-context><wcm-theme-context><template shadowrootmode="open"><!----></template></wcm-theme-context><div id="wcm-modal" role="alertdialog" aria-modal="true" class=" wcm-overlay "><div class="wcm-container" tabindex="0"><!--?lit$708315594$--></div></div></template></wcm-modal></body></html>